<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电影分镜管理系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* ... (Keep styles same as before) ... */
        body { margin: 0; background-color: #f0f2f5; font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif; }
        .el-header { background-color: #304156; color: #fff; line-height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .app-title { font-size: 20px; font-weight: bold; }
        .main-container { width: 100%; max-width: none; margin: 0 auto; padding: 20px; }
        .project-card { margin-bottom: 20px; }
        .shot-card { min-height: 600px; }
        .image-preview-list { display: flex; gap: 10px; flex-wrap: wrap; }
        .image-item { width: 100px; height: 100px; border-radius: 4px; object-fit: cover; cursor: pointer; border: 1px solid #eee; }
        .shot-desc { color: #666; font-size: 13px; margin-top: 5px; line-height: 1.4; }
        .media-generated-box { text-align: center; border: 2px dashed #dcdfe6; padding: 20px; border-radius: 4px; margin-top: 10px; position: relative; }
        .video-preview { width: 100%; max-height: 200px; background: #000; }
        .el-tag { margin-right: 5px; }
        .dialog-footer { text-align: right; }
        .script-list-container { min-height: 200px; }
        .script-section-block { background: #fff; border-left: 4px solid #409EFF; padding: 15px; margin-bottom: 15px; border-radius: 0 4px 4px 0; box-shadow: 0 1px 4px rgba(0,0,0,0.05); position: relative; display: flex; gap: 10px; cursor: move; }
        .script-section-block:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .script-checkbox { margin-top: 5px; }
        .script-content-wrapper { flex: 1; }
        .script-toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; opacity: 0.6; transition: opacity 0.3s; }
        .script-section-block:hover .script-toolbar { opacity: 1; }
        .script-index { position: absolute; left: -25px; top: 0; color: #ccc; font-weight: bold; font-size: 12px; }
        .global-loading-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .loading-dialog-box { background: #fff; width: 360px; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: center; }
        .loading-spinner { font-size: 40px; color: #409EFF; margin-bottom: 20px; }
        .loading-text { font-size: 16px; color: #303133; margin-bottom: 10px; font-weight: bold; }
        .loading-subtext { font-size: 13px; color: #909399; margin-bottom: 30px; }
        .loading-actions { display: flex; justify-content: center; gap: 15px; }
        .settings-container { display: flex; height: 500px; border: 1px solid #eee; }
        .settings-sidebar { width: 220px; border-right: 1px solid #eee; background: #fafafa; padding: 10px; display: flex; flex-direction: column; }
        .settings-content { flex: 1; padding: 20px; overflow-y: auto; }
        .provider-item { padding: 10px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .provider-item:hover { background: #e6f7ff; }
        .provider-item.active { background: #e6f7ff; color: #1890ff; font-weight: bold; }
        .provider-item-icon { width: 20px; height: 20px; background: #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #fff; margin-right: 8px; }
        .model-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .frames-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .frame-box { background: #f9fafc; padding: 10px; border-radius: 4px; border: 1px solid #eee; }
        .frame-title { font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .frame-placeholder { width: 100%; height: 100px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px dashed #ccc; border-radius: 4px; color: #ccc; cursor: pointer; font-size: 12px; position: relative; }
        .frame-img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; cursor: pointer; display: block; }
        .frame-delete { position: absolute; top: 2px; right: 2px; color: red; cursor: pointer; background: rgba(255,255,255,0.8); border-radius: 50%; padding: 2px; }
        .video-play-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); color: #fff; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; z-index: 5; }
        .video-play-overlay:hover { background: rgba(0,0,0,0.8); transform: translate(-50%, -50%) scale(1.1); transition: all 0.2s; }
        .sortable-ghost { opacity: 0.5; background: #f0f9eb; }
        .config-row { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .config-label { width: 60px; font-size: 13px; color: #606266; font-weight: bold; }
        .config-selects { flex: 1; display: flex; gap: 10px; }
        .header-actions { float: right; display: flex; align-items: center; height: 100%; gap: 15px; }
        .character-views {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .character-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .view-item {
            display: flex;
            flex-direction: column;
        }

        .view-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        .view-image {
            position: relative;
            height: 400px; /* 增加高度以适应四视图布局 */
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #eee;
            background-color: #f9f9f9; /* 设置背景颜色 */
        }

        .view-image .el-image {
            width: 100%;
            height: 100%;
        }

        .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .view-image:hover .image-actions {
            opacity: 1;
        }

        .image-actions .el-button {
            color: #fff;
            padding: 0;
        }

        .view-placeholder {
            height: 400px;
            border: 1px dashed #dcdfe6;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #909399;
            background-color: #fafafa;
            transition: all 0.3s;
            padding: 20px;
        }

        .view-placeholder:hover {
            border-color: #409EFF;
            color: #409EFF;
            background-color: #f0f9ff;
        }

        .placeholder-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .placeholder-content i {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .placeholder-content div {
            font-size: 16px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .action-buttons .el-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 10px 15px;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        /* 历史版本弹窗样式 */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }
        .history-item {
            border: 1px solid #eee;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            background: #fff;
            transition: all 0.3s;
        }
        .history-item:hover {
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .history-item.current-version {
            border: 2px solid #67C23A;
            background: #f0f9eb;
        }
        .history-tag {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 2;
        }
        .history-preview-box {
            width: 100%;
            height: 150px;
            background: #f5f7fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .history-actions {
            padding: 10px;
            text-align: center;
            border-top: 1px solid #eee;
        }
        /* ================== 新增：任务中心样式 ================== */
        .task-floater {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 2000;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 50%;
            transition: all 0.3s;
        }
        .task-floater:hover { transform: scale(1.1); }

        .task-list { padding: 20px; overflow-y: auto; height: calc(100vh - 80px); background-color: #f5f7fa; }
        
        .task-item {
            background: #fff; 
            border: 1px solid #EBEEF5; 
            border-radius: 6px;
            padding: 15px; 
            margin-bottom: 12px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            transition: all 0.3s;
        }
        .task-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .task-desc { font-weight: bold; font-size: 14px; color: #303133; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 240px; }
        
        .task-meta { display: flex; justify-content: space-between; font-size: 12px; color: #909399; margin-bottom: 8px; }
        
        .task-error { color: #F56C6C; font-size: 12px; margin-top: 8px; word-break: break-all; background: #fef0f0; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="app">
        <el-dialog title="项目资源历史回溯" :visible.sync="globalHistoryVisible" width="80%" top="5vh">
            <div style="margin-bottom: 15px; display: flex; gap: 15px;">
                <el-radio-group v-model="historyFilterType" size="small">
                    <el-radio-button label="all">全部</el-radio-button>
                    <el-radio-button label="character">角色</el-radio-button>
                    <el-radio-button label="shot">场景/分镜</el-radio-button>
                    <el-radio-button label="fusion">融图/视频</el-radio-button>
                </el-radio-group>
                <el-input v-model="historySearch" placeholder="搜索名称..." size="small" style="width: 200px;" prefix-icon="el-icon-search"></el-input>
            </div>

            <el-table :data="filteredHistoryList" height="600" border stripe v-loading="loadingHistory" row-key="id">
                <el-table-column label="预览" width="400">
                    <template slot-scope="scope">
                        <el-image 
                            v-if="scope.row.media_type === 'image'" 
                            :src="scope.row.url" 
                            :preview-src-list="[scope.row.url]"
                            fit="cover" 
                            lazy
                            style="width: 100%; height: 150px; border-radius: 4px; cursor: pointer;">
                        </el-image>

                        <video v-else-if="scope.row.media_type === 'video'" 
                            :src="scope.row.url" 
                            controls 
                            style="width: 100%; height: 150px; object-fit: cover;"></video>

                        <div v-else style="color: #999; font-size: 12px; text-align: center;">
                            不支持预览
                        </div>
                    </template>
                </el-table-column>
                
                <el-table-column prop="entity_name" label="所属对象" min-width="200" sortable></el-table-column>
                <el-table-column label="类型" width="100" prop="entity_type">
                    <template slot-scope="scope">
                        <el-tag size="mini" v-if="scope.row.entity_type==='character'">角色</el-tag>
                        <el-tag size="mini" type="success" v-else-if="scope.row.entity_type==='shot'">场景</el-tag>
                        <el-tag size="mini" type="warning" v-else-if="scope.row.entity_type==='fusion'">融图</el-tag>
                        <el-tag size="mini" type="info" v-else>其他</el-tag>
                    </template>
                </el-table-column>
                <el-table-column prop="version" label="版本" width="80" sortable>
                    <template slot-scope="scope">v{{ scope.row.version }}</template>
                </el-table-column>
                <el-table-column prop="date_str" label="生成时间" width="160" sortable></el-table-column>
                <el-table-column label="操作" fixed="right" min-width="120">
                    <template slot-scope="scope">
                        <el-button type="primary" size="mini" plain icon="el-icon-refresh-left" 
                            @click="restoreHistoryItem(scope.row)">恢复/使用</el-button>
                        <a :href="scope.row.url" :download="scope.row.filename" style="margin-left: 10px;">
                            <el-button type="text" size="mini" icon="el-icon-download"></el-button>
                        </a>
                    </template>
                </el-table-column>
            </el-table>
        </el-dialog>
        <!-- Global Loading Mask -->
        <div v-if="globalLoading" class="global-loading-mask">
            <div class="loading-dialog-box">
                <div class="loading-spinner"><i class="el-icon-loading"></i></div>
                <div class="loading-text">{{ loadingTitle }}</div>
                <div class="loading-subtext">{{ loadingSubText }}</div>
                <div class="loading-actions">
                    <el-button type="danger" plain round size="medium" icon="el-icon-close" @click="cancelGeneration">放弃生成</el-button>
                    <el-button type="primary" round size="medium" icon="el-icon-loading" disabled>请耐心等待</el-button>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <el-container>
            <el-header>
                <div class="app-title">
                    <a href="/series.html" style="color: #fff; text-decoration: none; font-size: 14px; margin-right: 15px; border: 1px solid #fff; padding: 5px 10px; border-radius: 4px;">
                        <i class="el-icon-back"></i> 返回剧集列表
                    </a>
                    <i class="el-icon-film"></i> 电影分镜管理系统</div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <el-select v-model="currentProjectId" placeholder="选择项目" @change="handleProjectChange" size="small" style="width: 200px;">
                        <el-option v-for="item in projectList" :key="item.id" :label="item.film_name" :value="item.id"></el-option>
                    </el-select>
                    <el-button type="primary" size="small" icon="el-icon-plus" @click="openCreateProject">新建项目</el-button>
                    <el-button type="info" size="small" icon="el-icon-s-operation" @click="openSettings">模型管理</el-button>
                </div>
            </el-header>

            <el-main class="main-container">
                <!-- Project Info -->
                <el-card class="project-card" v-if="currentProject">
                    <div slot="header" class="clearfix" style="line-height: 32px;">
                        <span style="font-weight: bold; font-size: 18px;">{{ currentProject.film_name }}</span>
                        <br>
                        <div style="vertical-align: middle; margin-top: 5px;">
                            <span class="core-conflict-label" style="background-color: #f0f9eb; color: #67c23a; padding: 4px 10px; border-radius: 4px; font-size: 12px; display: inline-block; white-space: normal; word-break: break-all; line-height: 1.5;">
                                核心冲突: {{ currentProject.script_core_conflict || '无' }}
                            </span>
                        </div>
                        <br>
                        <div class="header-actions">
                            <el-button type="text" icon="el-icon-film" style="color: #E6A23C;" @click="exportJianyingDraft">导出剪映草稿</el-button>
                            <el-button type="text" icon="el-icon-edit" @click="openEditProject">编辑详情</el-button>
                            <el-button type="text" icon="el-icon-delete" style="color: #f56c6c;" @click="deleteProject">删除项目</el-button>
                            <el-button type="text" icon="el-icon-time" @click="openGlobalHistory">历史回溯</el-button>
                            <el-button type="text" icon="el-icon-view" style="color: #67C23A;" @click="openVisualAnalysis">风格分析</el-button>
                        </div>
                    </div>
                    <el-descriptions :column="4" border size="small">
                        <el-descriptions-item label="基础信息" :span="4">{{ currentProject.basic_info }}</el-descriptions-item>
                        <el-descriptions-item label="情感关键词">{{ currentProject.script_emotional_keywords }}</el-descriptions-item>
                        <el-descriptions-item label="色彩体系">{{ currentProject.visual_color_system }}</el-descriptions-item>
                        <el-descriptions-item label="人物设定" :span="4">
                             <span v-if="currentProject.visual_consistency_prompt">{{ currentProject.visual_consistency_prompt }}</span>
                             <span v-else style="color:#ccc;font-style:italic;">未设置 (在编辑中添加以保证角色一致性)</span>
                        </el-descriptions-item>
                    </el-descriptions>
                </el-card>

                <div v-if="currentProject" style="background: #fff; border-radius: 4px; padding: 20px; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);">
                    <el-tabs v-model="activeTab" @tab-click="handleTabClick">

                        <el-tab-pane label="角色设定" name="characters">
                            <!-- 角色生成配置 -->
                            <div style="margin-bottom: 15px; background: #f5f7fa; padding: 10px; border-radius: 4px;">
                                <div style="display:flex; align-items:center; gap: 15px;">
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">图片生成模型:</span>
                                    <el-select v-model="genOptions.imageProviderId" size="mini" placeholder="供应商" style="width: 120px;"
                                        @change="updateImageModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.imageModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableImageModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>
                                    <p></p>
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">角色列表生成的文本模型:</span>
                                    <el-select v-model="genOptions.textProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateTextModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.textModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableTextModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>

                                    <el-button type="primary" size="small" icon="el-icon-plus" @click="openCreateCharacter">创建角色</el-button>
                                    <el-button type="success" size="small" icon="el-icon-magic-stick" @click="generateCharactersFromPrompt">从人物设定生成</el-button>
                                </div>
                            </div>
                        
                            <!-- 角色列表 -->
                            <el-row :gutter="20" type="flex" style="flex-wrap: wrap;">
                                <el-col :span="8" v-for="char in characterList" :key="char.id">
                                    <el-card class="character-card" style="margin-bottom: 20px; height: 100%;">
                                        <div slot="header" class="character-header">
                                            <span class="character-name">{{ char.name }}</span>
                                            <el-button class="delete-btn" type="text" icon="el-icon-delete"
                                                @click="deleteCharacter(char.id)"></el-button>
                                        </div>
                                        <!-- 将原来的多张图片显示改为单张图片显示 -->
                                        <div class="character-content">
                                            <div class="character-view">
                                                <div class="view-title">角色设计图（含正面特写与多视图）</div>
                                                <div class="view-image" v-if="char.image_url">
                                                    <el-image :src="char.image_url" :preview-src-list="[char.image_url]" fit="contain"></el-image>
                                                    <div class="image-actions">
                                                        <el-button type="text" size="mini" @click="uploadCharacterImage(char)">替换图片</el-button>
                                                        <el-button type="text" size="mini" @click="generateCharacterView(char)">重新生成</el-button>
                                                    </div>
                                                </div>
                                                <div class="view-placeholder" v-else>
                                                    <div class="placeholder-content">
                                                        <i class="el-icon-picture-outline"></i>
                                                        <div>暂无角色设计图</div>
                                                    </div>
                                                    <div class="action-buttons">
                                                        <el-button type="primary" size="small" @click="uploadCharacterImage(char)">
                                                            <i class="el-icon-upload2"></i>
                                                            上传角色设计图
                                                        </el-button>
                                                        <el-button type="success" size="small" @click="generateCharacterView(char)">
                                                            <i class="el-icon-magic-stick"></i>
                                                            AI生成角色设计图
                                                        </el-button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="character-desc">
                                                <div v-if="!char._editing">
                                                    {{ char.description || '暂无描述' }}
                                                    <el-button type="text" size="mini" style="float: right;" @click="editCharacterDescription(char)">
                                                        <i class="el-icon-edit"></i> 编辑
                                                    </el-button>
                                                </div>
                                                <div v-else>
                                                    <el-input type="textarea" v-model="char._tempDescription" :rows="3" placeholder="请输入角色描述"></el-input>
                                                    <div style="margin-top: 5px; text-align: right;">
                                                        <el-button size="mini" @click="cancelEditCharacterDescription(char)">取消</el-button>
                                                        <el-button type="primary" size="mini" @click="saveCharacterDescription(char)">保存</el-button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </el-card>
                                </el-col>
                            </el-row>
                        </el-tab-pane>

                        <!-- Script Tab (Enhanced with Text Model Config) -->
                        <el-tab-pane label="剧本创作" name="script">
                            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; background: #f5f7fa; padding: 10px; border-radius: 4px;">
                                <div style="display:flex; align-items:center; gap: 15px;">
                                    <div><el-checkbox v-model="allScriptsSelected" @change="toggleAllScripts">全选</el-checkbox><span style="margin-left: 10px; color: #666; font-size: 13px;">已选 {{ selectedScriptCount }} 项</span></div>
                                    <div style="border-left:1px solid #ddd; padding-left:15px; display:flex; align-items:center; gap:10px;">
                                        <span style="font-size:13px; color:#606266; font-weight:bold;">AI 模型:</span>
                                        <el-select v-model="genOptions.textProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateTextModelDefault">
                                            <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                        </el-select>
                                        <el-select v-model="genOptions.textModelName" size="mini" placeholder="模型" style="width: 150px;">
                                            <el-option v-for="m in availableTextModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                        </el-select>
                                        <span>建议选参数量大的模型，比如qwen3-max</span>
                                    </div>
                                </div>
                                <div><el-button type="danger" size="small" icon="el-icon-delete" plain :disabled="selectedScriptCount === 0" @click="deleteSelectedScripts">批量删除</el-button><el-button type="danger" size="small" icon="el-icon-delete-solid" @click="deleteAllScripts">清空全部</el-button></div>
                            </div>

                            <div ref="scriptListRef" class="script-list-container">
                                <div v-for="(section, index) in scriptSections" :key="index" class="script-section-block">
                                    <div class="script-checkbox"><el-checkbox v-model="section._checked"></el-checkbox></div>
                                    <div class="script-content-wrapper">
                                        <div class="script-index">#{{ index + 1 }}</div>
                                        <el-input type="textarea" :autosize="{ minRows: 3, maxRows: 10}" placeholder="请输入剧本内容..." v-model="section.content" @change="saveScript"></el-input>
                                        <div class="script-toolbar">
                                            <i class="el-icon-rank" style="cursor: move; margin-right: 10px; margin-top: 5px;" title="拖拽排序"></i>
                                            <el-button size="mini" type="success" icon="el-icon-magic-stick" plain @click="generateScriptContinuation(index)">AI 续写</el-button>
                                            <el-button size="mini" type="primary" icon="el-icon-video-camera" plain @click="convertScriptToShot(section, index)">一键转分镜</el-button>
                                            <el-button size="mini" type="danger" icon="el-icon-delete" plain @click="removeScriptSection(index)">删除</el-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 20px;"><el-button type="primary" icon="el-icon-plus" style="width: 100%" @click="addScriptSection">添加新段落</el-button></div>
                        </el-tab-pane>

                        <!-- Scene Tab -->
                        <el-tab-pane label="场景列表" name="scenes">
                            <!-- 场景生成配置 -->
                            <div style="margin-bottom: 15px; background: #f5f7fa; padding: 10px; border-radius: 4px;">
                                <div style="display:flex; align-items:center; gap: 15px;">
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">文本生成模型:</span>
                                    <el-select v-model="genOptions.textProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateTextModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.textModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableTextModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>
                                    
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">图片生成模型:</span>
                                    <el-select v-model="genOptions.imageProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateImageModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.imageModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableImageModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>
                                </div>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div><span style="margin-right: 20px;">共 {{ shotList.length }} 个场景</span>
                                    <el-button type="danger" size="small" icon="el-icon-delete" plain :disabled="multipleSceneSelection.length === 0" @click="deleteSelectedScenes">批量删除</el-button>
                                    <el-button type="danger" size="small" icon="el-icon-delete-solid" @click="deleteAllScenes">清空全部</el-button>
                                    <el-button type="success" size="small" icon="el-icon-magic-stick" @click="batchGenerateScenePrompts">批量生成场景提示词</el-button>
                                    <el-button type="primary" size="small" icon="el-icon-picture" @click="batchGenerateSceneImages">批量生成场景图片</el-button>
                                </div>
                                <div>
                                    <el-button type="primary" size="small" icon="el-icon-plus" @click="openCreateScene">添加场景</el-button>
                                </div>
                            </div>

                            <el-table :data="shotList" border stripe style="width: 100%" v-loading="loadingShots" row-key="id" @selection-change="handleSceneSelectionChange">
                                <el-table-column type="selection" width="55"></el-table-column>
                                <el-table-column prop="scene" label="场次" width="100"></el-table-column>
                                <el-table-column prop="shot_number" label="场景编号" width="100"></el-table-column>
                                <el-table-column prop="scene_description" label="场景说明" min-width="50"></el-table-column>
                                <el-table-column prop="scene_prompt" label="场景提示词" min-width="200"></el-table-column>
                                <el-table-column label="场景图片" width="120">
                                    <template slot-scope="scope">
                                        <div v-if="scope.row.scene_image" style="position: relative;">
                                            <el-image :src="scope.row.scene_image" :preview-src-list="[scope.row.scene_image]" fit="contain"></el-image>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="characters" label="出席人物" width="150">
                                    <template slot-scope="scope">
                                        <el-tag v-for="char in scope.row.characters" :key="char.id" size="mini" style="margin-right: 5px;">{{ char.name }}</el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="180">
                                    <template slot-scope="scope">
                                        <el-tooltip content="编辑" placement="top"><el-button size="mini" icon="el-icon-edit" circle @click="openEditScene(scope.row)"></el-button></el-tooltip>
                                        <el-tooltip content="生成提示词" placement="top"><el-button size="mini" type="success" icon="el-icon-magic-stick" circle plain @click="generateScenePrompt(scope.row)"></el-button></el-tooltip>
                                        <el-tooltip content="生成图片" placement="top"><el-button size="mini" type="primary" icon="el-icon-picture" circle plain @click="generateSceneImage(scope.row)"></el-button></el-tooltip>
                                        <el-tooltip content="替换图片" placement="top"><el-button size="mini" type="info" icon="el-icon-upload2" circle plain @click="uploadSceneImage(scope.row)"></el-button></el-tooltip>
                                        <el-tooltip content="删除" placement="top"><el-button size="mini" type="danger" icon="el-icon-delete" circle plain @click="deleteShot(scope.row)"></el-button></el-tooltip>
                                        <el-tooltip content="向下插入一行" placement="top"><el-button size="mini" type="primary" icon="el-icon-plus" circle plain @click="insertScene(scope.$index)"></el-button></el-tooltip> 
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-tab-pane>
                        <!-- 5. 融图功能 Tab -->
                        <el-tab-pane label="融图功能" name="image-fusion">
                            <!-- 融图生成配置 -->
                            <div style="margin-bottom: 15px; background: #f5f7fa; padding: 10px; border-radius: 4px;">
                                <div style="display:flex; align-items:center; gap: 15px;">
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">文本生成模型:</span>
                                    <el-select v-model="genOptions.textProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateTextModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.textModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableTextModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>
                                </div>

                                <div style="display:flex; align-items:center; gap: 15px; margin-top: 10px;">
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">元素图片生成模型:</span>
                                    <el-select v-model="genOptions.imageProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateImageModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.imageModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableImageModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>
                                    <div style="font-size: 12px; color: #E6A23C; margin-left: 10px;"> </div>
                                </div>
                                
                                <div style="display:flex; align-items:center; gap: 15px; margin-top: 10px;">
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">图生图模型:</span>
                                    <el-select v-model="genOptions.fusionProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateFusionModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.fusionModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableFusionModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>
                                    <div style="font-size: 12px; color: #E6A23C; margin-left: 10px;"><i class="el-icon-info"></i> 提示：推荐使用支持图生图的模型 (如 Wanx)</div>
                                    <div style="font-size: 12px; color: #E6A23C; margin-left: 10px;"><i class="el-icon-info"></i> 提示：融图发给AI的顺序为先是元素图片，最后是场景底图，在提示词描述时请注意顺序</div>
                                </div>
                                <div style="display:flex; align-items:center; gap: 15px; margin-top: 10px;">
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">视频生成模型:</span>
                                    <el-select v-model="genOptions.videoProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateVideoModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.videoModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableVideoModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>
                                </div>
                            </div>

                            <!-- 工具栏 -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <span style="margin-right: 20px;">共 {{ fusionList.length }} 个融图任务</span>
                                    <el-button type="danger" size="small" icon="el-icon-delete" plain :disabled="multipleFusionSelection.length === 0" @click="deleteSelectedFusions">批量删除</el-button>
                                    <el-button type="success" size="small" icon="el-icon-copy-document" @click="copyFromScenes">从场景列表复制数据</el-button>
                                    
                                    <el-button type="warning" size="small" icon="el-icon-magic-stick" @click="openFusionBatchDialog('prompt')">批量生成提示词</el-button>
                                    
                                    <el-button type="success" size="small" icon="el-icon-picture" @click="openFusionBatchDialog('image')">批量生成融合图</el-button>
                                    <el-button type="danger" size="small" icon="el-icon-video-camera" @click="openFusionBatchDialog('video')">批量生成视频</el-button>
                                </div>
                                <div>
                                    <el-button type="primary" size="small" icon="el-icon-plus" @click="openCreateFusion">添加融图任务</el-button>
                                </div>
                            </div>

                            <!-- 任务列表 -->
                            <el-table :data="fusionList" border stripe style="width: 100%" v-loading="loadingFusions" @selection-change="handleFusionSelectionChange" row-key="id">
                                <el-table-column type="selection" width="40"></el-table-column>
                                <el-table-column prop="scene" label="场次" width="60"></el-table-column>
                                <el-table-column prop="shot_number" label="镜号" width="60"></el-table-column>
                                <el-table-column label="场景说明" width="150">
                                    <template slot-scope="scope">
                                                {{ scope.row.scene_description || "无" }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="分镜描述" width="200">
                                    <template slot-scope="scope">
                                                <div><strong>画面:</strong> {{ scope.row.visual_description }}</div>
                                        <div style="margin-top: 5px; color: #409EFF;"><i class="el-icon-microphone"></i> {{ scope.row.dialogue }}</div>
                                        <div style="margin-top: 5px; color: #666;"><strong>声音:</strong> {{ scope.row.audio_description }}</div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="基础图片 (底图)" width="120">
                                    <template slot-scope="scope">
                                        <div v-if="scope.row.base_image" style="position: relative; width: 100px; height: 70px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; overflow: hidden;">
                                            <el-image :src="scope.row.base_image" :preview-src-list="[scope.row.base_image]" fit="cover" style="width: 100%; height: 100%;"></el-image>
                                        </div>
                                        <div v-else style="color: #ccc; font-size: 12px;">未设置</div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="元素" width="200">
                                    <template slot-scope="scope">
                                        <div v-if="scope.row.elements && scope.row.elements.length">
                                            <div v-for="element in scope.row.elements" :key="element.id" style="display: inline-block; margin-right: 8px; margin-bottom: 5px; position: relative;">
                                                <div style="width: 80px; height: 80px; border: 1px solid #eee; border-radius: 4px; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center; background-color: #f5f7fa;" @click="element.image_url ? previewImage(element.image_url) : $message.warning('该角色暂无设计图')">
                                                    <el-image v-if="element.image_url" :src="element.image_url" fit="cover" style="width: 100%; height: 100%;" :preview-src-list="[element.image_url]"></el-image>
                                                    <i v-else class="el-icon-user-solid" style="font-size: 20px; color: #c0c4cc;"></i>
                                            </div>
                                                <div style="text-align: center; margin-top: 2px; font-size: 10px; color: #666; max-width: 40px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ element.name }}</div>
                                                <i class="el-icon-close" style="position: absolute; top: -5px; right: -5px; color: red; background: white; border-radius: 50%; padding: 2px; cursor: pointer; font-size: 12px;" @click="removeElement(scope.row, element)"></i>
                                            </div>
                                            <el-button type="text" size="mini" icon="el-icon-plus" @click="addElement(scope.row)">添加元素</el-button>
                                        </div>
                                        <div v-else>
                                            <el-button type="text" size="mini" icon="el-icon-plus" @click="addElement(scope.row)">添加元素</el-button>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="首帧融合提示词" prop="fusion_prompt" min-width="250">
                                    <template slot-scope="scope">
                                               首帧： {{ scope.row.fusion_prompt || '未设置' }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="尾帧融合提示词" prop="fusion_prompt" min-width="250">
                                    <template slot-scope="scope">
                                               尾帧： {{ scope.row.end_frame_prompt || '未设置' }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="生成画面 (首帧/尾帧)" width="220">
                                    <template slot-scope="scope">
                                        <div style="display: flex; gap: 5px;">
                                            <div style="position: relative; width: 90px; height: 60px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; overflow: hidden; border: 1px solid #ddd;">
                                                <el-image v-if="scope.row.result_image" :src="scope.row.result_image" :preview-src-list="[scope.row.result_image]" fit="cover" style="width: 100%; height: 100%;"></el-image>
                                                <span v-else style="font-size: 10px; color: #999;">首帧未生成</span>
                                                <div style="position:absolute; bottom:0; right:0; background:rgba(0,0,0,0.5); color:#fff; font-size:10px; padding:0 3px;">Start</div>
                                            </div>
                                            <div style="position: relative; width: 90px; height: 60px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; overflow: hidden; border: 1px solid #ddd;">
                                                <el-image v-if="scope.row.end_frame_image" :src="scope.row.end_frame_image" :preview-src-list="[scope.row.end_frame_image]" fit="cover" style="width: 100%; height: 100%;"></el-image>
                                                <span v-else style="font-size: 10px; color: #999;">尾帧未生成</span>
                                                <div style="position:absolute; bottom:0; right:0; background:rgba(0,0,0,0.5); color:#fff; font-size:10px; padding:0 3px;">End</div>
                                            </div>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="结果视频" width="160" align="center">
                                    <template slot-scope="scope">
                                        <div v-if="scope.row.video_url" style="width: 140px; height: 80px; background: #000; display: flex; justify-content: center; align-items: center; border-radius: 4px; overflow: hidden; position: relative; cursor: pointer;" @click="playVideo(scope.row)">
                                            <video :src="scope.row.video_url" style="width: 100%; height: 100%; object-fit: cover;"></video>
                                            <div class="video-play-overlay"><i class="el-icon-caret-right"></i></div>
                                        </div>
                                        <div v-else style="color: #ccc; font-size: 12px;">未生成</div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" fixed="right">
                                    <template slot-scope="scope">
                                        <el-tooltip content="编辑任务" placement="top"><el-button size="mini" icon="el-icon-edit" circle plain @click="editFusion(scope.row)"></el-button></el-tooltip>
                                        <el-tooltip content="生成提示词" placement="top"><el-button size="mini" type="warning" icon="el-icon-magic-stick" circle plain @click="generateFusionPrompt(scope.row)"></el-button></el-tooltip>
                                        <el-tooltip content="生成首帧" placement="top">
                                            <el-button size="mini" type="success" icon="el-icon-picture" circle plain @click="generateFusionImage(scope.row)"></el-button>
                                        </el-tooltip>
                                        <el-tooltip content="生成尾帧" placement="top">
                                            <el-button size="mini" type="success" icon="el-icon-picture-outline" circle plain @click="generateFusionEndFrameImage(scope.row)"></el-button>
                                        </el-tooltip>
                                        <el-tooltip content="生成视频" placement="top"><el-button size="mini" type="primary" icon="el-icon-video-camera" circle plain @click="generateFusionVideo(scope.row)" :disabled="!scope.row.result_image"></el-button></el-tooltip>
                                        <el-tooltip content="删除" placement="top"><el-button size="mini" type="danger" icon="el-icon-delete" circle plain @click="deleteFusion(scope.row)"></el-button></el-tooltip>
                                        <el-tooltip content="向下插入一行" placement="top"><el-button size="mini" type="primary" icon="el-icon-plus" circle plain @click="insertFusion(scope.$index)"></el-button></el-tooltip> 
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-tab-pane>

                    </el-tabs>
                </div>
                <el-empty v-if="!currentProject" description="请在左上角选择或创建一个电影项目"></el-empty>
            </el-main>
        </el-container>

        <el-dialog title="视觉风格分析 (Visual Analysis)" :visible.sync="visualAnalysisVisible" width="600px" append-to-body>
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="upload-area" style="border: 2px dashed #dcdfe6; border-radius: 6px; padding: 20px; cursor: pointer; position: relative; transition: .3s;" 
                    @click="$refs.analysisUploadInput.click()" 
                    @drop.prevent="handleAnalysisDrop" 
                    @dragover.prevent>
                    
                    <div v-if="!visualAnalysisImage">
                        <i class="el-icon-upload" style="font-size: 48px; color: #c0c4cc;"></i>
                        <div class="el-upload__text" style="margin-top: 10px;">将参考图拖到此处，或<em>点击上传</em></div>
                    </div>
                    
                    <div v-else style="position: relative; height: 300px;">
                        <img :src="visualAnalysisImage" style="max-width: 100%; max-height: 100%; border-radius: 4px; object-fit: contain;">
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: #fff; padding: 5px;">点击更换图片</div>
                    </div>
                    
                    <input type="file" ref="analysisUploadInput" style="display: none;" @change="handleAnalysisFileChange" accept="image/*">
                </div>
            </div>

            <div v-if="visualAnalysisResult" style="background: #f4f4f5; padding: 15px; border-radius: 4px; border: 1px solid #e9e9eb;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: bold; color: #606266;"><i class="el-icon-magic-stick"></i> 风格分析结果：</span>
                    <el-button type="text" size="mini" icon="el-icon-document-copy" @click="copyAnalysisResult">复制内容</el-button>
                </div>
                <el-input type="textarea" :rows="6" v-model="visualAnalysisResult" resize="none"></el-input>
            </div>

            <span slot="footer" class="dialog-footer">
                <el-button @click="visualAnalysisVisible = false">关 闭</el-button>
                <el-button type="primary" icon="el-icon-cpu" :loading="analyzingVisual" @click="startVisualAnalysis" :disabled="!visualAnalysisFile">开始分析</el-button>
            </span>
        </el-dialog>

        <el-dialog :visible.sync="videoPlayerVisible" width="60%" title="视频预览">
            <div style="text-align: center;"><video v-if="playerVideoUrl" :src="playerVideoUrl" controls autoplay style="width: 100%; max-height: 500px;"></video></div>
        </el-dialog>

        <!-- Project Dialog -->
        <el-dialog :title="projectDialogTitle" :visible.sync="projectDialogVisible" width="60%">
            <el-form :model="projectForm" label-width="100px" ref="projectForm">
                <el-tabs v-model="activeProjectTab">
                    <el-tab-pane label="基础信息" name="basic">
                        <el-form-item label="项目名称" prop="film_name" required><el-input v-model="projectForm.film_name"></el-input></el-form-item>
                        <el-form-item label="核心冲突"><el-input type="textarea" v-model="projectForm.script_core_conflict" :rows="3"></el-input></el-form-item>
                        <el-form-item label="情感关键词"><el-input v-model="projectForm.script_emotional_keywords"></el-input></el-form-item>
                        <el-form-item label="基础信息" prop="basic_info"><el-input type="textarea" v-model="projectForm.basic_info" :rows="4" placeholder="包含时代背景、空间特质、人物小传等信息"></el-input></el-form-item>
                    </el-tab-pane>
                    <el-tab-pane label="视觉风格" name="visual">
                        <el-form-item label="人物设定" prop="visual_consistency_prompt"><el-input type="textarea" v-model="projectForm.visual_consistency_prompt" :rows="4" placeholder="例：男主角张三，35岁..."></el-input></el-form-item>
                        <el-form-item label="色彩体系"><el-input type="textarea" rows="5" v-model="projectForm.visual_color_system"></el-input></el-form-item>
                    </el-tab-pane>
                </el-tabs>
            </el-form>
            <span slot="footer" class="dialog-footer"><el-button icon="el-icon-close" @click="projectDialogVisible = false">取 消</el-button><el-button type="primary" icon="el-icon-check" @click="submitProject">确 定</el-button></span>
        </el-dialog>

        <!-- Settings Dialog (Updated with Text Model) -->
        <el-dialog title="模型供应商管理" :visible.sync="settingsVisible" width="800px">
            <div class="settings-container">
                <div class="settings-sidebar">
                    <div style="margin-bottom: 10px;">
                        <el-button type="primary" size="mini" icon="el-icon-plus" style="width: 100%" @click="initNewProvider">新增供应商</el-button>
                    </div>
                    <div v-for="p in providers" :key="p.id" class="provider-item" :class="{active: editingProvider && editingProvider.id === p.id}" @click="selectProvider(p)">
                        <div style="display:flex; align-items:center;">
                            <div class="provider-item-icon" :style="{background: getProviderColor(p.type)}">{{ p.name.charAt(0).toUpperCase() }}</div>
                            <span style="font-size: 13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width: 120px;">{{ p.name }}</span>
                        </div>
                        <i class="el-icon-arrow-right" style="font-size: 12px; color: #ccc;"></i>
                    </div>
                </div>
                <div class="settings-content" v-if="editingProvider">
                    <el-form label-position="top" size="small">
                        <el-form-item label="供应商名称"><el-input v-model="editingProvider.name"></el-input></el-form-item>
                        <el-row :gutter="20">
                            <el-col :span="12">
                                <el-form-item label="类型">
                                    <el-select v-model="editingProvider.type" style="width: 100%">
                                        <el-option label="Aliyun DashScope" value="aliyun"></el-option>
                                        <el-option label="SiliconFlow (OpenAI)" value="siliconflow"></el-option>
                                        <el-option label="RunningHub" value="runninghub"></el-option>
                                        <el-option label="VIDU Studio" value="vidu"></el-option>
                                        <el-option label="智谱" value="zai"></el-option>
                                        <el-option label="即梦 (Volcengine)" value="jimeng"></el-option>
                                        <el-option label="ComfyUI (Local)" value="comfyui"></el-option>
                                        <el-option label="海螺AI" value="minimax"></el-option>
                                        <el-option label="Mock Service" value="mock"></el-option>
                                    </el-select>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12"><el-form-item label="启用状态"><el-switch v-model="editingProvider.enabled"></el-switch></el-form-item></el-col>
                        </el-row>
                        <el-form-item label="Base URL (可选)">
                            <el-input v-model="editingProvider.base_url" placeholder="https://api.vidu.com"></el-input>
                        </el-form-item>
                        <el-form-item label="API Key">
                            <el-input 
                                v-model="editingProvider.api_key" 
                                show-password 
                                :placeholder="editingProvider.type === 'jimeng' ? 'AccessKeyId|SecretKey (用竖线分隔)' : '输入 Key (若不修改请保持原样/空)'">
                            </el-input>
                            <div v-if="editingProvider.type === 'jimeng'" style="font-size: 12px; color: #909399; margin-top: 5px;">
                                <i class="el-icon-info"></i> 即梦需要填写格式: <code>AccessKeyId|SecretKey</code>
                                <br>示例: <code>AKTP1234567890|aGVsbG93b3JsZA==</code>
                            </div>
                        </el-form-item>
                        <div class="model-list-header"><span style="font-weight: bold;">模型列表</span><el-button type="text" icon="el-icon-plus" @click="addModelToProvider">添加</el-button></div>
                        <div v-if="editingProvider.models && editingProvider.models.length">
                            <div v-for="(m, idx) in editingProvider.models" :key="idx" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <el-input v-model="m.name" placeholder="模型名称 (如: vidu-1)" style="flex: 2"></el-input>
                                <el-input v-model="m.path" placeholder="Path (可选)" style="flex: 2"></el-input>
                                <el-select v-model="m.type" placeholder="类型" style="flex: 1">
                                    <el-option label="图片" value="image"></el-option>
                                    <el-option label="视频" value="video"></el-option>
                                    <el-option label="语音" value="audio"></el-option>
                                    <el-option label="文本" value="text"></el-option>
                                    <el-option label="图生图" value="image_fusion"></el-option>
                                </el-select>
                                <el-button type="danger" icon="el-icon-delete" circle plain size="mini" @click="removeModelFromProvider(idx)"></el-button>
                            </div>
                        </div>
                        <div style="margin-top: 30px; text-align: right;">
                            <el-button type="danger" plain icon="el-icon-delete" @click="deleteCurrentProvider" v-if="editingProvider.id">删除</el-button>
                            <el-button type="primary" icon="el-icon-check" @click="saveCurrentProvider">保存</el-button>
                        </div>
                    </el-form>
                </div>
                <div v-else class="settings-content" style="display:flex;align-items:center;justify-content:center;color:#999;">请选择供应商</div>
            </div>
        </el-dialog>

        <!-- Scene Dialog -->
        <el-dialog :title="sceneDialogTitle" :visible.sync="sceneDialogVisible" width="60%">
            <el-form :model="sceneForm" label-width="100px">
                <el-form-item label="场次" prop="scene" required><el-input v-model="sceneForm.scene"></el-input></el-form-item>
                <el-form-item label="场景编号" prop="shot_number" required><el-input v-model="sceneForm.shot_number"></el-input></el-form-item>
                <el-form-item label="场景说明" prop="scene_description"><el-input type="textarea" v-model="sceneForm.scene_description" :rows="3"></el-input></el-form-item>
                <el-form-item label="场景提示词" prop="scene_prompt">
                    <el-input type="textarea" v-model="sceneForm.scene_prompt" :rows="5" 
                        placeholder="必须包含：时间、天气、光源、空间类型、空间尺度、高度、场景中的标志性建筑或物体、背景+前景+氛围的框架说明、氛围、整体风格、景别、视角设定、构图"></el-input>
                </el-form-item>
                <el-form-item label="出席人物" prop="characters">
                    <el-select v-model="sceneForm.characters" multiple placeholder="选择人物" style="width: 100%">
                        <el-option v-for="char in characterList" :key="char.id" :label="char.name" :value="char.id"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="场景图片">
                    <div v-if="sceneForm.scene_image" style="margin-bottom: 10px;">
                        <el-image :src="sceneForm.scene_image" style="width: 200px; height: 150px; object-fit: cover;" :preview-src-list="[sceneForm.scene_image]"></el-image>
                    </div>
                    <div v-else>
                        <div style="margin-bottom: 10px; color: #999;">暂无场景图片</div>
                    </div>
                    <div class="action-buttons">
                        <el-button type="primary" size="small"  @click="handleSceneImageUpload">
                            <i class="el-icon-upload2"></i>
                            上传场景图片
                        </el-button>
                        <el-button type="success" size="small" @click="handleSceneImageGenerate">
                            <i class="el-icon-magic-stick"></i>
                            AI生成场景图片
                        </el-button>
                    </div>
                </el-form-item>
            </el-form>
            <span slot="footer" class="dialog-footer"><el-button icon="el-icon-close" @click="sceneDialogVisible = false">取 消</el-button><el-button type="primary" icon="el-icon-check" @click="submitScene">确 定</el-button></span>
        </el-dialog>

        <!-- Character Dialog -->
        <el-dialog title="创建角色" :visible.sync="characterDialogVisible" width="500px">
            <el-form :model="characterForm" label-width="80px">
                <el-form-item label="角色名称" required>
                    <el-input v-model="characterForm.name" placeholder="请输入角色名称"></el-input>
                </el-form-item>
                <el-form-item label="角色描述">
                    <el-input type="textarea" v-model="characterForm.description" 
                        :rows="4" placeholder="请描述角色的外貌、性格、服装等特征"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="characterDialogVisible = false">取 消</el-button>
                <el-button type="primary" @click="submitCharacter">确 定</el-button>
            </div>
        </el-dialog>
        
        <!-- 融图任务编辑/创建对话框 -->
        <el-dialog :title="fusionDialogTitle" :visible.sync="fusionDialogVisible" width="80%">
            <el-form :model="fusionForm" label-width="100px" size="small">
                <el-row :gutter="20">
                    <el-col :span="8">
                        <el-form-item label="场次">
                            <el-input v-model="fusionForm.scene"></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="8">
                        <el-form-item label="镜号">
                            <el-input v-model="fusionForm.shot_number"></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="8">
                        <el-form-item label="关联分镜 ID" :title="fusionForm.shot_id || '无'">
                            <el-select 
                                v-model="fusionForm.shot_id" 
                                placeholder="选择关联分镜" 
                                filterable 
                                clearable 
                                style="width: 100%"
                                @change="handleFusionShotChange"
                            >
                                <el-option
                                    v-for="shot in shotList"
                                    :key="shot.id"
                                    :label="`场${shot.scene}-镜${shot.shot_number}`"
                                    :value="shot.id">
                                    <span style="float: left; font-weight: bold;">{{ shot.scene }}-{{ shot.shot_number }}</span>
                                    <span style="float: right; color: #8492a6; font-size: 12px; margin-left: 10px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        {{ shot.visual_description || '无画面描述' }}
                                    </span>
                                </el-option>
                            </el-select>
                            <!-- <el-tag size="mini">{{ fusionForm.shot_id ? fusionForm.shot_id.slice(0, 8) + '...' : '未关联' }}</el-tag> -->
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row :gutter="20">
                    <el-col :span="24">
                        <el-form-item label="场景说明">
                            <el-input type="textarea" v-model="fusionForm.scene_description" :rows="2"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row :gutter="20">
                    <el-col :span="24">
                        <el-form-item label="分镜描述">
                                <template slot-scope="scope">
                                    <el-form-item>
                                    <strong>画面:</strong> <el-input type="textarea" v-model="fusionForm.visual_description" :rows="2"></el-input>
                                    </el-form-item>
                                    <el-form-item>
                                    <strong>台词:</strong></i> <el-input type="textarea" v-model="fusionForm.dialogue" :rows="2"></el-input>
                                    </el-form-item>
                                    <el-form-item>
                                   <strong>声音:</strong> <el-input type="textarea" v-model="fusionForm.audio_description" :rows="2"></el-input>
                                    </el-form-item>
                                </template>
                        </el-form-item>
                    </el-col>
                </el-row>
                
                <el-form-item label="场景底图" required>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div v-if="fusionForm.base_image" style="position: relative; width: 150px; height: 100px; border-radius: 4px; overflow: hidden; border: 1px solid #eee;">
                            <el-image :src="fusionForm.base_image" :preview-src-list="[fusionForm.base_image]" fit="cover" style="width: 100%; height: 100%;"></el-image>
                            <i class="el-icon-close" style="position: absolute; top: 5px; right: 5px; color: #fff; background: rgba(0,0,0,0.5); border-radius: 50%; padding: 3px; cursor: pointer;" @click="fusionForm.base_image = ''"></i>
                        </div>
                        <el-button size="mini" icon="el-icon-upload2" @click="$refs.baseUploadInput.click()">上传底图</el-button>
                        <input type="file" ref="baseUploadInput" style="display: none;" @change="handleBaseUpload" accept="image/*">
                    </div>
                </el-form-item>
                
                <el-form-item label="元素列表">
                    <div style="margin-bottom: 10px;">
                        <div v-for="element in fusionForm.elements" :key="element.id" style="display: inline-block; margin-right: 8px; margin-bottom: 8px; position: relative;">
                            <div style="width: 60px; height: 60px; border: 1px solid #eee; border-radius: 4px; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center; background-color: #f5f7fa;" @click="element.image_url ? previewImage(element.image_url) : $message.warning('该角色暂无设计图')">
                                <el-image v-if="element.image_url" :src="element.image_url" fit="cover" style="width: 100%; height: 100%;" :preview-src-list="[element.image_url]"></el-image>
                                <i v-else class="el-icon-user-solid" style="font-size: 30px; color: #c0c4cc;"></i>
                            </div>
                            <div style="text-align: center; margin-top: 4px; font-size: 12px; color: #666;">{{ element.name }}</div>
                            <i class="el-icon-close" style="position: absolute; top: -5px; right: -5px; color: red; background: white; border-radius: 50%; padding: 2px; cursor: pointer; font-size: 12px;" @click="removeElement(fusionForm, element)"></i>
                        </div>
                        <el-button type="text" size="small" icon="el-icon-plus" @click="addElement(fusionForm)">添加新元素</el-button>
                    </div>
                </el-form-item>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="首帧提示词" required>
                            <el-input type="textarea" v-model="fusionForm.fusion_prompt" :rows="10" placeholder="描述首帧画面..."></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="首帧图片">
                            <div v-if="fusionForm.result_image" style="width: 100%; height: 150px; border-radius: 4px; overflow: hidden; border: 1px solid #eee; position:relative;">
                                <el-image :src="fusionForm.result_image" :preview-src-list="[fusionForm.result_image]" fit="cover" style="width: 100%; height: 100%;"></el-image>
                                <i class="el-icon-close" style="position: absolute; top: 5px; right: 5px; color: #fff; background: rgba(0,0,0,0.5); border-radius: 50%; padding: 3px; cursor: pointer;" @click="fusionForm.result_image = ''"></i>
                            </div>
                            <div v-else style="color: #ccc; font-size: 12px; height: 150px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ddd; border-radius: 4px;">未生成</div>
                            
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <el-button size="small" type="success" icon="el-icon-picture" :disabled="!fusionForm.base_image || !fusionForm.fusion_prompt" @click="generateFusionImage(fusionForm)">生成首帧</el-button>
                                <el-button size="small" icon="el-icon-upload2" @click="$refs.startFrameUpload.click()">上传</el-button>
                                <input type="file" ref="startFrameUpload" style="display: none;" @change="handleStartFrameUpload" accept="image/*">
                            </div>
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="尾帧提示词">
                            <el-input type="textarea" v-model="fusionForm.end_frame_prompt" :rows="10" placeholder="描述尾帧画面（如运镜后的变化）..."></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="尾帧图片">
                            <div v-if="fusionForm.end_frame_image" style="width: 100%; height: 150px; border-radius: 4px; overflow: hidden; border: 1px solid #eee; position:relative;">
                                <el-image :src="fusionForm.end_frame_image" :preview-src-list="[fusionForm.end_frame_image]" fit="cover" style="width: 100%; height: 100%;"></el-image>
                                <i class="el-icon-close" style="position: absolute; top: 5px; right: 5px; color: #fff; background: rgba(0,0,0,0.5); border-radius: 50%; padding: 3px; cursor: pointer;" @click="fusionForm.end_frame_image = ''"></i>
                            </div>
                            <div v-else style="color: #ccc; font-size: 12px; height: 150px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ddd; border-radius: 4px;">未生成</div>
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <el-button size="small" type="success" plain icon="el-icon-picture-outline" :disabled="!fusionForm.base_image || !fusionForm.end_frame_prompt" @click="generateFusionEndFrameImage(fusionForm)">生成尾帧</el-button>
                                <el-button size="small" icon="el-icon-upload2" @click="$refs.endFrameUpload.click()">上传</el-button>
                                <input type="file" ref="endFrameUpload" style="display: none;" @change="handleEndFrameUpload" accept="image/*">
                            </div>
                        </el-form-item>
                    </el-col>
                </el-row>

                <el-form-item label="融合视频">
                    <div v-if="fusionForm.video_url" class="media-generated-box"><video :src="fusionForm.video_url" controls class="video-preview"></video><div style="margin-top: 5px;"><a :href="fusionForm.video_url" target="_blank" download style="font-size: 12px;">下载视频</a></div></div>
                    <div v-else style="color: #ccc; font-size: 14px; height: 150px; display: flex; align-items: center;">未生成</div>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="fusionDialogVisible = false">取 消</el-button>
                <el-button type="warning" icon="el-icon-magic-stick" @click="generateFusionPrompt(fusionForm)">
                    生成提示词
                </el-button>
                <el-button type="success" icon="el-icon-picture" :disabled="!fusionForm.base_image || !fusionForm.fusion_prompt" @click="generateFusionImage(fusionForm)">
                    生成首帧
                </el-button>
                <el-button type="success" plain icon="el-icon-picture-outline" :disabled="!fusionForm.base_image || !fusionForm.end_frame_prompt" @click="generateFusionEndFrameImage(fusionForm)">
                    生成尾帧
                </el-button>
                <el-button type="warning" icon="el-icon-video-camera" :disabled="!fusionForm.result_image" @click="generateFusionVideo(fusionForm)">生成视频</el-button>
                <el-button type="primary" @click="saveFusion">保 存</el-button>
            </div>
        </el-dialog>

        <!-- 元素对话框 -->
        <el-dialog title="添加元素" :visible.sync="elementDialogVisible" width="500px">
            <el-form :model="elementForm" label-width="80px">
                <el-form-item label="元素名称" required>
                    <el-input v-model="elementForm.name" placeholder="请输入元素名称"></el-input>
                </el-form-item>

                <el-form-item label="添加方式">
                    <el-radio-group v-model="elementForm.type">
                        <el-radio label="upload">上传图片</el-radio>
                        <el-radio label="generate">AI生成</el-radio>
                        <el-radio label="character">选择角色</el-radio>
                    </el-radio-group>
                </el-form-item>

                <!-- 上传图片 -->
                <el-form-item v-if="elementForm.type === 'upload'" label="选择图片">
                    <!-- 使用 axios 上传，不使用 el-upload 的 action，因为需要 custom logic -->
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div v-if="elementForm.image_url" style="width: 80px; height: 80px; border: 1px dashed #dcdfe6; border-radius: 4px; overflow: hidden;">
                            <el-image :src="elementForm.image_url" fit="cover" style="width: 100%; height: 100%;"></el-image>
                        </div>
                        <el-button size="mini" icon="el-icon-upload2" @click="$refs.elementUploadInput.click()">上传图片</el-button>
                        <input type="file" ref="elementUploadInput" style="display: none;" @change="handleElementUpload" accept="image/*">
                    </div>
                </el-form-item>

                <!-- AI生成 -->
                <el-form-item v-if="elementForm.type === 'generate'" label="生成提示词">
                    <el-input type="textarea" v-model="elementForm.prompt" :rows="4" placeholder="描述你想要生成的图片内容..."></el-input>
                    <el-button type="primary" size="small" style="margin-top: 10px;" @click="generateElementImage"
                        :loading="generatingElement">
                        生成图片
                    </el-button>
                    <div v-if="elementForm.image_url" style="margin-top: 15px;">
                        <div style="font-size: 14px; margin-bottom: 8px;">预览:</div>
                        <div style="width: 100px; height: 100px; border: 1px dashed #dcdfe6; border-radius: 4px; overflow: hidden; display: inline-block;">
                            <el-image :src="elementForm.image_url" fit="cover" style="width: 100%; height: 100%;"></el-image>
                        </div>
                    </div>
                </el-form-item>

                <!-- 选择角色 -->
                <el-form-item v-if="elementForm.type === 'character'" label="选择角色">
                    <el-select v-model="elementForm.character_id" placeholder="请选择角色" style="width: 100%">
                        <el-option v-for="char in characterList" :key="char.id" :label="char.name" :value="char.id"></el-option>
                    </el-select>
                    <div v-if="elementForm.character_id" style="margin-top: 10px;">
                        <el-image v-if="getCharacterImage(elementForm.character_id)" :src="getCharacterImage(elementForm.character_id)" style="width: 80px; height: 80px; border-radius: 4px;" fit="cover"></el-image>
                        <el-tag v-else type="warning" size="small">该角色暂无设计图</el-tag>
                    </div>
                </el-form-item>
            </el-form>

            <div slot="footer" class="dialog-footer">
                <el-button @click="elementDialogVisible = false">取 消</el-button>
                <el-button type="primary" @click="submitElement">确 定</el-button>
            </div>
        </el-dialog>

        <el-dialog title="融图批量生成设置" :visible.sync="fusionBatchDialogVisible" width="400px">
            <el-form label-position="top">
                <el-form-item label="生成类型">
                    <el-radio-group v-model="fusionBatchConfig.target" size="small">
                        <el-radio-button label="prompt">提示词 (首+尾)</el-radio-button>
                        <el-radio-button label="image">首帧图片</el-radio-button>
                        <el-radio-button label="end_image">尾帧图片</el-radio-button> 
                        <el-radio-button label="video">视频</el-radio-button>
                    </el-radio-group>
                </el-form-item>
                <!-- <el-form-item label="生成类型">
                    <el-tag v-if="fusionBatchConfig.target === 'prompt'" type="warning">融图提示词 (Fusion Prompt)</el-tag>
                    <el-tag v-if="fusionBatchConfig.target === 'image'" type="success">融合图片 (Fusion Image)</el-tag>
                    <el-tag v-if="fusionBatchConfig.target === 'video'" type="danger">融图视频 (Fusion Video)</el-tag>
                </el-form-item> -->

                <el-form-item label="选择生成范围">
                    <el-radio-group v-model="fusionBatchConfig.scope" style="display: flex; flex-direction: column; gap: 10px;">
                        <el-radio label="all">全部 {{ fusionList.length }} 个任务</el-radio>
                        
                        <el-radio label="selected" :disabled="multipleFusionSelection.length === 0">
                            已选中的 {{ multipleFusionSelection.length }} 个任务 
                            <span v-if="multipleFusionSelection.length===0" style="color:#999;font-size:12px">(请先在列表中勾选)</span>
                        </el-radio>
                        
                        <el-radio label="missing">
                            仅针对未生成的 {{ getFusionMissingCount(fusionBatchConfig.target) }} 个任务 
                            <span style="color:#999;font-size:12px">(跳过已存在的)</span>
                        </el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-form>
            <div slot="footer">
                <el-button icon="el-icon-close" @click="fusionBatchDialogVisible = false">取 消</el-button>
                <el-button type="primary" icon="el-icon-video-play" @click="startFusionBatchGeneration">开始生成</el-button>
            </div>
        </el-dialog>

        <div class="task-floater" @click="taskDrawerVisible = true">
            <el-badge :value="processingTaskCount" :hidden="processingTaskCount === 0" class="item">
                <el-button type="primary" icon="el-icon-loading" circle size="medium" v-if="processingTaskCount > 0"></el-button>
                <el-button type="info" icon="el-icon-s-order" circle size="medium" v-else></el-button>
            </el-badge>
        </div>

        <el-drawer title="后台任务队列" :visible.sync="taskDrawerVisible" direction="rtl" size="400px">
            <div class="task-list">
                <el-empty v-if="taskList.length === 0" description="暂无任务"></el-empty>
                
                <div v-for="task in taskList" :key="task.id" class="task-item">
                    <div class="task-header">
                        <span class="task-desc" :title="task.desc">{{ task.desc }}</span>
                        <el-tag size="mini" :type="getTaskTagType(task.status)">{{ getTaskStatusText(task.status) }}</el-tag>
                    </div>
                    
                    <div class="task-meta">
                        <span><i class="el-icon-time"></i> {{ task.created_at }}</span>
                        <i class="el-icon-close" @click="clearTask(task.id)" style="cursor:pointer; color:#999" v-if="task.status!=='processing'"></i>
                    </div>
                    
                    <el-progress :percentage="task.status === 'success' ? 100 : (task.status === 'processing' ? 50 : 0)" 
                                 :status="getTaskProgressStatus(task.status)" 
                                 :show-text="false"
                                 v-if="task.status !== 'pending'"></el-progress>
                                 
                    <div v-if="task.error" class="task-error">
                        <i class="el-icon-warning-outline"></i> {{ task.error }}
                    </div>
                </div>
            </div>
        </el-drawer>
    </div>

    <script src="https://unpkg.com/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        new Vue({
            el: '#app',
            data: {
                projectList: [], currentProjectId: '', currentProject: null, shotList: [], loadingShots: false,
                activeTab: 'characters', scriptSections: [],
                allScriptsSelected: false, multipleSceneSelection: [],
                globalLoading: false, loadingTitle: '', loadingSubText: '', currentAbortController: null, 
                settingsVisible: false, providers: [], editingProvider: null, 
                videoPlayerVisible: false, playerVideoUrl: '',
                genOptions: {
                    imageProviderId: '', imageModelName: '',
                    videoProviderId: '', videoModelName: '',
                    voiceProviderId: '', voiceModelName: '',
                    textProviderId: '', textModelName: '', // Added Text Model Config
                    fusionProviderId: '', fusionModelName: '' // Added Fusion Model Config
                },
                projectDialogVisible: false, projectDialogTitle: '新建项目', activeProjectTab: 'basic', projectForm: {},
                previewVisible: false, previewUrl: '',
                scriptSortable: null,
                characterList: [],
                characterDialogVisible: false,
                characterForm: {
                    name: '',
                    description: ''
                },
                sceneDialogVisible: false,
                sceneDialogTitle: '编辑场景',
                sceneForm: {
                    scene: '',
                    shot_number: '',
                    scene_description: '',
                    scene_prompt: '',
                    scene_image: '',
                    characters: []
                },
                // 融图功能相关数据
                loadingFusions: false,
                fusionList: [],
                multipleFusionSelection: [],
                fusionDialogVisible: false,
                fusionDialogTitle: '编辑融图任务',
                fusionForm: {
                    id: '',
                    scene: '',
                    shot_number: '',
                    shot_id: '', // 关联的分镜ID
                    base_image: '', // 基础图片
                    elements: [], // 融合元素列表
                    result_image: '', // 结果图片
                    fusion_prompt: '', // 融合提示词
                    end_frame_image: '', // 尾帧视频
                    end_frame_prompt: '', // 尾帧提示词
                    video_url: '', // 融合视频
                    scene_description: '', // 场景说明 (新)
                    visual_description: '', // 画面描述 (新)
                    dialogue: '', // 对白 (新)
                    audio_description: '', // 声音描述 (新)
                },
                elementDialogVisible: false,
                elementForm: {
                    id: '',
                    name: '',
                    type: 'upload', // upload, generate, or character
                    prompt: '', // 生成提示词
                    image_url: '', // 元素图片URL
                    character_id: '' // 选中的角色 ID
                },
                currentFusion: null, // 当前正在编辑元素的融图任务对象
                generatingElement: false,
                // 融图批量弹框状态
                fusionBatchDialogVisible: false,
                fusionBatchConfig: { target: '', scope: 'all' },
                currentSeriesId: '',
                // 全局历史相关
                globalHistoryVisible: false,
                fullHistoryList: [], // 原始列表
                loadingHistory: false,
                historyFilterType: 'all',
                historySearch: '',
                visualAnalysisVisible: false,
                visualAnalysisImage: '', // 用于预览的URL
                visualAnalysisFile: null, // 实际的文件对象
                visualAnalysisResult: '', // 分析结果文本
                analyzingVisual: false,   // Loading状态
                // 任务中心相关数据
                taskDrawerVisible: false,
                taskList: [],
                taskPoller: null,
            },
            computed: {
                getModelsByProviderId() {
                    return (id) => {
                        const p = this.providers.find(x => x.id === id);
                        return (p && p.models) ? p.models : [];
                    };
                },
                availableImageModels() { return this.getModelsByProviderId(this.genOptions.imageProviderId).filter(m => m.type === 'image'); },
            availableFusionModels() { return this.getModelsByProviderId(this.genOptions.fusionProviderId).filter(m => m.type === 'image_fusion'); },
                availableVideoModels() { return this.getModelsByProviderId(this.genOptions.videoProviderId).filter(m => m.type === 'video'); },
                availableVoiceModels() { return this.getModelsByProviderId(this.genOptions.voiceProviderId).filter(m => m.type === 'audio'); },
                availableTextModels() { return this.getModelsByProviderId(this.genOptions.textProviderId).filter(m => m.type === 'text'); },
                selectedScriptCount() { return this.scriptSections.filter(s => s._checked).length; },
                
                currentProviderImageModels() { return this.availableImageModels; },
                currentProviderVideoModels() { return this.availableVideoModels; },
                currentProviderAudioModels() { return this.availableVoiceModels; },
                // 过滤列表逻辑
                filteredHistoryList() {
                    // 基础保护：如果列表尚未加载，返回空数组
                    if (!this.fullHistoryList) return [];

                    return this.fullHistoryList.filter(item => {
                        // 1. 类型过滤逻辑
                        if (this.historyFilterType !== 'all') {
                            // 特殊逻辑：选择"融图(fusion)"时，同时保留"元素(element)"类型
                            if (this.historyFilterType === 'fusion') {
                                if (item.entity_type !== 'fusion' && item.entity_type !== 'element') {
                                    return false;
                                }
                            } else {
                                // 其他情况（character, shot 等）严格匹配
                                if (item.entity_type !== this.historyFilterType) {
                                    return false;
                                }
                            }
                        }

                        // 2. 搜索过滤逻辑
                        if (this.historySearch && this.historySearch.trim()) {
                            const kw = this.historySearch.trim().toLowerCase();
                            
                            // 安全获取属性：如果没有名字或文件名，默认为空字符串，防止报错
                            const name = (item.entity_name || '').toLowerCase();
                            const filename = (item.filename || '').toLowerCase();
                            
                            // 只要名称或文件名包含关键词即可
                            return name.includes(kw) || filename.includes(kw);
                        }

                        return true;
                    });
                },
                // 正在进行的任务数量
                processingTaskCount() {
                    if (!this.taskList) return 0;
                    return this.taskList.filter(t => t.status === 'processing' || t.status === 'pending').length;
                },
            },
            mounted() {
                try {
                    const saved = localStorage.getItem('media_gen_options');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        // 合并数据，防止字段缺失
                        this.genOptions = { ...this.genOptions, ...parsed };
                    }
                } catch(e) { console.error(e); } 
                this.fetchSettings(); 
                // [新增] 优先从 URL 获取剧集 ID
                const urlParams = new URLSearchParams(window.location.search);
                const sid = urlParams.get('series_id');
                if (sid) {
                    this.currentSeriesId = sid;
                }
                this.fetchProjects().then(() => {
                    // [新增] 检查 URL 参数
                    const urlParams = new URLSearchParams(window.location.search);
                    const pid = urlParams.get('project_id');
                    if (pid) {
                        // 检查项目是否存在于列表中 (可选，因为列表可能只返回了所有项目)
                        const exists = this.projectList.find(p => p.id === pid);
                        if (exists) {
                            this.currentProjectId = pid;
                            this.handleProjectChange(pid);
                        } else {
                            // 如果项目列表只返回了部分项目，或者逻辑需要，可以单独获取项目详情
                            // 这里假设 list 返回了所有项目。如果没找到，可能是被删了或者权限问题
                            this.$message.warning('未找到指定的项目，加载默认项目');
                        }
                    }
                });
                // 启动任务轮询
                this.startTaskPoller();
            },
            // 监听 genOptions 变化并保存
            watch: {
                genOptions: {
                    handler(val) {
                        localStorage.setItem('media_gen_options', JSON.stringify(val));
                    },
                    deep: true
                }
            },
            methods: {
                async request(method, url, data = null, config = {}) {
                    try { const res = await axios({ method, url, data, ...config }); return res.data; } 
                    catch (err) { if (!axios.isCancel(err)) this.$message.error(err.response?.data?.error || '操作失败'); throw err; }
                },
                startGlobalLoading(title, subtext) { this.globalLoading = true; this.loadingTitle = title; this.loadingSubText = subtext; this.currentAbortController = new AbortController(); },
                stopGlobalLoading() { this.globalLoading = false; this.currentAbortController = null; },
                cancelGeneration() { if (this.currentAbortController) this.currentAbortController.abort(); this.stopGlobalLoading(); },
                getMissingCount(target) {
                    if(!this.shotList) return 0;
                    if(target === 'start_frame') return this.shotList.filter(s => !s.start_frame).length;
                    if(target === 'end_frame') return this.shotList.filter(s => !s.end_frame).length;
                    if(target === 'video') return this.shotList.filter(s => !s.video_url).length;
                    if (target === 'sequential_frames') {
                        // 顺序生成模式：统计实际需要生成的帧数
                        // 每个分镜最多需要生成2帧（首帧+尾帧）
                        let count = 0;
                        this.shotList.forEach(s => {
                            if (!s.start_frame)  {
                                count++; // 缺首帧
                                return;
                            }
                            if (!s.end_frame) { 
                                count++;    // 缺尾帧
                                return;
                            }
                        });
                        return count;
                    }
                    return 0;
                },

                toggleAllScripts(val) { this.scriptSections.forEach(s => this.$set(s, '_checked', val)); },
                deleteSelectedScripts() { this.$confirm('删除？').then(() => { this.scriptSections = this.scriptSections.filter(s => !s._checked); this.allScriptsSelected = false; this.saveScript(); }); },
                deleteAllScripts() { this.$confirm('清空？').then(() => { this.scriptSections = []; this.saveScript(); }); },
                handleSceneSelectionChange(val) { this.multipleSceneSelection = val; },
                async deleteSelectedShots() { this.$confirm('删除？').then(async () => { const ids = this.multipleShotSelection.map(s => s.id); await this.request('POST', `/api/projects/${this.currentProjectId}/shots/batch_delete`, { ids }); this.fetchShots(this.currentProjectId); }); },
                async deleteAllShots() { this.$confirm('清空？').then(async () => { const ids = this.shotList.map(s => s.id); if(ids.length) await this.request('POST', `/api/projects/${this.currentProjectId}/shots/batch_delete`, { ids }); this.fetchShots(this.currentProjectId); }); },

                handleTabClick(tab) { 
                    // 确保在切换到场景列表标签页时也能加载数据
                    if (tab.name === "scenes" && this.currentProjectId) {
                        this.fetchShots(this.currentProjectId);
                    } else if (tab.name === 'script') this.fetchScript(); 
                    else if (tab.name === 'shots') this.fetchShots(this.currentProjectId); 
                    else if (tab.name === 'characters') this.fetchCharacters();
                    else if (tab.name === 'image-fusion') this.fetchFusions(); 
                },
                initScriptSortable() {
                    const el = this.$refs.scriptListRef; if (!el || this.scriptSortable) return;
                    this.scriptSortable = Sortable.create(el, { animation: 150, handle: '.script-section-block', onEnd: (evt) => { const { oldIndex, newIndex } = evt; if (oldIndex === newIndex) return; const item = this.scriptSections.splice(oldIndex, 1)[0]; this.scriptSections.splice(newIndex, 0, item); this.saveScript(); } });
                },
                async fetchScript() { if (!this.currentProjectId) return; try { const res = await this.request('GET', `/api/projects/${this.currentProjectId}/script`); this.scriptSections = res.length ? res : [{ content: '' }]; this.$nextTick(() => this.initScriptSortable()); } catch (e) {} },
                async saveScript() { if (!this.currentProjectId) return; const cleanData = this.scriptSections.map(({_checked, ...rest}) => rest); await this.request('POST', `/api/projects/${this.currentProjectId}/script`, cleanData); },
                addScriptSection() { this.scriptSections.push({ content: '' }); this.saveScript(); },
                removeScriptSection(idx) { this.$confirm('删除？').then(() => { this.scriptSections.splice(idx, 1); this.saveScript(); }); },
                
                async generateScriptContinuation(index) {
                    this.startGlobalLoading('AI 续写中...', '请稍候');
                    try {
                        const ctx = this.scriptSections.slice(Math.max(0, index - 2), index + 1).map(s => s.content).join('\n');
                        const pid = this.genOptions.textProviderId;
                        const model = this.genOptions.textModelName;
                        if (!pid || !model) { throw new Error("请先在顶部选择文本模型"); }
                        
                        const res = await this.request('POST', '/api/generate/script_continuation', { context_text: ctx, project_info: this.currentProject, provider_id: pid, model_name: model }, { signal: this.currentAbortController.signal });
                        this.scriptSections.splice(index + 1, 0, { content: res.content }); this.saveScript();
                    } catch (e) { if (e.message !== '已取消') console.error(e); } finally { this.stopGlobalLoading(); }
                },
                async convertScriptToShot(section, index) {
                    this.startGlobalLoading('剧本转分镜...', '正在分析');
                    try {
                        const pid = this.genOptions.textProviderId;
                        const model = this.genOptions.textModelName;
                        if (!pid || !model) { throw new Error("请先在顶部选择文本模型"); }

                        const res = await this.request('POST', '/api/generate/analyze_script', { 
                            content: section.content, 
                            project_id: this.currentProjectId,
                            provider_id: pid, 
                            model_name: model 
                        }, { signal: this.currentAbortController.signal });
                        if(res.shots) { 
                            for(let s of res.shots) {
                                // 确保characters字段是数组
                                if (typeof s.characters === 'string') {
                                    s.characters = [s.characters];
                                }
                                await this.request('POST', `/api/projects/${this.currentProjectId}/shots`, { ...s, movie_id: this.currentProjectId }); 
                            }
                            this.$message.success(`生成 ${res.shots.length} 个分镜`); 
                        }
                    } catch(e) { if (e.message !== '已取消') console.error(e); } finally { this.stopGlobalLoading(); }
                },

                // 导出剪映
                async exportJianyingDraft() {
                    this.startGlobalLoading('导出剪映草稿...', '正在组装媒体资源');
                    try {
                        const response = await fetch(`/api/projects/${this.currentProjectId}/export/jianying`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({}) // 如果需要传参
                        });                        
                        if (response.ok) {
                            // 1. 获取 Blob 对象
                            const blob = await response.blob();
                            // 2. 创建临时下载链接
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            // 尝试从 header 获取文件名，或者自己定义
                            a.download = `project_${this.currentProjectId}_jianying.zip`; 
                            document.body.appendChild(a);
                            a.click();
                            // 3. 清理
                            window.URL.revokeObjectURL(url);
                            a.remove();
                        } else {
                            const err = await response.json();
                            alert('导出失败: ' + err.error);
                        }
                    } catch (e) {
                        if (e.message !== '已取消') console.error(e);
                    } finally {
                        this.stopGlobalLoading();
                    }
                },

                playAudio(url) { const audio = new Audio(url); audio.play().catch(e => this.$message.error('播放失败: ' + e.message)); },
                playVideo(row) { this.playerVideoUrl = row.video_url; this.videoPlayerVisible = true; },

                getProviderColor(type) {
                    if(type==='aliyun') return '#FF6A00';
                    if(type==='siliconflow') return '#7B68EE';
                    if(type==='vidu') return '#FF1493';
                    if(type==='zai') return '#5683EE';
                    if(type==='jimeng') return '#FF4500';
                    if(type==='comfyui') return '#3CB371';
                    if(type==='minimax') return '#FFD700';
                    return '#909399';
                },
                async fetchSettings() { try { const list = await this.request('GET', '/api/settings'); this.providers = list; if(list.length) { this.initDefaultSelections(); } } catch(e){} },
                openSettings() { this.fetchSettings(); this.settingsVisible = true; if(this.providers.length) this.selectProvider(this.providers[0]); else this.initNewProvider(); },
                selectProvider(p) { this.editingProvider = JSON.parse(JSON.stringify(p)); },
                initNewProvider() { 
                    this.editingProvider = { 
                        id: '', 
                        name: 'New Provider', 
                        type: 'aliyun', 
                        base_url: '', 
                        api_key: '', 
                        enabled: true, 
                        models: [ ] 
                    }; 
                },
                addModelToProvider() { if(!this.editingProvider.models) this.$set(this.editingProvider, 'models', []); this.editingProvider.models.push({ name: '', type: 'image', path: '' }); },
                removeModelFromProvider(idx) { this.editingProvider.models.splice(idx, 1); },
                
                async saveCurrentProvider() {
                    if(!this.editingProvider.name) return this.$message.warning("名称必填");
                    try {
                        const res = await this.request('POST', '/api/settings/provider', this.editingProvider);
                        if(res.success) { 
                            this.$message.success("保存成功"); 
                            this.fetchSettings(); 
                            if(!this.editingProvider.id && res.id) { this.editingProvider.id = res.id; } 
                        } else {
                            this.$message.error("保存失败");
                        }
                    } catch(e) {
                         // request wrapper already shows error, but we can add extra logic here
                    }
                },
                
                async deleteCurrentProvider() { if(!this.editingProvider.id) return; await this.request('DELETE', `/api/settings/provider/${this.editingProvider.id}`); this.fetchSettings(); this.editingProvider=null; },
                
                // Initialize default selections when providers load
                initDefaultSelections() {
                    const findP = (t) => { for(const p of this.providers) if(p.models && p.models.some(m => m.type === t)) return p.id; return this.providers[0]?.id || ''; };
                    if(!this.genOptions.imageProviderId) this.genOptions.imageProviderId = findP('image');
                    if(!this.genOptions.videoProviderId) this.genOptions.videoProviderId = findP('video');
                    if(!this.genOptions.voiceProviderId) this.genOptions.voiceProviderId = findP('audio');
                    if(!this.genOptions.textProviderId) this.genOptions.textProviderId = findP('text');
                    if(!this.genOptions.fusionProviderId) this.genOptions.fusionProviderId = findP('image_fusion');
                    
                    this.updateImageModelDefault();
                    this.updateVideoModelDefault();
                    this.updateVoiceModelDefault();
                    this.updateTextModelDefault();
                    this.updateFusionModelDefault();
                },
                
// [修改] 优化模型默认值逻辑：仅当当前值无效时才重置
                updateImageModelDefault() { 
                    const m = this.availableImageModels; 
                    const curr = this.genOptions.imageModelName;
                    if(m.length) { 
                        // 如果当前为空，或者当前选的值不在列表中，则选第一个
                        if (!curr || !m.some(x => x.name === curr)) this.genOptions.imageModelName = m[0].name; 
                    } else { 
                        this.genOptions.imageModelName = ''; 
                    } 
                },
                updateVideoModelDefault() { 
                    const m = this.availableVideoModels; 
                    const curr = this.genOptions.videoModelName;
                    if(m.length) {
                        if (!curr || !m.some(x => x.name === curr)) this.genOptions.videoModelName = m[0].name; 
                    } else { 
                        this.genOptions.videoModelName = ''; 
                    } 
                },
                updateVoiceModelDefault() { 
                    const m = this.availableVoiceModels; 
                    const curr = this.genOptions.voiceModelName;
                    if(m.length) {
                        if (!curr || !m.some(x => x.name === curr)) this.genOptions.voiceModelName = m[0].name; 
                    } else { 
                        this.genOptions.voiceModelName = ''; 
                    } 
                },
                updateTextModelDefault() { 
                    const m = this.availableTextModels; 
                    const curr = this.genOptions.textModelName;
                    if(m.length) {
                        if (!curr || !m.some(x => x.name === curr)) this.genOptions.textModelName = m[0].name; 
                    } else { 
                        this.genOptions.textModelName = ''; 
                    } 
                },
                updateFusionModelDefault() { 
                    const m = this.availableFusionModels; 
                    const curr = this.genOptions.fusionModelName;
                    if(m.length) {
                        if (!curr || !m.some(x => x.name === curr)) this.genOptions.fusionModelName = m[0].name; 
                    } else { 
                        this.genOptions.fusionModelName = ''; 
                    } 
                },
                handleProviderChange() { this.initDefaultSelections(); },

                async fetchProjects() { 
                    // [修改] 如果存在 currentSeriesId，则带上它
                    let url = `/api/projects`;
                    if (this.currentSeriesId) {
                        url += `?series_id=${this.currentSeriesId}`;
                    }
                    const list = await this.request('GET', url); 
                    this.projectList = list; 
                    if(list.length && !this.currentProjectId) { 
                        this.currentProjectId = list[0].id; 
                        this.handleProjectChange(list[0].id); 
                    } 
                },
                async handleProjectChange(pid) { this.currentProject = this.projectList.find(p => p.id === pid); this.activeTab='characters'; this.fetchScript(); this.fetchCharacters(); this.fetchFusions(); },
                openCreateProject() { 
                    this.projectForm = { 
                        film_name: '',
                        script_core_conflict: this.currentProject.script_core_conflict || '',
                        script_emotional_keywords: this.currentProject.script_emotional_keywords || '',
                        basic_info: this.currentProject.basic_info || '',
                        visual_color_system: this.currentProject.visual_color_system || '',
                        visual_consistency_prompt: this.currentProject.visual_consistency_prompt || '',
                        series_id: this.currentSeriesId
                    }; 
                    this.projectDialogVisible = true; 
                },
                openEditProject() { this.projectForm = JSON.parse(JSON.stringify(this.currentProject)); this.projectDialogVisible = true; },
                async submitProject() { if(!this.projectForm.film_name) return; const method = this.projectForm.id ? 'PUT' : 'POST'; const url = this.projectForm.id ? `/api/projects/${this.projectForm.id}` : '/api/projects'; const res = await this.request(method, url, this.projectForm); if(!this.projectForm.id) { this.projectList.unshift(res); this.currentProjectId=res.id; this.handleProjectChange(res.id); } else { const idx = this.projectList.findIndex(p=>p.id===res.id); this.$set(this.projectList, idx, res); this.currentProject=res; } this.projectDialogVisible = false; },
                async deleteProject() { await this.request('DELETE', `/api/projects/${this.currentProjectId}`); this.currentProject=null; this.currentProjectId=''; this.fetchProjects(); },
                
                async fetchShots(pid) { 
                    if(!pid) return; 
                    this.loadingShots = true; 
                    try { 
                        this.shotList = await this.request('GET', `/api/projects/${pid}/shots`);
                        //this.$nextTick(() => this.initShotSortable()); 
                    } finally { this.loadingShots = false; } 
                },
                editShot(row) { this.shotForm = JSON.parse(JSON.stringify(row)); this.videoUrl=row.video_url||''; this.shotDialogVisible = true; },
                async submitShot() { if(!this.shotForm.shot_number) return; if(this.videoUrl) this.shotForm.video_url = this.videoUrl; const method = this.shotForm.id ? 'PUT' : 'POST'; const url = this.shotForm.id ? `/api/projects/${this.currentProjectId}/shots/${this.shotForm.id}` : `/api/projects/${this.currentProjectId}/shots`; await this.request(method, url, this.shotForm); this.fetchShots(this.currentProjectId); this.shotDialogVisible = false; },
                async deleteShot(row) { await this.$confirm('确定删除该场景？此操作不可恢复。', '提示', { type: 'warning' }); await this.request('DELETE', `/api/projects/${this.currentProjectId}/shots/${row.id}`); this.fetchShots(this.currentProjectId); },
                removeImage() {}, previewImage(url) { this.previewUrl = url; this.previewVisible = true; },
                async fetchCharacters() {
                    if (!this.currentProjectId) return;
                    try {
                        this.characterList = await this.request('GET', `/api/projects/${this.currentProjectId}/characters`);
                    } catch (e) {
                        console.error(e);
                    }
                },

                openCreateCharacter() {
                    this.characterForm = {
                        name: '',
                        description: ''
                    };
                    this.characterDialogVisible = true;
                },

                async submitCharacter() {
                    if (!this.characterForm.name) {
                        this.$message.warning('请输入角色名称');
                        return;
                    }
                    try {
                        const res = await this.request('POST', `/api/projects/${this.currentProjectId}/characters`, this.characterForm);
                        this.characterList.push(res);
                        this.characterDialogVisible = false;
                        this.$message.success('角色创建成功');
                    } catch (e) {
                        console.error(e);
                    }
                },

                async generateCharacterView(character) {
                    try {
                        const res = await this.request('POST', '/api/async/generate/character_views', {
                            character_description: character.description,
                            character_id: character.id,
                            project_id: this.currentProjectId,
                            provider_id: this.genOptions.imageProviderId,
                            model_name: this.genOptions.imageModelName
                        });

                        if (res.success && res.status === 'queued') {
                            this.$message.success('角色生成任务已提交');
                            this.taskDrawerVisible = true;
                            this.fetchTasks();
                        }
                    } catch (e) {
                        console.error(e);
                        this.$message.error('提交失败');
                    }
                },

                getViewTitle(type) {
                    const titles = {
                        'portrait': '肖像',
                        'front_view': '正面',
                        'side_view': '侧面',
                        'back_view': '背面'
                    };
                    return titles[type] || type;
                },

                async deleteCharacter(id) {
                    try {
                        await this.$confirm('确定删除该角色？');
                        await this.request('DELETE', `/api/projects/${this.currentProjectId}/characters/${id}`);
                        this.characterList = this.characterList.filter(c => c.id !== id);
                        this.$message.success('删除成功');
                    } catch (e) {
                        if (e !== 'cancel') console.error(e);
                    }
                },
                // 场景批量删除方法
                async deleteSelectedScenes() { 
                    this.$confirm('删除？').then(async () => { 
                        const ids = this.multipleSceneSelection.map(s => s.id); 
                        await this.request('POST', `/api/projects/${this.currentProjectId}/shots/batch_delete`, { ids }); 
                        this.fetchShots(this.currentProjectId); 
                    }); 
                },
                async deleteAllScenes() { 
                    this.$confirm('清空？').then(async () => { 
                        const ids = this.shotList.map(s => s.id); 
                        if(ids.length) await this.request('POST', `/api/projects/${this.currentProjectId}/shots/batch_delete`, { ids }); 
                        this.fetchShots(this.currentProjectId); 
                    }); 
                },
                
                // 生成场景提示词
                async generateScenePrompt(shot) {
                    if (!shot.scene_description) {
                        this.$message.warning('请先填写场景说明');
                        return;
                    }
                    if (!this.genOptions.textProviderId) {
                        this.$message.warning('请先选择文本生成模型');
                        return;
                    }

                    // 改为异步调用
                    try {
                        const res = await this.request('POST', '/api/async/generate/scene_prompt', {
                            scene_description: shot.scene_description,
                            project_id: this.currentProjectId,
                            scene_id: shot.id, // 确保传 ID
                            provider_id: this.genOptions.textProviderId,
                            model_name: this.genOptions.textModelName
                        });
                        
                        if (res.success && res.status === 'queued') {
                            this.$message.success('提示词生成任务已提交');
                            this.taskDrawerVisible = true;
                            this.fetchTasks();
                        }
                    } catch(e) {
                        console.error(e);
                        this.$message.error('提交失败');
                    }
                },
                
                // 批量生成场景提示词
                async batchGenerateScenePrompts() {
                    if (!this.genOptions.textProviderId) return this.$message.warning('请先选择文本生成模型');
                        
                    // 筛选：有描述 但 没提示词 的场景
                    const tasks = this.shotList.filter(s => s.scene_description && (!s.scene_prompt || s.scene_prompt.trim() === ''));
                    
                    if (tasks.length === 0) return this.$message.info('没有需要生成的任务');
                    
                    let submittedCount = 0;
                    // 批量提交
                    for (const shot of tasks) {
                        try {
                            const res = await this.request('POST', '/api/async/generate/scene_prompt', {
                                scene_description: shot.scene_description,
                                project_id: this.currentProjectId,
                                scene_id: shot.id,
                                provider_id: this.genOptions.textProviderId,
                                model_name: this.genOptions.textModelName
                            });
                            if (res.success) submittedCount++;
                        } catch (e) { console.error(e); }
                    }
                    
                    if (submittedCount > 0) {
                        this.$message.success(`已提交 ${submittedCount} 个提示词任务`);
                        this.taskDrawerVisible = true;
                        this.fetchTasks();
                    }
                },
                
                // 场景相关方法（操作分镜数据）
                openCreateScene() {
                    this.currentInsertIndex = -1; // 重置插入位置
                    this.sceneForm = {
                        scene: '',
                        shot_number: '',
                        scene_description: '',
                        scene_prompt: '',
                        scene_image: '',
                        characters: []
                    };
                    this.sceneDialogTitle = '添加场景';
                    this.sceneDialogVisible = true;
                },
                openEditScene(shot) {
                    // 深拷贝数据
                    this.sceneForm = JSON.parse(JSON.stringify(shot));
                    
                    // [新增] 检查 characters 里的数据格式
                    // 如果表格里存的是对象 [{id:1, name:'A'}], 需要转换成 ID 数组 [1] 给 el-select 回显
                    if (this.sceneForm.characters && this.sceneForm.characters.length > 0) {
                        if (typeof this.sceneForm.characters[0] === 'object') {
                            this.sceneForm.characters = this.sceneForm.characters.map(c => c.id);
                        }
                    }
                    
                    this.sceneDialogTitle = '编辑场景';
                    this.sceneDialogVisible = true;
                },
                // 新增 insertScene 方法
                insertScene(index) {
                    this.openCreateScene();
                    this.currentInsertIndex = index + 1; // 记录要在哪一行之后插入
                    this.sceneDialogTitle = '插入新场景';
                },
                async submitScene() {
                    if(!this.sceneForm.scene || !this.sceneForm.shot_number) {
                        this.$message.error('请输入场次和场景编号');
                        return;
                    }

                    // [新增] 1. 预先根据选中的ID，从全局角色列表中找到对应的完整角色对象
                    // 这样是为了确保更新到表格时，能立即显示出人名，而不需要刷新页面
                    const selectedCharObjects = this.characterList.filter(c => 
                        this.sceneForm.characters.includes(c.id)
                    );

                    // 更新分镜数据
                    const idx = this.shotList.findIndex(s => s.id === this.sceneForm.id);
                    
                    if(idx !== -1) {
                        // === 编辑模式 ===
                        const updatedShot = { ...this.shotList[idx], ...this.sceneForm };
                        
                        // [新增] 2. 强制将 UI 数据中的 characters 替换为对象数组
                        updatedShot.characters = selectedCharObjects;

                        await this.request('PUT', `/api/projects/${this.currentProjectId}/shots/${updatedShot.id}`, updatedShot);
                        this.$set(this.shotList, idx, updatedShot);
                    } else {
                        // === 新建模式 ===
                        const newShot = {
                            movie_id: this.currentProjectId,
                            ...this.sceneForm,
                            visual_description: '',
                            insert_index: this.currentInsertIndex > -1 ? this.currentInsertIndex : undefined 
                        };
                        
                        // 发送给后端（后端通常只需要ID列表，或者能处理ID列表）
                        const res = await this.request('POST', `/api/projects/${this.currentProjectId}/shots`, newShot);
                        
                        // [新增] 3. 后端返回的数据可能 characters 只是 ID 或者是空的
                        // 我们手动把前端已知的角色对象填进去，保证列表立刻显示名字
                        if (res) {
                            res.characters = selectedCharObjects;
                        }

                        if (this.currentInsertIndex > -1) {
                            this.shotList.splice(this.currentInsertIndex, 0, res); 
                        } else {
                            this.shotList.push(res);
                        }
                    }
                    this.sceneDialogVisible = false;
                },
                async generateSceneImage(shot, updateForm = false) {
                    if(!shot.scene_prompt) {
                        this.$message.error('请先设置场景提示词');
                        return;
                    }
                    try {
                        const res = await this.request('POST', '/api/async/generate/scene_image', {
                            scene_id: shot.id,
                            project_id: this.currentProjectId,
                            scene_prompt: shot.scene_prompt,
                            provider_id: this.genOptions.imageProviderId,
                            model_name: this.genOptions.imageModelName
                        });

                        if (res.success && res.status === 'queued') {
                            this.$message.success('场景图任务已提交后台');
                            this.taskDrawerVisible = true;
                            this.fetchTasks();
                        }
                    } catch(e) {
                        console.error(e);
                        this.$message.error('提交失败');
                    }
                },
                handleSceneImageSuccess(res) {
                    if(res.success) {
                        this.sceneForm.scene_image = res.url;
                    } else {
                        this.$message.error(res.error || '上传失败');
                    }
                },
                handleSceneImageUploadSuccess(res, scene) {
                    if(res.success) {
                        // 更新分镜数据中的场景图片
                        this.request('PUT', `/api/projects/${this.currentProjectId}/shots/${scene.id}`, {
                            scene_image: res.url
                        }).then(() => {
                            const idx = this.shotList.findIndex(s => s.id === scene.id);
                            if (idx !== -1) {
                                this.$set(this.shotList, idx, { ...this.shotList[idx], scene_image: res.url });
                            }
                            this.$message.success('场景图片上传成功');
                        }).catch(e => {
                            console.error(e);
                            this.$message.error('更新场景图片失败');
                        });
                    } else {
                        this.$message.error(res.error || '图片上传失败');
                    }
                },
                // 处理场景编辑对话框中的图片上传
                handleSceneImageUpload() {
                    // 确保场景已保存，有ID
                    if (!this.sceneForm.id) {
                        this.$message.warning('请先保存场景信息');
                        return;
                    }

                    // 调用原有的上传函数，传入updateForm=true参数以更新表单
                    this.uploadSceneImage(this.sceneForm, true);
                },
                // 处理场景编辑对话框中的图片生成
                handleSceneImageGenerate() {
                    // 确保场景已保存，有ID
                    if (!this.sceneForm.id) {
                        this.$message.warning('请先保存场景信息');
                        return;
                    }

                    // 调用原有的生成函数，传入updateForm=true参数以更新表单
                    this.generateSceneImage(this.sceneForm, true);
                },
                // 编辑角色描述
                editCharacterDescription(char) {
                    // 设置编辑状态
                    this.$set(char, '_editing', true);
                    // 保存当前描述作为临时值
                    this.$set(char, '_tempDescription', char.description || '');
                },
                // 取消编辑角色描述
                cancelEditCharacterDescription(char) {
                    // 取消编辑状态
                    this.$set(char, '_editing', false);
                    // 删除临时值
                    this.$delete(char, '_tempDescription');
                },
                // 保存角色描述
                async saveCharacterDescription(char) {
                    try {
                        // 更新角色描述
                        await this.request('PUT', `/api/projects/${this.currentProjectId}/characters/${char.id}`, {
                            description: char._tempDescription
                        });

                        // 更新本地数据
                        char.description = char._tempDescription;

                        // 取消编辑状态
                        this.$set(char, '_editing', false);

                        // 删除临时值
                        this.$delete(char, '_tempDescription');

                        this.$message.success('角色描述已更新');
                    } catch (e) {
                        console.error(e);
                        this.$message.error('更新角色描述失败');
                    }
                },
                getCharacterName(id) {
                    const char = this.characterList.find(c => c.id === id);
                    return char ? char.name : '未知角色';
                },
                getCharacterImage(id) {
                    const char = this.characterList.find(c => c.id === id);
                    return char ? char.image_url : null;
                },

                // 根据人物设定字段生成角色列表
                async generateCharactersFromPrompt() {
                    if (!this.currentProject || !this.currentProject.visual_consistency_prompt) {
                        this.$message.warning('请先在项目设置中填写人物设定');
                        return;
                    }
                    
                    if (!this.genOptions.textProviderId || !this.genOptions.textModelName) {
                        this.$message.warning('请先选择文本模型');
                        return;
                    }
                    
                    this.startGlobalLoading('生成角色列表...', '请稍候');
                    try {
                        const res = await this.request('POST', '/api/generate/character_list', {
                            visual_consistency_prompt: this.currentProject.visual_consistency_prompt,
                            provider_id: this.genOptions.textProviderId,
                            model_name: this.genOptions.textModelName
                        });
                        
                        if (res.success && res.characters) {
                            for (const char of res.characters) {
                                const charData = await this.request('POST', `/api/projects/${this.currentProjectId}/characters`, char);
                                this.characterList.push(charData);
                            }
                            this.$message.success(`成功生成 ${res.characters.length} 个角色`);
                        } else {
                            this.$message.error('生成角色列表失败');
                        }
                    } catch (e) {
                        console.error(e);
                        this.$message.error('生成角色列表失败');
                    } finally {
                        this.stopGlobalLoading();
                    }
                },

                // 图片上传前检查
                beforeImageUpload(file) {
                    const isImage = file.type.indexOf('image/') === 0;
                    const isLt5M = file.size / 1024 / 1024 < 5;
                    
                    if (!isImage) {
                        this.$message.error('只能上传图片文件!');
                        return false;
                    }
                    if (!isLt5M) {
                        this.$message.error('图片大小不能超过 5MB!');
                        return false;
                    }
                    return true;
                },

                // 图片上传成功处理
                async handleImageUploadSuccess(res, character) {
                    if (res.success) {
                        const charIndex = this.characterList.findIndex(c => c.id === character.id);
                        if (charIndex !== -1) {
                            this.$set(this.characterList[charIndex], 'image_url', res.url);
                            await this.request('PUT', `/api/projects/${this.currentProjectId}/characters/${character.id}`, {
                                image_url: res.url
                            });
                            this.$message.success('图片上传成功');
                        }
                    } else {
                        this.$message.error(res.error || '图片上传失败');
                    }
                },

                // 替换角色图片
                uploadCharacterImage(character) {
                    // 创建一个隐藏的文件输入元素
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        if (!this.beforeImageUpload(file)) return;
                        
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('character_id', character.id);
                        
                        try {
                            this.startGlobalLoading('上传图片...', '请稍候');
                            const res = await this.request('POST', '/api/upload/character_image', formData, {
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                }
                            });
                            
                            await this.handleImageUploadSuccess(res, character);
                        } catch (e) {
                            console.error(e);
                            this.$message.error('图片上传失败');
                        } finally {
                            this.stopGlobalLoading();
                        }
                    };
                    input.click();
                },
                // 上传场景图片
                uploadSceneImage(scene, updateForm = false) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        if (!this.beforeImageUpload(file)) return;

                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('scene_id', scene.id);

                        try {
                            this.startGlobalLoading('上传图片...', '请稍候');

                            const res = await this.request('POST', '/api/upload/scene_image', formData, {
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                }
                            });

                            if (res.success) {
                                // 如果需要更新表单，则更新表单中的图片
                                if (updateForm && this.sceneForm && this.sceneForm.id === scene.id) {
                                    this.sceneForm.scene_image = res.url;
                                }

                                // 更新场景图片
                                await this.request('PUT', `/api/projects/${this.currentProjectId}/shots/${scene.id}`, {
                                    scene_image: res.url
                                });

                                // 更新本地数据
                                const idx = this.shotList.findIndex(s => s.id === scene.id);
                                if (idx !== -1) {
                                    this.$set(this.shotList, idx, { ...this.shotList[idx], scene_image: res.url });
                                }

                                this.$message.success('场景图片上传成功');
                            } else {
                                this.$message.error(res.error || '图片上传失败');
                            }
                        } catch (e) {
                            console.error('Upload error:', e);
                            this.$message.error('图片上传失败: ' + (e.response?.data?.error || e.message));
                        } finally {
                            this.stopGlobalLoading();
                        }
                    };
                    input.click();
                },

                // 批量生成场景图片
                async batchGenerateSceneImages() {
                    // 逻辑复用原有筛选
                    if (!this.genOptions.imageProviderId) {
                        this.$message.warning('请先选择图片生成模型');
                        return;
                    }

                    // 筛选没有图片的场景
                    const tasks = this.shotList.filter(s => !s.scene_image && s.scene_prompt);
                    
                    if (tasks.length === 0) {
                        this.$message.info('没有需要生成的场景（或缺少提示词）');
                        return;
                    }

                    let submittedCount = 0;

                    for (const shot of tasks) {
                        try {
                            const res = await this.request('POST', '/api/async/generate/scene_image', {
                                scene_id: shot.id,
                                project_id: this.currentProjectId,
                                scene_prompt: shot.scene_prompt,
                                provider_id: this.genOptions.imageProviderId,
                                model_name: this.genOptions.imageModelName
                            });

                            if (res.success && res.status === 'queued') {
                                submittedCount++;
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    }

                    if (submittedCount > 0) {
                        this.$message.success(`已提交 ${submittedCount} 个场景图任务`);
                        this.taskDrawerVisible = true;
                        this.fetchTasks();
                    }
                },
// --- 融图功能方法 ---
                async fetchFusions() {
                    if (!this.currentProjectId) return;
                    this.loadingFusions = true;
                    try { 
                        this.fetchShots(this.currentProjectId);
                        // 从后端获取融图任务列表
                        this.fusionList = await this.request('GET', `/api/projects/${this.currentProjectId}/fusions`) || []; 
                        // 确保每个融图任务都有场景说明和分镜描述
                        /*for (let i = 0; i < this.fusionList.length; i++) {
                            const fusion = this.fusionList[i];
                            if (!fusion.scene_description && fusion.shot_id) {
                                // 尝试从分镜列表中获取对应的数据
                                const shot = this.shotList.find(s => s.id === fusion.shot_id);
                                if (shot) {
                                    this.$set(fusion, 'scene_description', shot.scene_description || shot.description || '');
                                    this.$set(fusion, 'visual_description', shot.visual_description || shot.description || '');
                                    this.$set(fusion, 'dialogue', shot.dialogue || shot.dialogue || '');
                                    this.$set(fusion, 'audio_description', shot.audio_description || shot.audio_description || '');
                                }
                            }
                        }*/
                    } catch (e) {
                        console.error(e);
                        this.fusionList = [];
                    } finally { 
                        this.loadingFusions = false; 
                    }
                },
                
                openCreateFusion() {
                    this.currentInsertIndex = -1; // 重置
                    this.fusionForm = { 
                        id: '', 
                        scene: '', 
                        shot_number: '', 
                        base_image: '', 
                        fusion_prompt: '', 
                        result_image: '', 
                        end_frame_image: '', // 尾帧图片
                        end_frame_prompt: '', // 尾帧提示词
                        elements: [],
                        scene_description: '',
                        visual_description: '',
                        dialogue: '',
                        audio_description: '',
                        video_url: ''
                    };
                    this.fusionDialogTitle = '新建融图任务';
                    this.fusionDialogVisible = true;
                },
                // 新增 insertFusion 方法
                insertFusion(index) {
                    this.openCreateFusion();
                    this.currentInsertIndex = index + 1;
                    this.fusionDialogTitle = '插入融图任务';
                },
                editFusion(row) {
                    const formData = JSON.parse(JSON.stringify(row));
                    /*
                    if (!formData.scene_description && formData.shot_id) {
                        // 尝试从分镜列表中获取对应的数据
                        const shot = this.shotList.find(s => s.id === formData.shot_id);
                        if (shot) {
                            formData.scene_description = shot.scene_description || shot.description || '';
                            formData.visual_description = shot.visual_description || shot.description || '';
                            formData.dialogue = shot.dialogue || '';
                            formData.audio_description = shot.audio_description || shot.description || '';
                        }
                    }*/
                    this.fusionForm = formData;
                    this.fusionDialogTitle = '编辑融图任务';
                    this.fusionDialogVisible = true;
                },
                
                async saveFusion() {
                    if (!this.currentProjectId) return this.$message.error("未选择项目");
                    
                    // 调用 saveFusionData 来处理 POST (创建) 或 PUT (更新)
                    await this.saveFusionData(this.fusionForm);
                    
                    this.fusionDialogVisible = false;
                    this.$message.success('任务保存成功');
                },
                
                async deleteFusion(row) {
                    await this.$confirm('确认删除?');
                    await this.request('DELETE', `/api/projects/${this.currentProjectId}/fusions/${row.id}`);
                    this.fetchFusions(); // 重新获取列表
                },
                
                handleFusionSelectionChange(val) { 
                    this.multipleFusionSelection = val; 
                },
                
                async deleteSelectedFusions() {
                     await this.$confirm(`删除选中的 ${this.multipleFusionSelection.length} 项?`);
                     for(let f of this.multipleFusionSelection) {
                         await this.request('DELETE', `/api/projects/${this.currentProjectId}/fusions/${f.id}`);
                     }
                     this.fetchFusions();
                },
                
                // 图片上传相关
                triggerBaseUpload() { 
                    if(this.$refs.baseUploadInput) this.$refs.baseUploadInput.click(); 
                },
                
                async handleBaseUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const fd = new FormData(); 
                    fd.append('file', file);
                    fd.append('fusion_id', this.fusionForm.id);
                    try {
                        this.startGlobalLoading('上传中...', '正在上传底图');
                        // 修改处：使用 this.request，移除 res.data 层级
                        const res = await this.request('POST', '/api/upload/base_image', fd);
                        if (res.success) {
                            this.fusionForm.base_image = res.url;
                            this.$message.success('上传成功');
                            // 自动保存，确保 base_image 持久化
                            if (this.fusionForm.id) {
                                await this.saveFusionData(this.fusionForm);
                            }
                        }
                    } catch(e) { 
                        // request 方法会自动提示错误，这里也可以保留或者仅做清理
                        if (e.message !== '操作失败') this.$message.error('上传失败'); 
                    } finally {
                        this.stopGlobalLoading();
                        // 清空 input value 允许重复上传同一文件
                        e.target.value = '';
                    }
                },

                // --- 修改后的核心生成接口调用 ---
                async generateFusionImage(row) {
                    // 兼容逻辑：如果是从弹窗调用，row 是 Event，目标是 this.fusionForm
                    // 如果是从列表调用，row 是数据对象
                    const target = (row && row.id) ? row : this.fusionForm;
                    
                    if (!target.base_image) return this.$message.warning('请先设置底图');
                    if (!target.fusion_prompt) return this.$message.warning('请填写提示词');
                    
                    // 如果是新建任务还没保存，提示先保存
                    if (!target.id) {
                        return this.$message.warning('请先保存任务再生成');
                    }
                    
                    // 异步调用
                    try {
                        const res = await this.request('POST', '/api/async/generate/fusion_image', {
                            fusion_id: target.id,
                            project_id: this.currentProjectId,
                            fusion_prompt: target.fusion_prompt,
                            provider_id: this.genOptions.fusionProviderId,
                            model_name: this.genOptions.fusionModelName,
                            // 传递额外参数判断是否是尾帧 (如果复用此函数)
                            // 这里假设你调用时会根据上下文区分，或者通过 target 区分
                            // 目前后端逻辑主要看 data 中是否有 end_frame_prompt，这里简单传通用参数
                        });
                        
                        if (res.success && res.status === 'queued') {
                            this.$message.success('融图任务已提交后台');
                            this.taskDrawerVisible = true; // 自动展开任务面板
                            this.fetchTasks();
                        }
                    } catch (e) {
                        console.error(e);
                        this.$message.error('提交失败');
                    }
                },
                // 从场景列表复制数据
                async copyFromScenes() {
                    // 先尝试获取场景数据
                    if (!this.shotList || this.shotList.length === 0) {
                        await this.fetchShots(this.currentProjectId);
                    }
                    if (!this.shotList || this.shotList.length === 0) {
                        this.$message.warning('场景列表为空，无法复制');
                        return;
                    }
                    
                    // 确保获取角色列表
                    if (!this.characterList || this.characterList.length === 0) {
                        console.log('获取角色数据...');
                        await this.fetchCharacters();
                    }
                    
                    // 调试输出
                    console.log(`场景数量: ${this.shotList.length}`);
                    console.log(`角色数量: ${this.characterList.length}`);
                    console.log('角色列表:', this.characterList.map(c => ({ id: c.id, name: c.name })));


                    this.$confirm('确定要从场景列表复制数据吗？这将覆盖当前的融图任务列表。', '确认操作', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(async () => {
                        this.startGlobalLoading('正在复制场景任务...', '请稍候');
                        try {
                            const newFusions = [];
                            for (const shot of this.shotList) {
                                // 获取场景中的角色图片作为元素
                                const elements = shot.characters;
                                // 创建融图任务对象
                                const tempFusion = {
                                    scene: shot.scene || '',
                                    shot_number: shot.shot_number || '',
                                    shot_id: shot.id,
                                    base_image: shot.scene_image || '',
                                    elements: elements,
                                    result_image: '',
                                    fusion_prompt: '',
                                    scene_description: shot.scene_description || '',
                                    visual_description: shot.visual_description || '',
                                    dialogue: shot.dialogue || '',
                                    audio_description: shot.audio_description || '',
                                };
                                
                                // 调用 POST 接口创建任务并获取完整数据（包含ID）
                                const res = await this.request('POST', `/api/projects/${this.currentProjectId}/fusions`, tempFusion);
                                
                                // 确保响应数据包含必要字段
                                if (res) {
                                    /*
                                    // 设置场景说明和分镜描述
                                    res.scene_description = shot.scene_description || shot.description || '',
                                    res.visual_description = shot.visual_description || shot.description || '',
                                    res.dialogue = shot.dialogue || '',
                                    res.audio_description = shot.audio_description || ''
                                    */
                                
                                    newFusions.push(res);
                                }
                            }

                            this.fusionList = newFusions;
                            this.$message.success(`已从场景列表复制 ${newFusions.length} 个任务`);
                        } catch (e) {
                            this.$message.error('复制失败');
                            console.error('Copy from scenes failed:', e);
                        } finally {
                            this.stopGlobalLoading();
                        }
                    }).catch(() => {
                        // 用户取消操作
                    });
                },
                // 添加融图功能的场景元素
                addElement(fusion) {
                    this.elementForm = {
                        id: '',
                        name: '',
                        type: 'upload', // upload, generate, or character
                        prompt: '', // 生成提示词
                        image_url: '', // 元素图片URL
                        character_id: '' // 选中的角色 ID
                    };
                    this.currentFusion = fusion;
                    this.elementDialogVisible = true;
                },

                // 删除融图功能的场景元素
                removeElement(fusion, element) {
                    fusion.elements = fusion.elements.filter(el => el.id !== element.id);
                    // 保存更新
                    this.saveFusionData(fusion);
                },

                // 保存融图功能的场景融图数据 (通用保存函数)
                async saveFusionData(fusion) {
                    try {
                        // 备份瞬态字段
                        /*const transientFields = {
                            scene_description: fusion.scene_description || '',
                            visual_description: fusion.visual_description || '',
                            dialogue: fusion.dialogue || '',
                            audio_description: fusion.audio_description || ''
                        };*/

                        const method = fusion.id ? 'PUT' : 'POST';
                        const url = fusion.id 
                            ? `/api/projects/${this.currentProjectId}/fusions/${fusion.id}`
                            : `/api/projects/${this.currentProjectId}/fusions`;

                        // 如果是新建且有插入位置，添加到 payload
                        if (!fusion.id && this.currentInsertIndex > -1) {
                            fusion.insert_index = this.currentInsertIndex;
                        }

                        const res = await this.request(method, url, fusion);
                        
                        // 合并结果
                        const mergedResult = res;

                        if (method === 'POST') {
                            fusion.id = res.id;
                            if (this.currentInsertIndex > -1) {
                                this.fusionList.splice(this.currentInsertIndex, 0, mergedResult); // 前端插入
                                this.currentInsertIndex = -1; // 重置
                            } else {
                                this.fusionList.push(mergedResult);
                            }
                        } else {
                            const idx = this.fusionList.findIndex(f => f.id === fusion.id);
                            if (idx !== -1) {
                                this.$set(this.fusionList, idx, mergedResult);
                            }
                        }
                        
                        return mergedResult;

                    } catch (e) {
                        console.error(e);
                        this.$message.error('保存失败');
                        throw e;
                    }
                },
                // 处理融图任务中分镜选择的变化
                handleFusionShotChange(shotId) {
                    // 1. 如果用户点击了清除按钮（shotId 为空），则清空相关字段
                        if (!shotId) {
                            this.fusionForm.scene = '';
                            this.fusionForm.shot_number = '';
                            this.fusionForm.scene_description = '';
                            this.fusionForm.visual_description = '';
                            this.fusionForm.dialogue = '';
                            this.fusionForm.audio_description = '';
                            return;
                        }

                        // 2. 在 shotList 中查找对应的分镜对象
                        const targetShot = this.shotList.find(s => s.id === shotId);

                        if (targetShot) {
                            // === 第一步：无论如何，先更新文本元数据 ===
                            this.fusionForm.scene = targetShot.scene;
                            this.fusionForm.shot_number = targetShot.shot_number;
                            
                            // 自动回填描述信息
                            this.fusionForm.scene_description = targetShot.scene_description || '';
                            this.fusionForm.visual_description = targetShot.visual_description || '';
                            this.fusionForm.dialogue = targetShot.dialogue || '';
                            this.fusionForm.audio_description = targetShot.audio_description || '';

                            // === 第二步：检查是否有资源可更新 ===
                            const hasSceneImage = !!targetShot.scene_image;
                            const hasCharacters = targetShot.characters && targetShot.characters.length > 0;

                            // 如果分镜既没有场景图也没有角色，就不用弹窗问了
                            if (!hasSceneImage && !hasCharacters) {
                                return;
                            }

                            // === 第三步：弹窗询问用户 ===
                            let confirmText = '检测到该分镜包含';
                            if (hasSceneImage) confirmText += '【场景图片】';
                            if (hasSceneImage && hasCharacters) confirmText += '和';
                            if (hasCharacters) confirmText += '【关联角色】';
                            confirmText += '。\n\n是否直接将其覆盖到当前任务的“底图”和“元素”中？';

                            this.$confirm(confirmText, '同步资源确认', {
                                confirmButtonText: '覆盖更新',
                                cancelButtonText: '仅关联数据',
                                type: 'warning',
                                distinguishCancelAndClose: true // 区分点击取消按钮和点击关闭X
                            }).then(() => {
                                // === 用户选择“覆盖更新” ===
                                
                                // 1. 更新底图
                                if (hasSceneImage) {
                                    this.fusionForm.base_image = targetShot.scene_image;
                                }

                                // 2. 更新元素（深拷贝防止引用问题）
                                if (hasCharacters) {
                                    // 将角色转换为元素格式
                                    // 注意：原 shot.characters 可能包含 id, name, description, image_url
                                    // 融图元素通常需要 image_url 和 name
                                    const newElements = targetShot.characters.map(char => ({
                                        id: `element_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, // 生成新ID
                                        name: char.name,
                                        image_url: char.image_url,
                                        type: 'character',
                                        character_id: char.id // 关联原始角色ID
                                    }));
                                    
                                    this.$set(this.fusionForm, 'elements', newElements);
                                }

                                this.$message.success('已同步分镜的图片和角色数据');

                            }).catch((action) => {
                                // === 用户选择“仅关联数据”或关闭弹窗 ===
                                if (action === 'cancel') {
                                    this.$message.info('已保留当前任务原有的底图和元素');
                                }
                            });
                        }
                },
                // 处理元素图片上传
                async handleElementUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (!this.beforeImageUpload(file)) return;
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('element_id', this.elementForm.id)
                    
                    try {
                        this.generatingElement = true; // 使用 element loading indicator if available
                        this.startGlobalLoading('上传元素图片...', '请稍候');
                        
                        // 调用新的元素上传接口
                        const res = await this.request('POST', '/api/upload/element_image', formData, {
                            headers: { 'Content-Type': 'multipart/form-data' }
                        });

                        if (res.success) {
                            this.elementForm.image_url = res.url;
                            this.$message.success('上传成功');
                        } else {
                            this.$message.error(res.error || '上传失败');
                        }
                    } catch (e) {
                        console.error('Element upload error:', e);
                        this.$message.error('上传失败');
                    } finally {
                        this.generatingElement = false;
                        this.stopGlobalLoading();
                        e.target.value = '';
                    }
                },

                // 生成元素图片
                async generateElementImage() {
                    if (!this.elementForm.prompt) {
                        this.$message.warning('请输入生成提示词');
                        return;
                    }

                    this.generatingElement = true;
                    try {
                        // 调用新的元素生成接口
                        const res = await this.request('POST', '/api/generate/element_image', {
                            element_id: this.elementForm.id,
                            prompt: this.elementForm.prompt,
                            provider_id: this.genOptions.imageProviderId,
                            model_name: this.genOptions.imageModelName
                        });

                        if (res.success) {
                            this.elementForm.image_url = res.url;
                            this.$message.success('元素图片生成成功');
                        } else {
                            this.$message.error(res.error || '生成失败');
                        }
                    } catch (e) {
                        console.error(e);
                        this.$message.error('生成失败');
                    } finally {
                        this.generatingElement = false;
                    }
                },
                async generateFusionPrompt(fusion) {
                    // 1. 基础校验
                    if (!fusion.scene_description && !fusion.visual_description) {
                        this.$message.warning('缺少场景或分镜描述');
                        return;
                    }
                    if (!this.genOptions.textProviderId) {
                        this.$message.warning('请先选择文本模型');
                        return;
                    }

                    // 2. [保留逻辑] 构建素材映射字符串
                    let imgIndex = 1;
                    let mappingParts = [];
                    if (fusion.elements && fusion.elements.length > 0) {
                        fusion.elements.forEach(el => {
                            mappingParts.push(`图${imgIndex} (Image ${imgIndex}): ${el.name} [前景元素]`);
                            imgIndex++;
                        });
                    }
                    if (fusion.base_image) {
                        mappingParts.push(`图${imgIndex} (Image ${imgIndex}): 场景底图/背景 [Background]`);
                    } else {
                        mappingParts.push(`(未设置底图，请基于纯文本生成背景)`);
                    }
                    const elementMappingStr = mappingParts.join('\n');

                    // 3. 异步提交
                    try {
                        // 如果是新建未保存，先保存
                        if (!fusion.id) await this.saveFusionData(fusion);

                        const res = await this.request('POST', '/api/async/generate/fusion_prompt', {
                            id: fusion.id, // 传 ID
                            fusion_id: fusion.id, // 兼容性冗余
                            scene_description: fusion.scene_description || '',
                            shot_description: fusion.visual_description || '',
                            element_mapping: elementMappingStr, // 传构建好的字符串
                            project_id: this.currentProjectId,
                            provider_id: this.genOptions.textProviderId,
                            model_name: this.genOptions.textModelName
                        });

                        if (res.success && res.status === 'queued') {
                            this.$message.success('提示词生成任务已提交');
                            this.taskDrawerVisible = true;
                            this.fetchTasks();
                        }
                    } catch(e) {
                        console.error(e);
                        this.$message.error('提交失败');
                    }
                },
                async generateFusionEndFrameImage(row) {
                    const target = (row && row.id) ? row : this.fusionForm;
                    
                    if (!target.base_image) return this.$message.warning('请先设置底图');
                    if (!target.end_frame_prompt) return this.$message.warning('请填写尾帧提示词');
                    
                    if (!target.id) {
                        await this.saveFusionData(target);
                        row = target;
                    }
                    
                    this.startGlobalLoading('正在生成尾帧...', 'AI 正在根据尾帧提示词进行重绘...');
                    try {
                        // 复用融图接口，但传入尾帧提示词
                        const res = await this.request('POST', '/api/generate/fusion_image', {
                            fusion_id: target.id, 
                            project_id: this.currentProjectId, 
                            fusion_prompt: target.end_frame_prompt, // <--- 使用尾帧提示词
                            provider_id: this.genOptions.fusionProviderId,
                            model_name: this.genOptions.fusionModelName
                        });
                        
                        if (res.success) {
                            target.end_frame_image = res.url;
                            // 保存结果到 end_frame_image 字段
                            await this.request('PUT', `/api/projects/${this.currentProjectId}/fusions/${target.id}`, { end_frame_image: res.url });
                            
                            const idx = this.fusionList.findIndex(f => f.id === target.id);
                            if(idx !== -1) {
                                this.$set(this.fusionList, idx, { ...this.fusionList[idx], end_frame_image: res.url });
                            }
                            this.$message.success('尾帧生成成功！');
                        }
                    } catch (e) {
                        console.error(e);
                        this.$message.error('生成失败');
                    } finally {
                        this.stopGlobalLoading();
                    }
                },
                async handleStartFrameUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // 1. 准备上传参数
                    const fd = new FormData(); 
                    fd.append('file', file);
                    // 借用通用的图片上传接口，只要返回 url 即可
                    fd.append('fusion_id', this.fusionForm.id); 
                    
                    try {
                        this.startGlobalLoading('上传中...', '正在上传首帧图片');
                        // 修改处：使用 this.request，移除 res.data 层级
                        const res = await this.request('POST', '/api/upload/base_image', fd);
                        
                        if (res.success) {
                            // 2. 更新前端数据 (注意这里用 res.url 而不是 res.data.url)
                            this.fusionForm.result_image = res.url;
                            
                            // 3. 如果任务已存在，同步更新到后端数据库
                            if (this.fusionForm.id) {
                                await this.request('PUT', `/api/projects/${this.currentProjectId}/fusions/${this.fusionForm.id}`, { result_image: res.url });
                                
                                // 4. 同步更新列表视图
                                const idx = this.fusionList.findIndex(f => f.id === this.fusionForm.id);
                                if(idx !== -1) {
                                    this.$set(this.fusionList, idx, { ...this.fusionList[idx], result_image: res.url });
                                }
                            }
                            this.$message.success('首帧上传成功');
                        }
                    } catch(e) { 
                        if (e.message !== '操作失败') this.$message.error('上传失败'); 
                    } finally {
                        this.stopGlobalLoading();
                        e.target.value = ''; // 清空 input，允许重复上传同一文件
                    }
                },
                async handleEndFrameUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const fd = new FormData(); 
                    fd.append('file', file);
                    // 复用接口
                    fd.append('fusion_id', this.fusionForm.id); 
                    
                    try {
                        this.startGlobalLoading('上传中...', '正在上传图片');
                        // 修改处：使用 this.request，移除 res.data 层级
                        const res = await this.request('POST', '/api/upload/base_image', fd); 
                        
                        if (res.success) {
                            // 注意这里用 res.url 而不是 res.data.url
                            this.fusionForm.end_frame_image = res.url;
                            if (this.fusionForm.id) {
                                await this.request('PUT', `/api/projects/${this.currentProjectId}/fusions/${this.fusionForm.id}`, { end_frame_image: res.url });
                            }
                            this.$message.success('上传成功');
                        }
                    } catch(e) { 
                        if (e.message !== '操作失败') this.$message.error('上传失败'); 
                    } finally {
                        this.stopGlobalLoading();
                        e.target.value = '';
                    }
                },
                async batchGenerateFusionPrompts(tasks) {
                    if (!this.genOptions.textProviderId) return this.$message.warning('请先选择文本模型');
                        
                    // 筛选：没有提示词的任务
                    const validTasks = tasks.filter(f => !f.fusion_prompt || f.fusion_prompt.trim() === '');
                    if (validTasks.length === 0) return this.$message.info('选中的任务都已有提示词');

                    let submittedCount = 0;

                    for (const fusion of validTasks) {
                        try {
                            // 1. 确保有 ID
                            if (!fusion.id) await this.saveFusionData(fusion);
                            
                            // 2. [保留逻辑] 构建映射字符串
                            if (!fusion.scene_description && !fusion.visual_description) continue; // 跳过无描述的
                            
                            let imgIndex = 1;
                            let mappingParts = [];
                            if (fusion.elements) {
                                fusion.elements.forEach(el => {
                                    mappingParts.push(`图${imgIndex}: ${el.name}`);
                                    imgIndex++;
                                });
                            }
                            if (fusion.base_image) mappingParts.push(`图${imgIndex}: 底图`);
                            else mappingParts.push(`(无底图)`);
                            const str = mappingParts.join('\n');

                            // 3. 发送请求
                            const res = await this.request('POST', '/api/async/generate/fusion_prompt', {
                                id: fusion.id,
                                fusion_id: fusion.id,
                                scene_description: fusion.scene_description || '',
                                shot_description: fusion.visual_description || '',
                                element_mapping: str,
                                project_id: this.currentProjectId,
                                provider_id: this.genOptions.textProviderId,
                                model_name: this.genOptions.textModelName
                            });

                            if (res.success) submittedCount++;
                            
                        } catch (e) { console.error(e); }
                    }

                    if (submittedCount > 0) {
                        this.$message.success(`已提交 ${submittedCount} 个提示词任务`);
                        this.taskDrawerVisible = true;
                        this.fetchTasks();
                    }
                },
                // 批量生成融合图
                async batchGenerateFusionImages(tasks, type = 'start') {
                    // 1. 确定字段名称
                    const promptField = type === 'end' ? 'end_frame_prompt' : 'fusion_prompt';
                    const actionName = type === 'end' ? '尾帧' : '首帧';

                    // 2. 预检查
                    const validTasks = tasks.filter(f => f[promptField] && f[promptField].trim() !== '');
                    if (validTasks.length === 0) {
                        this.$message.warning(`没有符合条件的任务（缺少${actionName}提示词）`);
                        return;
                    }

                    if (!this.genOptions.fusionProviderId) {
                        this.$message.warning('请先选择图生图模型');
                        return;
                    }

                    // 3. 提交任务
                    // 注意：不再需要 GlobalLoading 遮罩，因为提交很快
                    let submittedCount = 0;
                    
                    // 我们使用 Promise.all 并发提交请求，或者简单的循环 await 也可以
                    // 因为后端现在返回非常快，循环 await 不会卡顿
                    for (const fusion of validTasks) {
                        // 如果是新建任务未保存，先保存以获取 ID (虽然批量操作通常是针对已保存的)
                        if (!fusion.id) await this.saveFusionData(fusion);

                        try {
                            const res = await this.request('POST', '/api/async/generate/fusion_image', {
                                fusion_id: fusion.id,
                                project_id: this.currentProjectId,
                                fusion_prompt: fusion[promptField],
                                provider_id: this.genOptions.fusionProviderId,
                                model_name: this.genOptions.fusionModelName,
                                // 这里需要后端 async_fusion_image 支持 end_frame_prompt 参数判断
                                // 或者我们在参数里显式带上 type
                                end_frame_prompt: type === 'end' ? fusion[promptField] : undefined
                            });

                            if (res.success && res.status === 'queued') {
                                submittedCount++;
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    }

                    if (submittedCount > 0) {
                        this.$message.success(`已提交 ${submittedCount} 个${actionName}生成任务`);
                        this.taskDrawerVisible = true; // 打开面板看进度
                        this.fetchTasks(); // 刷新列表
                    } else {
                        this.$message.warning('任务提交失败');
                    }
                },

                // 提交元素
                async submitElement() {
                    if (!this.elementForm.name) {
                        this.$message.warning('请输入元素名称');
                        return;
                    }

                    let imageUrl = this.elementForm.image_url;

                    // 如果是选择角色，使用角色的图片
                    if (this.elementForm.type === 'character') {
                        const char = this.characterList.find(c => c.id === this.elementForm.character_id);
                        if (!char || !char.image_url) {
                            this.$message.warning('该角色没有设计图，请先生成或上传');
                            return;
                        }
                        imageUrl = char.image_url;
                    }

                    if (!imageUrl && this.elementForm.type !== 'character') {
                        this.$message.warning('请添加图片');
                        return;
                    } else if (!imageUrl) {
                         // Should not happen if the check above passes for 'character'
                         this.$message.warning('无法获取图片URL');
                         return;
                    }

                    const element = {
                        id: `element_${Date.now()}`,
                        name: this.elementForm.name,
                        image_url: imageUrl,
                        type: this.elementForm.type
                    };

                    if (!this.currentFusion.elements) {
                        this.$set(this.currentFusion, 'elements', []);
                    }
                    this.currentFusion.elements.push(element);

                    // 保存更新
                    await this.saveFusionData(this.currentFusion);

                    this.elementDialogVisible = false;
                    this.$message.success('元素添加成功');
                },
                // 1. 打开融图批量弹框
                openFusionBatchDialog(target) {
                    this.fusionBatchConfig = {
                        target: target, // 'prompt' 或 'image'
                        scope: 'all'    // 默认选全部
                    };
                    this.fusionBatchDialogVisible = true;
                },

                // 2. 获取缺失数量辅助函数（用于UI显示）
                getFusionMissingCount(target) {
                    if (!this.fusionList) return 0;
                    if (target === 'prompt') {
                        // 统计没有提示词的任务
                        return this.fusionList.filter(f => !f.fusion_prompt || !f.fusion_prompt.trim()).length;
                    } else if (target === 'image') {
                        // 统计没有结果图的任务
                        return this.fusionList.filter(f => !f.result_image).length;
                    }
                    return 0;
                },

                // 3. 开始执行融图批量生成
                async startFusionBatchGeneration() {
                    // 关闭弹框
                    this.fusionBatchDialogVisible = false;
                    
                    const { target, scope } = this.fusionBatchConfig;
                    
                    // 检查模型选择
                    if (target === 'end_image') {
                        if (!this.genOptions.fusionProviderId || !this.genOptions.fusionModelName) {
                            return this.$message.warning('请先在顶部选择图生图模型');
                        }
                    }
                    if (target === 'prompt') {
                        if (!this.genOptions.textProviderId || !this.genOptions.textModelName) {
                            return this.$message.warning('请先在顶部选择文本生成模型');
                        }
                    } else if (target === 'image') {
                        if (!this.genOptions.fusionProviderId || !this.genOptions.fusionModelName) {
                            return this.$message.warning('请先在顶部选择图生图模型');
                        }
                    } else if (target === 'video') {
                        // [新增] 检查视频模型
                        if (!this.genOptions.videoProviderId || !this.genOptions.videoModelName) {
                            return this.$message.warning('请先在顶部选择视频生成模型');
                        }
                    }

                    // --- 确定任务范围 ---
                    let tasks = [];
                    if (scope === 'all') {
                        tasks = [...this.fusionList];
                    } else if (scope === 'selected') {
                        tasks = [...this.multipleFusionSelection];
                    } else if (scope === 'missing') {
                        if (target === 'prompt') {
                            tasks = this.fusionList.filter(f => !f.fusion_prompt || !f.fusion_prompt.trim());
                        } else if (target === 'image') {
                            tasks = this.fusionList.filter(f => !f.result_image);
                        } else if (target === 'video') {
                            // [新增] 筛选缺失视频的任务
                            tasks = this.fusionList.filter(f => !f.video_url);
                        }
                    }

                    if (scope === 'missing') {
                        if (target === 'prompt') tasks = this.fusionList.filter(f => !f.fusion_prompt);
                        else if (target === 'image') tasks = this.fusionList.filter(f => !f.result_image);
                        else if (target === 'end_image') tasks = this.fusionList.filter(f => !f.end_frame_image); // 新增
                        else if (target === 'video') tasks = this.fusionList.filter(f => !f.video_url);
                    }

                    if (tasks.length === 0) {
                        this.$message.info("没有符合条件及范围的任务需要生成");
                        return;
                    }

                    // --- 开始批量处理 ---
                    const total = tasks.length;
                    let successCount = 0;
                    let failCount = 0;
                    //const actionName = target === 'prompt' ? '提示词' : '融合图';

                    if (target === 'prompt') {
                        this.batchGenerateFusionPrompts(tasks);
                    } else if (target === 'image') {
                        this.batchGenerateFusionImages(tasks, 'start'); // 稍微修改一下这个函数接受类型
                    } else if (target === 'end_image') {
                        this.batchGenerateFusionImages(tasks, 'end'); // 调用同一函数但传入类型
                    } else if (target === 'video') {
                        // [新增] 调用批量视频生成
                        this.batchGenerateFusionVideos(tasks);
                    }

                },
                async generateFusionVideo(row) {
                    if (!row.result_image) {
                        return this.$message.warning('请先生成融合图作为首帧');
                    }
                    if (!this.genOptions.videoProviderId) {
                        return this.$message.warning('请先选择视频生成模型');
                    }

                    try {
                        const res = await this.request('POST', '/api/async/generate/fusion_video', {
                            fusion_id: row.id,
                            project_id: this.currentProjectId,
                            provider_id: this.genOptions.videoProviderId,
                            model_name: this.genOptions.videoModelName
                        });

                        if (res.success && res.status === 'queued') {
                            this.$message.success('视频生成任务已提交，耗时较长请耐心等待');
                            this.taskDrawerVisible = true;
                            this.fetchTasks();
                        }
                    } catch (e) {
                        console.error(e);
                        this.$message.error('提交失败');
                    }
                },
                async batchGenerateFusionVideos(tasks) {
                    // 1. 预检查
                    const validTasks = tasks.filter(f => f.result_image);
                    if (validTasks.length === 0) {
                        this.$message.warning('选中的任务都没有首帧图片，无法生成视频');
                        return;
                    }

                    if (!this.genOptions.videoProviderId) {
                        this.$message.warning('请先选择视频生成模型');
                        return;
                    }

                    let submittedCount = 0;

                    for (const row of validTasks) {
                        if (!row.id) await this.saveFusionData(row);

                        try {
                            const res = await this.request('POST', '/api/async/generate/fusion_video', {
                                fusion_id: row.id,
                                project_id: this.currentProjectId,
                                provider_id: this.genOptions.videoProviderId,
                                model_name: this.genOptions.videoModelName
                            });

                            if (res.success && res.status === 'queued') {
                                submittedCount++;
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    }

                    if (submittedCount > 0) {
                        this.$message.success(`已提交 ${submittedCount} 个视频生成任务`);
                        this.taskDrawerVisible = true;
                        this.fetchTasks();
                    }
                },
                // 应用选中的版本
                async applyVersion(item) {
                    if (!this.currentHistoryCallback) return;

                    try {
                        // 调用回调函数，将选中的 URL 传回去进行保存
                        await this.currentHistoryCallback(item.url, this.currentHistoryEntity);
                        
                        // 更新当前比对 URL，实现 UI 即时反馈
                        this.currentHistoryComparingUrl = item.url;
                        
                        this.$message.success(`已切换至版本 v${item.version}`);
                        // 可选：this.historyDialogVisible = false; // 选完自动关闭，或者保留让用户继续看
                    } catch (e) {
                        console.error(e);
                        this.$message.error("切换版本失败");
                    }
                },

                // 打开全局历史
                async openGlobalHistory() {
                    if (!this.currentProjectId) return this.$message.warning("请先选择项目");
                    
                    this.globalHistoryVisible = true;
                    this.loadingHistory = true;
                    this.fullHistoryList = [];
                    
                    try {
                        const res = await this.request('GET', `/api/projects/${this.currentProjectId}/history`);
                        this.fullHistoryList = res;
                    } catch (e) {
                        console.error(e);
                        this.$message.error("获取历史记录失败");
                    } finally {
                        this.loadingHistory = false;
                    }
                },
                
                // 恢复/使用历史资源
                async restoreHistoryItem(item) {
                    const confirmText = `确定要将此版本 (v${item.version}) 应用到【${item.entity_name}】吗？`;
                    
                    await this.$confirm(confirmText, '确认恢复', { type: 'warning' });
                    
                    try {
                        let endpoint = '';
                        let payload = {};
                        
                        // 根据类型构造恢复请求
                        if (item.entity_type === 'character') {
                            endpoint = `/api/projects/${this.currentProjectId}/characters/${item.entity_id}`;
                            payload = { image_url: item.url };
                            
                            // 更新本地列表视图
                            const char = this.characterList.find(c => c.id === item.entity_id);
                            if (char) char.image_url = item.url;
                            
                        } else if (item.entity_type === 'shot') {
                            endpoint = `/api/projects/${this.currentProjectId}/shots/${item.entity_id}`;
                            payload = { scene_image: item.url }; // 假设恢复的是场景图
                            
                            const shot = this.shotList.find(s => s.id === item.entity_id);
                            if (shot) shot.scene_image = item.url;
                            
                        } else if (item.entity_type === 'fusion') {
                            endpoint = `/api/projects/${this.currentProjectId}/fusions/${item.entity_id}`;
                            // 融图比较复杂，需要判断是图片还是视频，是首帧还是尾帧
                            // 这里做一个简单的智能判断：
                            if (item.media_type === 'video') {
                                payload = { video_url: item.url };
                            } else {
                                // 如果是图片，默认为结果图(首帧)，除非你有更复杂的逻辑区分
                                payload = { result_image: item.url };
                            }
                            
                            const fusion = this.fusionList.find(f => f.id === item.entity_id);
                            if (fusion) {
                                if(item.media_type === 'video') fusion.video_url = item.url;
                                else fusion.result_image = item.url;
                            }
                        } else {
                            this.$message.warning("暂不支持自动恢复该类型资源，请手动下载后上传");
                            return;
                        }
                        
                        // 发送请求
                        if (endpoint) {
                            await this.request('PUT', endpoint, payload);
                            this.$message.success("恢复成功！");
                        }
                        
                    } catch (e) {
                        if (e !== 'cancel') {
                            console.error(e);
                            this.$message.error("恢复失败");
                        }
                    }
                },
                openVisualAnalysis() {
                    this.visualAnalysisVisible = true;
                    this.visualAnalysisImage = '';
                    this.visualAnalysisFile = null;
                    this.visualAnalysisResult = '';
                },

                // 2. 处理文件选择
                handleAnalysisFileChange(e) {
                    const file = e.target.files[0];
                    this.processAnalysisFile(file);
                    e.target.value = ''; // 重置 input 允许重复选同一文件
                },

                // 3. 处理拖拽上传
                handleAnalysisDrop(e) {
                    const file = e.dataTransfer.files[0];
                    this.processAnalysisFile(file);
                },

                // 4. 文件处理通用逻辑
                processAnalysisFile(file) {
                    if (!file) return;
                    if (file.type.indexOf('image/') !== 0) {
                        this.$message.error('请上传图片文件');
                        return;
                    }
                    this.visualAnalysisFile = file;
                    // 创建本地预览 URL
                    this.visualAnalysisImage = URL.createObjectURL(file);
                    this.visualAnalysisResult = ''; // 清空旧结果
                },

                // 5. 调用后端接口开始分析
                async startVisualAnalysis() {
                    if (!this.visualAnalysisFile) return;

                    const formData = new FormData();
                    formData.append('file', this.visualAnalysisFile);

                    this.analyzingVisual = true;
                    
                    // 使用全局 loading 遮罩体验更好，或者只用按钮 loading
                    // 这里使用按钮 loading，因为弹窗已经遮盖了主界面
                    try {
                        const res = await this.request('POST', '/api/generate/analyze_image', formData, {
                            headers: { 'Content-Type': 'multipart/form-data' }
                        });

                        if (res.success) {
                            this.visualAnalysisResult = res.style_description;
                            this.$message.success('分析完成！');
                        }
                    } catch (e) {
                        console.error(e);
                        this.$message.error('分析失败，请检查是否配置了阿里云 Key');
                    } finally {
                        this.analyzingVisual = false;
                    }
                },

                // 6. 复制结果到剪贴板
                copyAnalysisResult() {
                    if (!this.visualAnalysisResult) return;
                    navigator.clipboard.writeText(this.visualAnalysisResult).then(() => {
                        this.$message.success('已复制到剪贴板');
                    }).catch(() => {
                        this.$message.error('复制失败');
                    });
                },

                // ================== 新增：任务中心逻辑 ==================
                startTaskPoller() {
                    this.fetchTasks(); // 立即执行一次
                    // 每 3 秒轮询一次
                    this.taskPoller = setInterval(() => {
                        this.fetchTasks();
                    }, 3000);
                },
                async fetchTasks() {
                    try {
                        const res = await this.request('GET', '/api/tasks');
                        
                        // 1. 检测是否有任务“刚刚完成”
                        const justFinished = res.some(newTask => {
                            // 找到旧列表里的同一个任务
                            const oldTask = this.taskList.find(t => t.id === newTask.id);
                            // 如果旧状态不是 success，但新状态是 success，说明刚做完
                            return oldTask && oldTask.status !== 'success' && newTask.status === 'success';
                        });
                        
                        this.taskList = res;
                        
                        // 2. 如果有任务刚做完，立刻重新拉取当前页面的数据
                        if (justFinished) {
                            this.$notify({
                                title: '生成完成',
                                message: '部分后台任务已完成，数据已自动刷新',
                                type: 'success'
                            });

                            // === 关键：这里替代了以前的“后续处理代码” ===
                            // 因为后台已经把 url 写入数据库了，我们只需要重拉一遍数据，
                            // 界面上的图片就会自动显示出来。
                            if (this.activeTab === 'image-fusion') {
                                this.fetchFusions(); 
                            } else if (this.activeTab === 'scenes') {
                                this.fetchShots(this.currentProjectId);
                            } else if (this.activeTab === 'characters') {
                                this.fetchCharacters();
                            }
                        }
                    } catch(e) { console.warn(e); }
                },

                async clearTask(id) {
                    await this.request('DELETE', `/api/tasks/${id}`);
                    this.fetchTasks(); // 手动删除后立即刷新
                },

                getTaskTagType(status) {
                    const map = { success: 'success', failed: 'danger', processing: 'primary', pending: 'info' };
                    return map[status] || 'info';
                },

                getTaskStatusText(status) {
                    const map = { pending: '排队中', processing: '生成中', success: '完成', failed: '失败' };
                    return map[status] || status;
                },

                getTaskProgressStatus(status) {
                    if(status==='success') return 'success';
                    if(status==='failed') return 'exception';
                    return '';
                },
            }
        });
                </script>
    </body>
    
    </html>