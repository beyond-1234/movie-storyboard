<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电影分镜管理系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        /* ... (Keep styles same as before) ... */
        body { margin: 0; background-color: #f0f2f5; font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif; }
        .el-header { background-color: #304156; color: #fff; line-height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .app-title { font-size: 20px; font-weight: bold; }
        .main-container { width: 80%; max-width: none; margin: 0 auto; padding: 20px; }
        .project-card { margin-bottom: 20px; }
        .shot-card { min-height: 600px; }
        .image-preview-list { display: flex; gap: 10px; flex-wrap: wrap; }
        .image-item { width: 100px; height: 100px; border-radius: 4px; object-fit: cover; cursor: pointer; border: 1px solid #eee; }
        .shot-desc { color: #666; font-size: 13px; margin-top: 5px; line-height: 1.4; }
        .media-generated-box { text-align: center; border: 2px dashed #dcdfe6; padding: 20px; border-radius: 4px; margin-top: 10px; position: relative; }
        .video-preview { width: 100%; max-height: 200px; background: #000; }
        .el-tag { margin-right: 5px; }
        .dialog-footer { text-align: right; }
        .script-list-container { min-height: 200px; }
        .script-section-block { background: #fff; border-left: 4px solid #409EFF; padding: 15px; margin-bottom: 15px; border-radius: 0 4px 4px 0; box-shadow: 0 1px 4px rgba(0,0,0,0.05); position: relative; display: flex; gap: 10px; cursor: move; }
        .script-section-block:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .script-checkbox { margin-top: 5px; }
        .script-content-wrapper { flex: 1; }
        .script-toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; opacity: 0.6; transition: opacity 0.3s; }
        .script-section-block:hover .script-toolbar { opacity: 1; }
        .script-index { position: absolute; left: -25px; top: 0; color: #ccc; font-weight: bold; font-size: 12px; }
        .global-loading-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .loading-dialog-box { background: #fff; width: 360px; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: center; }
        .loading-spinner { font-size: 40px; color: #409EFF; margin-bottom: 20px; }
        .loading-text { font-size: 16px; color: #303133; margin-bottom: 10px; font-weight: bold; }
        .loading-subtext { font-size: 13px; color: #909399; margin-bottom: 30px; }
        .loading-actions { display: flex; justify-content: center; gap: 15px; }
        .settings-container { display: flex; height: 500px; border: 1px solid #eee; }
        .settings-sidebar { width: 220px; border-right: 1px solid #eee; background: #fafafa; padding: 10px; display: flex; flex-direction: column; }
        .settings-content { flex: 1; padding: 20px; overflow-y: auto; }
        .provider-item { padding: 10px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .provider-item:hover { background: #e6f7ff; }
        .provider-item.active { background: #e6f7ff; color: #1890ff; font-weight: bold; }
        .provider-item-icon { width: 20px; height: 20px; background: #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #fff; margin-right: 8px; }
        .model-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .frames-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .frame-box { background: #f9fafc; padding: 10px; border-radius: 4px; border: 1px solid #eee; }
        .frame-title { font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .frame-placeholder { width: 100%; height: 100px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px dashed #ccc; border-radius: 4px; color: #ccc; cursor: pointer; font-size: 12px; position: relative; }
        .frame-img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; cursor: pointer; display: block; }
        .frame-delete { position: absolute; top: 2px; right: 2px; color: red; cursor: pointer; background: rgba(255,255,255,0.8); border-radius: 50%; padding: 2px; }
        .video-play-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); color: #fff; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; z-index: 5; }
        .video-play-overlay:hover { background: rgba(0,0,0,0.8); transform: translate(-50%, -50%) scale(1.1); transition: all 0.2s; }
        .sortable-ghost { opacity: 0.5; background: #f0f9eb; }
        .config-row { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .config-label { width: 60px; font-size: 13px; color: #606266; font-weight: bold; }
        .config-selects { flex: 1; display: flex; gap: 10px; }
        .header-actions { float: right; display: flex; align-items: center; height: 100%; gap: 15px; }
        .character-views {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .character-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .view-item {
            display: flex;
            flex-direction: column;
        }

        .view-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        .view-image {
            position: relative;
            height: 400px; /* 增加高度以适应四视图布局 */
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #eee;
            background-color: #f9f9f9; /* 设置背景颜色 */
        }

        .view-image .el-image {
            width: 100%;
            height: 100%;
        }

        .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .view-image:hover .image-actions {
            opacity: 1;
        }

        .image-actions .el-button {
            color: #fff;
            padding: 0;
        }

        .view-placeholder {
            height: 400px;
            border: 1px dashed #dcdfe6;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #909399;
            background-color: #fafafa;
            transition: all 0.3s;
            padding: 20px;
        }

        .view-placeholder:hover {
            border-color: #409EFF;
            color: #409EFF;
            background-color: #f0f9ff;
        }

        .placeholder-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .placeholder-content i {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .placeholder-content div {
            font-size: 16px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .action-buttons .el-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 10px 15px;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Global Loading Mask -->
        <div v-if="globalLoading" class="global-loading-mask">
            <div class="loading-dialog-box">
                <div class="loading-spinner"><i class="el-icon-loading"></i></div>
                <div class="loading-text">{{ loadingTitle }}</div>
                <div class="loading-subtext">{{ loadingSubText }}</div>
                <div class="loading-actions">
                    <el-button type="danger" plain round size="medium" icon="el-icon-close" @click="cancelGeneration">放弃生成</el-button>
                    <el-button type="primary" round size="medium" icon="el-icon-loading" disabled>请耐心等待</el-button>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <el-container>
            <el-header>
                <div class="app-title"><i class="el-icon-film"></i> 电影分镜管理系统</div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <el-select v-model="currentProjectId" placeholder="选择项目" @change="handleProjectChange" size="small" style="width: 200px;">
                        <el-option v-for="item in projectList" :key="item.id" :label="item.film_name" :value="item.id"></el-option>
                    </el-select>
                    <el-button type="primary" size="small" icon="el-icon-plus" @click="openCreateProject">新建项目</el-button>
                    <el-button type="info" size="small" icon="el-icon-s-operation" @click="openSettings">模型管理</el-button>
                </div>
            </el-header>

            <el-main class="main-container">
                <!-- Project Info -->
                <el-card class="project-card" v-if="currentProject">
                    <div slot="header" class="clearfix" style="line-height: 32px;">
                        <span style="font-weight: bold; font-size: 18px;">{{ currentProject.film_name }}</span>
                        <el-tag size="small" type="success" style="margin-left: 10px">核心冲突: {{ currentProject.script_core_conflict || '无' }}</el-tag>
                        <div class="header-actions">
                            <el-button type="text" icon="el-icon-film" style="color: #E6A23C;" @click="exportJianyingDraft">导出剪映草稿</el-button>
                            <el-button type="text" icon="el-icon-edit" @click="openEditProject">编辑详情</el-button>
                            <el-button type="text" icon="el-icon-delete" style="color: #f56c6c;" @click="deleteProject">删除项目</el-button>
                        </div>
                    </div>
                    <el-descriptions :column="4" border size="small">
                        <el-descriptions-item label="基础信息" :span="4">{{ currentProject.basic_info }}</el-descriptions-item>
                        <el-descriptions-item label="情感关键词">{{ currentProject.script_emotional_keywords }}</el-descriptions-item>
                        <el-descriptions-item label="色彩体系">{{ currentProject.visual_color_system }}</el-descriptions-item>
                        <el-descriptions-item label="人物设定" :span="4">
                             <span v-if="currentProject.visual_consistency_prompt">{{ currentProject.visual_consistency_prompt }}</span>
                             <span v-else style="color:#ccc;font-style:italic;">未设置 (在编辑中添加以保证角色一致性)</span>
                        </el-descriptions-item>
                    </el-descriptions>
                </el-card>

                <div v-if="currentProject" style="background: #fff; border-radius: 4px; padding: 20px; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);">
                    <el-tabs v-model="activeTab" @tab-click="handleTabClick">
                        <!-- Script Tab (Enhanced with Text Model Config) -->
                        <el-tab-pane label="剧本创作" name="script">
                            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; background: #f5f7fa; padding: 10px; border-radius: 4px;">
                                <div style="display:flex; align-items:center; gap: 15px;">
                                    <div><el-checkbox v-model="allScriptsSelected" @change="toggleAllScripts">全选</el-checkbox><span style="margin-left: 10px; color: #666; font-size: 13px;">已选 {{ selectedScriptCount }} 项</span></div>
                                    <div style="border-left:1px solid #ddd; padding-left:15px; display:flex; align-items:center; gap:10px;">
                                        <span style="font-size:13px; color:#606266; font-weight:bold;">AI 模型:</span>
                                        <el-select v-model="genOptions.textProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateTextModelDefault">
                                            <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                        </el-select>
                                        <el-select v-model="genOptions.textModelName" size="mini" placeholder="模型" style="width: 150px;">
                                            <el-option v-for="m in availableTextModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                        </el-select>
                                    </div>
                                </div>
                                <div><el-button type="danger" size="small" icon="el-icon-delete" plain :disabled="selectedScriptCount === 0" @click="deleteSelectedScripts">批量删除</el-button><el-button type="danger" size="small" icon="el-icon-delete-solid" @click="deleteAllScripts">清空全部</el-button></div>
                            </div>

                            <div ref="scriptListRef" class="script-list-container">
                                <div v-for="(section, index) in scriptSections" :key="index" class="script-section-block">
                                    <div class="script-checkbox"><el-checkbox v-model="section._checked"></el-checkbox></div>
                                    <div class="script-content-wrapper">
                                        <div class="script-index">#{{ index + 1 }}</div>
                                        <el-input type="textarea" :autosize="{ minRows: 3, maxRows: 10}" placeholder="请输入剧本内容..." v-model="section.content" @change="saveScript"></el-input>
                                        <div class="script-toolbar">
                                            <i class="el-icon-rank" style="cursor: move; margin-right: 10px; margin-top: 5px;" title="拖拽排序"></i>
                                            <el-button size="mini" type="success" icon="el-icon-magic-stick" plain @click="generateScriptContinuation(index)">AI 续写</el-button>
                                            <el-button size="mini" type="primary" icon="el-icon-video-camera" plain @click="convertScriptToShot(section, index)">一键转分镜</el-button>
                                            <el-button size="mini" type="danger" icon="el-icon-delete" plain @click="removeScriptSection(index)">删除</el-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 20px;"><el-button type="primary" icon="el-icon-plus" style="width: 100%" @click="addScriptSection">添加新段落</el-button></div>
                        </el-tab-pane>

                        <el-tab-pane label="角色设定" name="characters">
                            <!-- 角色生成配置 -->
                            <div style="margin-bottom: 15px; background: #f5f7fa; padding: 10px; border-radius: 4px;">
                                <div style="display:flex; align-items:center; gap: 15px;">
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">图片生成模型:</span>
                                    <el-select v-model="genOptions.imageProviderId" size="mini" placeholder="供应商" style="width: 120px;"
                                        @change="updateImageModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.imageModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableImageModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>
                                    <p></p>
                                    <span style="font-size:13px; color:#606266; font-weight:bold;">角色列表生成的文本模型:</span>
                                    <el-select v-model="genOptions.textProviderId" size="mini" placeholder="供应商" style="width: 120px;" @change="updateTextModelDefault">
                                        <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                    </el-select>
                                    <el-select v-model="genOptions.textModelName" size="mini" placeholder="模型" style="width: 150px;">
                                        <el-option v-for="m in availableTextModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                    </el-select>

                                    <el-button type="primary" size="small" icon="el-icon-plus" @click="openCreateCharacter">创建角色</el-button>
                                    <el-button type="success" size="small" icon="el-icon-magic-stick" @click="generateCharactersFromPrompt">从人物设定生成</el-button>
                                </div>
                            </div>
                        
                            <!-- 角色列表 -->
                            <el-row :gutter="20">
                                <el-col :span="8" v-for="char in characterList" :key="char.id">
                                    <el-card class="character-card" style="margin-bottom: 20px; height: 100%;">
                                        <div slot="header" class="character-header">
                                            <span class="character-name">{{ char.name }}</span>
                                            <el-button class="delete-btn" type="text" icon="el-icon-delete"
                                                @click="deleteCharacter(char.id)"></el-button>
                                        </div>
                                        <!-- 将原来的多张图片显示改为单张图片显示 -->
                                        <div class="character-content">
                                            <div class="character-view">
                                                <div class="view-title">角色设计图（含正面特写与多视图）</div>
                                                <div class="view-image" v-if="char.image_url">
                                                    <el-image :src="char.image_url" :preview-src-list="[char.image_url]" fit="contain"></el-image>
                                                    <div class="image-actions">
                                                        <el-button type="text" size="mini" @click="uploadCharacterImage(char)">替换图片</el-button>
                                                        <el-button type="text" size="mini" @click="generateCharacterView(char)">重新生成</el-button>
                                                    </div>
                                                </div>
                                                <div class="view-placeholder" v-else>
                                                    <div class="placeholder-content">
                                                        <i class="el-icon-picture-outline"></i>
                                                        <div>暂无角色设计图</div>
                                                    </div>
                                                    <div class="action-buttons">
                                                        <el-button type="primary" size="small" @click="uploadCharacterImage(char)">
                                                            <i class="el-icon-upload2"></i>
                                                            上传角色设计图
                                                        </el-button>
                                                        <el-button type="success" size="small" @click="generateCharacterView(char)">
                                                            <i class="el-icon-magic-stick"></i>
                                                            AI生成角色设计图
                                                        </el-button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="character-desc">{{ char.description }}</div>
                                        </div>

                                    </el-card>
                                </el-col>
                            </el-row>
                        </el-tab-pane>

                        <!-- Shot Tab -->
                        <el-tab-pane label="分镜列表" name="shots">

                            <!-- 全局媒体生成配置【新增核心代码】 -->
                            <div class="media-config-panel">
                                <div style="margin-bottom: 10px; font-weight: bold;">全局媒体生成配置</div>
                                <div class="config-row">
                                    <div class="config-label">图片</div>
                                    <div class="config-selects">
                                        <el-select v-model="genOptions.imageProviderId" size="mini" placeholder="供应商" style="flex:1"
                                            @change="updateImageModelDefault">
                                            <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                        </el-select>
                                        <el-select v-model="genOptions.imageModelName" size="mini" placeholder="模型" style="flex:1">
                                            <el-option v-for="m in availableImageModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                        </el-select>
                                    </div>
                                </div>
                                <div class="config-row">
                                    <div class="config-label">视频</div>
                                    <div class="config-selects">
                                        <el-select v-model="genOptions.videoProviderId" size="mini" placeholder="供应商" style="flex:1"
                                            @change="updateVideoModelDefault">
                                            <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                        </el-select>
                                        <el-select v-model="genOptions.videoModelName" size="mini" placeholder="模型" style="flex:1">
                                            <el-option v-for="m in availableVideoModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                        </el-select>
                                    </div>
                                </div>
                                <div class="config-row" style="border-bottom:none;">
                                    <div class="config-label">语音</div>
                                    <div class="config-selects">
                                        <el-select v-model="genOptions.voiceProviderId" size="mini" placeholder="供应商" style="flex:1"
                                            @change="updateVoiceModelDefault">
                                            <el-option v-for="p in providers" :key="p.id" :label="p.name" :value="p.id"></el-option>
                                        </el-select>
                                        <el-select v-model="genOptions.voiceModelName" size="mini" placeholder="模型" style="flex:1">
                                            <el-option v-for="m in availableVoiceModels" :key="m.name" :label="m.name" :value="m.name"></el-option>
                                        </el-select>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div><span style="margin-right: 20px;">共 {{ shotList.length }} 个分镜</span><el-button type="danger" size="small" icon="el-icon-delete" plain :disabled="multipleShotSelection.length === 0" @click="deleteSelectedShots">批量删除</el-button><el-button type="danger" size="small" icon="el-icon-delete-solid" @click="deleteAllShots">清空全部</el-button></div>
                                <div>
                                    <el-button type="danger" size="small" icon="el-icon-sort"
                                        @click="openBatchDialog('sequential_frames')">批量顺序生成</el-button>
                                    <el-button type="warning" size="small" icon="el-icon-video-camera" @click="openBatchDialog('video')">批量生成视频</el-button>
                                    <el-button type="success" size="small" icon="el-icon-picture-outline"
                                        @click="openBatchDialog('start_frame')">批量生成首帧</el-button>
                                    <el-button type="success" size="small" icon="el-icon-picture" @click="openBatchDialog('end_frame')">批量生成尾帧</el-button>
                                    <el-button type="primary" size="small" icon="el-icon-plus" @click="openCreateShot"
                                        style="margin-left: 10px;">添加分镜</el-button>
                                </div>
                            </div>

                            <el-table :data="shotList" border stripe style="width: 100%" v-loading="loadingShots" @selection-change="handleShotSelectionChange" row-key="id" ref="shotTable">
                                <el-table-column width="40"><template slot-scope="scope"><i class="el-icon-rank" style="cursor: move; color: #909399;"></i></template></el-table-column>
                                <el-table-column type="selection" width="55"></el-table-column>
                                <el-table-column prop="scene" label="场次" width="60" align="center"></el-table-column>
                                <el-table-column prop="shot_number" label="镜号" width="60" align="center"></el-table-column>
                                <el-table-column label="画面预览" width="180" align="center">
                                    <template slot-scope="scope">
                                        <div style="display: flex; gap: 5px; justify-content: center;">
                                            <div v-if="scope.row.start_frame" style="text-align: center; position: relative;"><el-image style="width: 70px; height: 50px; border-radius: 4px" :src="scope.row.start_frame" :preview-src-list="[scope.row.start_frame]"></el-image><div style="font-size: 10px; color: #999;">首帧</div></div>
                                            <div v-if="scope.row.end_frame" style="text-align: center;"><el-image style="width: 70px; height: 50px; border-radius: 4px" :src="scope.row.end_frame" :preview-src-list="[scope.row.end_frame]"></el-image><div style="font-size: 10px; color: #999;">尾帧</div></div>
                                            <div v-if="!scope.row.start_frame && !scope.row.end_frame" style="color: #ccc; font-size: 12px; line-height: 50px;">暂无</div>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="视频预览" width="220" align="center">
                                    <template slot-scope="scope">
                                        <div v-if="scope.row.video_url" style="width: 100%; height: 100px; background: #000; display: flex; justify-content: center; align-items: center; border-radius: 4px; overflow: hidden;"><video :src="scope.row.video_url" controls style="max-width: 100%; max-height: 100%;"></video></div>
                                        <div v-else style="color: #ccc; font-size: 12px;">未生成</div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="分镜描述">
                                    <template slot-scope="scope">
                                        <div><strong>画面:</strong> {{ scope.row.visual_description }}</div>
                                        <div v-if="scope.row.dialogue" style="margin-top: 5px; color: #409EFF;"><i class="el-icon-microphone"></i> {{ scope.row.dialogue }}<i v-if="scope.row.audio_url" class="el-icon-video-play" style="cursor: pointer; margin-left: 5px; font-size: 14px;" @click="playAudio(scope.row.audio_url)"></i></div>
                                        <div style="margin-top: 5px; color: #666;"><strong>声音:</strong> {{ scope.row.audio_description }}</div>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="duration" label="时长" width="70" align="center"></el-table-column>
                                <el-table-column label="操作" width="260" fixed="right">
                                    <template slot-scope="scope">
                                        <el-tooltip content="编辑详情" placement="top"><el-button size="mini" icon="el-icon-edit" circle @click="editShot(scope.row)"></el-button></el-tooltip>
                                        <el-tooltip content="生成首帧" placement="top"><el-button size="mini" type="success" icon="el-icon-picture-outline" circle plain @click="quickGenerateImage(scope.row, 'start')"></el-button></el-tooltip>
                                        <el-tooltip content="生成尾帧" placement="top"><el-button size="mini" type="success" icon="el-icon-picture" circle plain @click="quickGenerateImage(scope.row, 'end')"></el-button></el-tooltip>
                                        <el-tooltip content="生成视频" placement="top"><el-button size="mini" type="warning" icon="el-icon-video-camera" circle plain @click="quickGenerateVideo(scope.row)" :disabled="!scope.row.start_frame"></el-button></el-tooltip>
                                        <el-tooltip content="删除" placement="top"><el-button size="mini" type="danger" icon="el-icon-delete" circle plain @click="deleteShot(scope.row)"></el-button></el-tooltip>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-tab-pane>
                    </el-tabs>
                </div>
                <el-empty v-if="!currentProject" description="请在左上角选择或创建一个电影项目"></el-empty>
            </el-main>
        </el-container>

        <el-dialog :visible.sync="videoPlayerVisible" width="60%" title="视频预览">
            <div style="text-align: center;"><video v-if="playerVideoUrl" :src="playerVideoUrl" controls autoplay style="width: 100%; max-height: 500px;"></video></div>
        </el-dialog>

        <!-- Batch Dialog -->
        <el-dialog title="批量生成设置" :visible.sync="batchDialogVisible" width="400px">
            <el-form label-position="top">
                <el-form-item label="生成类型">
                    <el-tag v-if="batchConfig.target === 'start_frame'">分镜首帧 (Start Frame)</el-tag>
                    <el-tag v-if="batchConfig.target === 'end_frame'" type="success">分镜尾帧 (End Frame)</el-tag>
                    <el-tag v-if="batchConfig.target === 'video'" type="warning">分镜视频 (Video)</el-tag>
                    <el-tag v-if="batchConfig.target === 'sequential_frames'" type="danger">顺序生成关键帧 (Sequential)</el-tag>
                </el-form-item>

                <!-- 顺序生成时显示特殊说明 -->
                <el-alert v-if="batchConfig.target === 'sequential_frames'" type="info" :closable="false" style="margin-bottom: 15px;">
                    <template slot="title">
                        <div style="font-size: 13px; line-height: 1.6;">
                            <strong>顺序生成模式:</strong><br>
                            1. 按分镜顺序依次生成首帧<br>
                            2. 使用上一个分镜的尾帧作为参考<br>
                            3. 生成完所有首帧后,再生成尾帧<br>
                            4. 保证画面连贯性和角色一致性
                        </div>
                    </template>
                </el-alert>

                <el-form-item label="选择生成范围">
                    <el-radio-group v-model="batchConfig.scope" style="display: flex; flex-direction: column; gap: 10px;">
                        <el-radio label="all">全部 {{ shotList.length }} 个分镜</el-radio>
                        <el-radio label="selected" :disabled="multipleShotSelection.length === 0">已选中的 {{ multipleShotSelection.length }} 个分镜 <span v-if="multipleShotSelection.length===0" style="color:#999;font-size:12px">(请先在列表中勾选)</span></el-radio>
                        <el-radio label="missing">仅针对未生成的 {{ getMissingCount(batchConfig.target) }} 个分镜 <span style="color:#999;font-size:12px">(跳过已存在的)</span></el-radio>
                    </el-radio-group>
                </el-form-item>

                <!-- 顺序生成固定使用全部分镜 -->
                <el-form-item label="生成范围" v-if="batchConfig.target === 'sequential_frames'">
                    <el-tag type="info">将处理全部 {{ shotList.length }} 个分镜(按顺序)</el-tag>
                </el-form-item>
            </el-form>
            <div slot="footer"><el-button icon="el-icon-close" @click="batchDialogVisible = false">取 消</el-button><el-button type="primary" icon="el-icon-video-play" @click="startBatchGeneration">开始生成</el-button></div>
        </el-dialog>

        <!-- Project Dialog -->
        <el-dialog :title="projectDialogTitle" :visible.sync="projectDialogVisible" width="60%">
            <el-form :model="projectForm" label-width="100px" ref="projectForm">
                <el-tabs v-model="activeProjectTab">
                    <el-tab-pane label="基础信息" name="basic">
                        <el-form-item label="项目名称" prop="film_name" required><el-input v-model="projectForm.film_name"></el-input></el-form-item>
                        <el-form-item label="核心冲突"><el-input type="textarea" v-model="projectForm.script_core_conflict" :rows="3"></el-input></el-form-item>
                        <el-form-item label="情感关键词"><el-input v-model="projectForm.script_emotional_keywords"></el-input></el-form-item>
                        <el-form-item label="基础信息" prop="basic_info"><el-input type="textarea" v-model="projectForm.basic_info" :rows="4" placeholder="包含时代背景、空间特质、人物小传等信息"></el-input></el-form-item>
                    </el-tab-pane>
                    <el-tab-pane label="视觉风格" name="visual">
                        <el-form-item label="人物设定" prop="visual_consistency_prompt"><el-input type="textarea" v-model="projectForm.visual_consistency_prompt" :rows="4" placeholder="例：男主角张三，35岁..."></el-input></el-form-item>
                        <el-form-item label="色彩体系"><el-input v-model="projectForm.visual_color_system"></el-input></el-form-item>
                    </el-tab-pane>
                </el-tabs>
            </el-form>
            <span slot="footer" class="dialog-footer"><el-button icon="el-icon-close" @click="projectDialogVisible = false">取 消</el-button><el-button type="primary" icon="el-icon-check" @click="submitProject">确 定</el-button></span>
        </el-dialog>

        <!-- Shot Dialog (Updated Icons) -->
        <el-dialog :title="shotForm.id ? '编辑分镜' : '新建分镜'" :visible.sync="shotDialogVisible" width="70%" top="5vh" :close-on-click-modal="false">
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <el-form :model="shotForm" label-width="80px" size="small">
                        <div style="display: flex; gap: 10px;">
                            <el-form-item label="场次" required style="flex:1"><el-input v-model="shotForm.scene"></el-input></el-form-item>
                            <el-form-item label="镜号" required style="flex:1"><el-input v-model="shotForm.shot_number"></el-input></el-form-item>
                            <el-form-item label="时长" style="flex:1"><el-input v-model="shotForm.duration"></el-input></el-form-item>
                        </div>
                        <el-form-item label="画面说明"><el-input type="textarea" :rows="3" v-model="shotForm.visual_description"></el-input></el-form-item>
                        <el-form-item label="台词">
                            <div style="display: flex; gap: 10px;">
                                <el-input type="textarea" :rows="2" v-model="shotForm.dialogue" placeholder="角色的对白内容..."></el-input>
                                <el-button type="primary" icon="el-icon-microphone" plain size="small" @click="handleGenVoice" :loading="generatingVoice">生成配音</el-button>
                            </div>
                            <div v-if="shotForm.audio_url" style="margin-top: 5px; background: #f0f9eb; padding: 5px; border-radius: 4px;"><audio :src="shotForm.audio_url" controls style="height: 30px; width: 100%;"></audio></div>
                        </el-form-item>
                        <el-form-item label="声音说明"><el-input type="textarea" :rows="2" v-model="shotForm.audio_description"></el-input></el-form-item>
                        <el-form-item label="特殊技术"><el-input v-model="shotForm.special_technique"></el-input></el-form-item>
                        <el-form-item label="备注"><el-input v-model="shotForm.notes"></el-input></el-form-item>
                        <el-form-item label="首帧提示词"><el-input type="textarea" v-model="shotForm.start_frame_prompt"></el-input></el-form-item>
                        <el-form-item label="尾帧提示词"><el-input type="textarea" v-model="shotForm.end_frame_prompt"></el-input></el-form-item>
                    </el-form>
                </div>
                <div style="flex: 1; border-left: 1px solid #eee; padding-left: 20px;">
                    <div style="margin-bottom: 20px; border-top: 1px dashed #eee; padding-top: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span style="font-weight: bold; font-size: 14px;">关键帧生成</span><el-button type="primary" size="mini" plain icon="el-icon-magic-stick" @click="handleGenAllImages">一键生成全部</el-button></div>
                        <div class="frames-grid">
                            <div class="frame-box">
                                <div class="frame-title">首帧 (Start) <el-button type="text" icon="el-icon-refresh" size="mini" @click="handleGenImage('start')">生成</el-button></div>
                                <div v-if="shotForm.start_frame" style="position:relative;"><img :src="shotForm.start_frame" class="frame-img" @click="previewImage(shotForm.start_frame)"><i class="el-icon-delete frame-delete" @click="shotForm.start_frame = ''"></i></div>
                                <div v-else class="frame-placeholder" @click="handleGenImage('start')"><i class="el-icon-picture-outline"></i></div>
                            </div>
                            <div class="frame-box">
                                <div class="frame-title">尾帧 (End) <el-button type="text" icon="el-icon-refresh" size="mini" @click="handleGenImage('end')">生成</el-button></div>
                                <div v-if="shotForm.end_frame" style="position:relative;"><img :src="shotForm.end_frame" class="frame-img" @click="previewImage(shotForm.end_frame)"><i class="el-icon-delete frame-delete" @click="shotForm.end_frame = ''"></i></div>
                                <div v-else class="frame-placeholder" @click="handleGenImage('end')"><i class="el-icon-picture-outline"></i></div>
                            </div>
                        </div>
                    </div>
                    <div style="position: relative;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>动态预览</span><el-button type="warning" size="mini" icon="el-icon-video-camera-solid" @click="handleGenVideo" :disabled="!shotForm.start_frame">生成视频</el-button></div>
                        <div v-if="videoUrl" class="media-generated-box"><video :src="videoUrl" controls class="video-preview"></video><div style="margin-top: 5px;"><a :href="videoUrl" target="_blank" download style="font-size: 12px;">下载视频</a></div></div>
                        <div v-else style="background: #f9fafc; height: 100px; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 12px;">{{ shotForm.start_frame ? '点击生成视频' : '请先生成首帧' }}</div>
                    </div>
                </div>
            </div>
            <span slot="footer" class="dialog-footer"><el-button icon="el-icon-close" @click="shotDialogVisible = false">取 消</el-button><el-button type="primary" icon="el-icon-check" @click="submitShot">保 存</el-button></span>
        </el-dialog>

        <!-- Settings Dialog (Updated with Text Model) -->
        <el-dialog title="模型供应商管理" :visible.sync="settingsVisible" width="800px">
            <div class="settings-container">
                <div class="settings-sidebar">
                    <div style="margin-bottom: 10px;">
                        <el-button type="primary" size="mini" icon="el-icon-plus" style="width: 100%" @click="initNewProvider">新增供应商</el-button>
                    </div>
                    <div v-for="p in providers" :key="p.id" class="provider-item" :class="{active: editingProvider && editingProvider.id === p.id}" @click="selectProvider(p)">
                        <div style="display:flex; align-items:center;">
                            <div class="provider-item-icon" :style="{background: getProviderColor(p.type)}">{{ p.name.charAt(0).toUpperCase() }}</div>
                            <span style="font-size: 13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width: 120px;">{{ p.name }}</span>
                        </div>
                        <i class="el-icon-arrow-right" style="font-size: 12px; color: #ccc;"></i>
                    </div>
                </div>
                <div class="settings-content" v-if="editingProvider">
                    <el-form label-position="top" size="small">
                        <el-form-item label="供应商名称"><el-input v-model="editingProvider.name"></el-input></el-form-item>
                        <el-row :gutter="20">
                            <el-col :span="12">
                                <el-form-item label="类型">
                                    <el-select v-model="editingProvider.type" style="width: 100%">
                                        <el-option label="Aliyun DashScope" value="aliyun"></el-option>
                                        <el-option label="SiliconFlow (OpenAI)" value="siliconflow"></el-option>
                                        <el-option label="RunningHub" value="runninghub"></el-option>
                                        <el-option label="VIDU Studio" value="vidu"></el-option>
                                        <el-option label="智谱" value="zai"></el-option>
                                        <el-option label="即梦 (Volcengine)" value="jimeng"></el-option>
                                        <el-option label="ComfyUI (Local)" value="comfyui"></el-option>
                                        <el-option label="Mock Service" value="mock"></el-option>
                                    </el-select>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12"><el-form-item label="启用状态"><el-switch v-model="editingProvider.enabled"></el-switch></el-form-item></el-col>
                        </el-row>
                        <el-form-item label="Base URL (可选)">
                            <el-input v-model="editingProvider.base_url" placeholder="https://api.vidu.com"></el-input>
                        </el-form-item>
                        <el-form-item label="API Key">
                            <el-input 
                                v-model="editingProvider.api_key" 
                                show-password 
                                :placeholder="editingProvider.type === 'jimeng' ? 'AccessKeyId|SecretKey (用竖线分隔)' : '输入 Key (若不修改请保持原样/空)'">
                            </el-input>
                            <div v-if="editingProvider.type === 'jimeng'" style="font-size: 12px; color: #909399; margin-top: 5px;">
                                <i class="el-icon-info"></i> 即梦需要填写格式: <code>AccessKeyId|SecretKey</code>
                                <br>示例: <code>AKTP1234567890|aGVsbG93b3JsZA==</code>
                            </div>
                        </el-form-item>
                        <div class="model-list-header"><span style="font-weight: bold;">模型列表</span><el-button type="text" icon="el-icon-plus" @click="addModelToProvider">添加</el-button></div>
                        <div v-if="editingProvider.models && editingProvider.models.length">
                            <div v-for="(m, idx) in editingProvider.models" :key="idx" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <el-input v-model="m.name" placeholder="模型名称 (如: vidu-1)" style="flex: 2"></el-input>
                                <el-input v-model="m.path" placeholder="Path (可选)" style="flex: 2"></el-input>
                                <el-select v-model="m.type" placeholder="类型" style="flex: 1">
                                    <el-option label="图片" value="image"></el-option>
                                    <el-option label="视频" value="video"></el-option>
                                    <el-option label="语音" value="audio"></el-option>
                                    <el-option label="文本" value="text"></el-option>
                                </el-select>
                                <el-button type="danger" icon="el-icon-delete" circle plain size="mini" @click="removeModelFromProvider(idx)"></el-button>
                            </div>
                        </div>
                        <div style="margin-top: 30px; text-align: right;">
                            <el-button type="danger" plain icon="el-icon-delete" @click="deleteCurrentProvider" v-if="editingProvider.id">删除</el-button>
                            <el-button type="primary" icon="el-icon-check" @click="saveCurrentProvider">保存</el-button>
                        </div>
                    </el-form>
                </div>
                <div v-else class="settings-content" style="display:flex;align-items:center;justify-content:center;color:#999;">请选择供应商</div>
            </div>
        </el-dialog>

        <!-- Character Dialog -->
        <el-dialog title="创建角色" :visible.sync="characterDialogVisible" width="500px">
            <el-form :model="characterForm" label-width="80px">
                <el-form-item label="角色名称" required>
                    <el-input v-model="characterForm.name" placeholder="请输入角色名称"></el-input>
                </el-form-item>
                <el-form-item label="角色描述">
                    <el-input type="textarea" v-model="characterForm.description" 
                        :rows="4" placeholder="请描述角色的外貌、性格、服装等特征"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="characterDialogVisible = false">取 消</el-button>
                <el-button type="primary" @click="submitCharacter">确 定</el-button>
            </div>
        </el-dialog>

    </div>

    <script src="https://unpkg.com/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        new Vue({
            el: '#app',
            data: {
                projectList: [], currentProjectId: '', currentProject: null, shotList: [], loadingShots: false,
                activeTab: 'script', scriptSections: [],
                allScriptsSelected: false, multipleShotSelection: [],
                globalLoading: false, loadingTitle: '', loadingSubText: '', currentAbortController: null, 
                settingsVisible: false, providers: [], editingProvider: null, 
                videoPlayerVisible: false, playerVideoUrl: '',
                genOptions: {
                    imageProviderId: '', imageModelName: '',
                    videoProviderId: '', videoModelName: '',
                    voiceProviderId: '', voiceModelName: '',
                    textProviderId: '', textModelName: '' // Added Text Model Config
                },
                projectDialogVisible: false, projectDialogTitle: '新建项目', activeProjectTab: 'basic', projectForm: {},
                shotDialogVisible: false, videoUrl: '', shotForm: { dialogue: '', audio_url: '' }, 
                generatingVoice: false, 
                previewVisible: false, previewUrl: '',
                scriptSortable: null, shotSortable: null,
                batchDialogVisible: false, batchConfig: { target: '', scope: 'all' },
                characterList: [],
                characterDialogVisible: false,
                characterForm: {
                    name: '',
                    description: ''
                }
            },
            computed: {
                getModelsByProviderId() {
                    return (id) => {
                        const p = this.providers.find(x => x.id === id);
                        return (p && p.models) ? p.models : [];
                    };
                },
                availableImageModels() { return this.getModelsByProviderId(this.genOptions.imageProviderId).filter(m => m.type === 'image'); },
                availableVideoModels() { return this.getModelsByProviderId(this.genOptions.videoProviderId).filter(m => m.type === 'video'); },
                availableVoiceModels() { return this.getModelsByProviderId(this.genOptions.voiceProviderId).filter(m => m.type === 'audio'); },
                availableTextModels() { return this.getModelsByProviderId(this.genOptions.textProviderId).filter(m => m.type === 'text'); },
                selectedScriptCount() { return this.scriptSections.filter(s => s._checked).length; },
                
                currentProviderImageModels() { return this.availableImageModels; },
                currentProviderVideoModels() { return this.availableVideoModels; },
                currentProviderAudioModels() { return this.availableVoiceModels; }
            },
            mounted() { this.fetchProjects(); this.fetchSettings(); },
            methods: {
                async request(method, url, data = null, config = {}) {
                    try { const res = await axios({ method, url, data, ...config }); return res.data; } 
                    catch (err) { if (!axios.isCancel(err)) this.$message.error(err.response?.data?.error || '操作失败'); throw err; }
                },
                startGlobalLoading(title, subtext) { this.globalLoading = true; this.loadingTitle = title; this.loadingSubText = subtext; this.currentAbortController = new AbortController(); },
                stopGlobalLoading() { this.globalLoading = false; this.currentAbortController = null; },
                cancelGeneration() { if (this.currentAbortController) this.currentAbortController.abort(); this.stopGlobalLoading(); },
                openBatchDialog(command) { 
                    this.batchConfig = { 
                        target: command, 
                        scope: command === 'sequential_frames' ? 'sequential' : 'all' 
                    }; 
                    this.batchDialogVisible = true; 
                },
                getMissingCount(target) {
                    if(!this.shotList) return 0;
                    if(target === 'start_frame') return this.shotList.filter(s => !s.start_frame).length;
                    if(target === 'end_frame') return this.shotList.filter(s => !s.end_frame).length;
                    if(target === 'video') return this.shotList.filter(s => !s.video_url).length;
                    if (target === 'sequential_frames') {
                        // 顺序生成模式：统计实际需要生成的帧数
                        // 每个分镜最多需要生成2帧（首帧+尾帧）
                        let count = 0;
                        this.shotList.forEach(s => {
                            if (!s.start_frame)  {
                                count++; // 缺首帧
                                return;
                            }
                            if (!s.end_frame) { 
                                count++;    // 缺尾帧
                                return;
                            }
                        });
                        return count;
                    }
                    return 0;
                },
                async startBatchGeneration() {
                    const { target, scope } = this.batchConfig;
                    this.batchDialogVisible = false;

                    if (target === 'sequential_frames') {
                        await this.sequentialGenerateFrames();
                        return;
                    }

                    let tasks = [];
                    if (scope === 'all') tasks = [...this.shotList];
                    else if (scope === 'selected') tasks = [...this.multipleShotSelection];
                    else if (scope === 'missing') {
                        if (target === 'start_frame') tasks = this.shotList.filter(s => !s.start_frame);
                        else if (target === 'end_frame') tasks = this.shotList.filter(s => !s.end_frame);
                        else if (target === 'video') tasks = this.shotList.filter(s => !s.video_url);
                    }
                    if (tasks.length === 0) { this.$message.info("没有符合条件的分镜需要生成"); return; }
                    const total = tasks.length; let successCount = 0; let failCount = 0;
                    this.startGlobalLoading(`正在批量生成 (${successCount}/${total})...`, `共 ${total} 个任务，请勿关闭页面`);
                    for (let i = 0; i < total; i++) {
                        const shot = tasks[i];
                        this.loadingTitle = `正在处理第 ${i + 1}/${total} 个...`;
                        try {
                            if (this.currentAbortController.signal.aborted) break;
                            if (target === 'start_frame' || target === 'end_frame') {
                                const type = target === 'start_frame' ? 'start' : 'end';
                                await this._internalGenerateImage(shot, type);
                            } else if (target === 'video') {
                                await this._internalGenerateVideo(shot);
                            }
                            successCount++;
                        } catch (e) { console.error(`Task failed for shot ${shot.shot_number}:`, e); failCount++; }
                    }
                    this.stopGlobalLoading();
                    this.$message({ type: failCount === 0 ? 'success' : 'warning', message: `批量任务完成！成功: ${successCount}, 失败: ${failCount}` });
                },
                async sequentialGenerateFrames() {
                    const shots = [...this.shotList]; // 按当前顺序
                    if (shots.length === 0) {
                        this.$message.info("没有分镜可以生成");
                        return;
                    }

                    const total = shots.length;
                    let successCount = 0;
                    let failCount = 0;

                    this.startGlobalLoading(
                        `顺序生成中... (0/${total * 2})`,
                        `按分镜顺序生成首尾帧`
                    );

                    try {
                        // === 第一阶段:按顺序生成所有首帧 ===
                        this.loadingSubText = '顺序生成,保证画面连贯...';

                        for (let i = 0; i < shots.length; i++) {
                            if (this.currentAbortController.signal.aborted) break;

                            const shot = shots[i];
                            const prevShot = i > 0 ? shots[i - 1] : null;

                            this.loadingTitle = `正在生成第 ${i + 1}/${total} 个分镜的首帧...`;

                            try {
                                // 如果已有首帧则跳过
                                if (shot.start_frame) {
                                    console.log(`Shot ${shot.shot_number} 首帧已存在,跳过`);
                                    successCount++;
                                }

                                await this._internalGenerateImageSequential(shot, 'start', prevShot);
                                successCount++;

                                // 短暂延迟,避免API限流
                                await new Promise(resolve => setTimeout(resolve, 500));

                            } catch (e) {
                                console.error(`首帧生成失败 shot ${shot.shot_number}:`, e);
                                failCount++;
                            }

                            this.loadingTitle = `正在生成第 ${i + 1}/${total} 个分镜的尾帧...`;

                            try {
                                // 如果已有尾帧则跳过
                                if (shot.end_frame) {
                                    console.log(`Shot ${shot.shot_number} 尾帧已存在,跳过`);
                                    successCount++;
                                    continue;
                                }

                                // 尾帧基于该分镜的首帧生成
                                await this._internalGenerateImageSequential(shot, 'end', null);
                                successCount++;

                                await new Promise(resolve => setTimeout(resolve, 500));

                            } catch (e) {
                                console.error(`尾帧生成失败 shot ${shot.shot_number}:`, e);
                                failCount++;
                            }
                        }

                    } finally {
                        this.stopGlobalLoading();
                        this.$message({
                            type: failCount === 0 ? 'success' : 'warning',
                            message: `顺序生成完成!成功: ${successCount}, 失败: ${failCount}`,
                            duration: 5000
                        });
                    }
                },
                async _internalGenerateImageSequential(shot, type, prevShot) {
                    const styleDesc = `${this.currentProject.worldview_background} ${this.currentProject.visual_color_system}`;

                    // 构建请求参数
                    const params = {
                        visual_description: shot.visual_description,
                        style_description: styleDesc,
                        consistency_text: this.currentProject.visual_consistency_prompt,
                        provider_id: this.genOptions.imageProviderId,
                        model_name: this.genOptions.imageModelName,
                        frame_type: type,
                        shot_id: shot.id,
                        project_id: this.currentProjectId
                    };

                    // 如果是生成首帧且有前一个分镜,使用前一个分镜的尾帧prompt作为参考
                    if (type === 'start' && prevShot && prevShot.end_frame_prompt) {
                        params.prev_shot_context = prevShot.end_frame_prompt;
                    }

                    const res = await this.request('POST', '/api/generate/image', params, {
                        signal: this.currentAbortController.signal
                    });

                    const isStart = type === 'start';
                    if (isStart) {
                        shot.start_frame = res.url;
                    } else {
                        shot.end_frame = res.url;
                    }

                    await this.request('PUT', `/api/projects/${this.currentProjectId}/shots/${shot.id}`, {
                        [isStart ? 'start_frame' : 'end_frame']: res.url
                    });
                },
                async _internalGenerateImage(row, type) {
                    const styleDesc = `${this.currentProject.worldview_background} ${this.currentProject.visual_color_system}`;
                    const res = await this.request('POST', '/api/generate/image', {
                        visual_description: row.visual_description,
                        style_description: styleDesc,
                        consistency_text: this.currentProject.visual_consistency_prompt,
                        provider_id: this.genOptions.imageProviderId, 
                        model_name: this.genOptions.imageModelName, 
                        frame_type: type,
                        shot_id: row.id, 
                        project_id: this.currentProjectId
                    }, { signal: this.currentAbortController.signal });
                    const isStart = type === 'start';
                    if(isStart) row.start_frame = res.url; else row.end_frame = res.url;
                    await this.request('PUT', `/api/projects/${this.currentProjectId}/shots/${row.id}`, { [isStart ? 'start_frame' : 'end_frame']: res.url });
                },

                async _internalGenerateVideo(row) {
                    if (!row.start_frame) throw new Error("缺少首帧");
                    const res = await this.request('POST', '/api/generate/video', {
                        visual_description: row.visual_description,
                        start_frame: row.start_frame,
                        end_frame: row.end_frame,
                        provider_id: this.genOptions.videoProviderId, 
                        model_name: this.genOptions.videoModelName 
                    }, { signal: this.currentAbortController.signal });
                    if (res.url) {
                        row.video_url = res.url;
                        await this.request('PUT', `/api/projects/${this.currentProjectId}/shots/${row.id}`, { video_url: res.url });
                    } else { throw new Error(res.error_msg || "生成失败"); }
                },

                toggleAllScripts(val) { this.scriptSections.forEach(s => this.$set(s, '_checked', val)); },
                deleteSelectedScripts() { this.$confirm('删除？').then(() => { this.scriptSections = this.scriptSections.filter(s => !s._checked); this.allScriptsSelected = false; this.saveScript(); }); },
                deleteAllScripts() { this.$confirm('清空？').then(() => { this.scriptSections = []; this.saveScript(); }); },
                handleShotSelectionChange(val) { this.multipleShotSelection = val; },
                async deleteSelectedShots() { this.$confirm('删除？').then(async () => { const ids = this.multipleShotSelection.map(s => s.id); await this.request('POST', `/api/projects/${this.currentProjectId}/shots/batch_delete`, { ids }); this.fetchShots(this.currentProjectId); }); },
                async deleteAllShots() { this.$confirm('清空？').then(async () => { const ids = this.shotList.map(s => s.id); if(ids.length) await this.request('POST', `/api/projects/${this.currentProjectId}/shots/batch_delete`, { ids }); this.fetchShots(this.currentProjectId); }); },

                handleTabClick(tab) { if (tab.name === 'script') this.fetchScript(); else if (tab.name === 'shots') this.fetchShots(this.currentProjectId); else if (tab.name === 'characters') this.fetchCharacters(); },
                initScriptSortable() {
                    const el = this.$refs.scriptListRef; if (!el || this.scriptSortable) return;
                    this.scriptSortable = Sortable.create(el, { animation: 150, handle: '.script-section-block', onEnd: (evt) => { const { oldIndex, newIndex } = evt; if (oldIndex === newIndex) return; const item = this.scriptSections.splice(oldIndex, 1)[0]; this.scriptSections.splice(newIndex, 0, item); this.saveScript(); } });
                },
                initShotSortable() {
                    const table = this.$refs.shotTable; if (!table) return; const el = table.$el.querySelector('.el-table__body-wrapper tbody'); if (!el || this.shotSortable) return;
                    this.shotSortable = Sortable.create(el, { animation: 150, handle: '.el-icon-rank', onEnd: async (evt) => { const { oldIndex, newIndex } = evt; if (oldIndex === newIndex) return; const item = this.shotList.splice(oldIndex, 1)[0]; this.shotList.splice(newIndex, 0, item); const orderedIds = this.shotList.map(s => s.id); await this.request('POST', `/api/projects/${this.currentProjectId}/shots/reorder`, { shot_ids: orderedIds }); } });
                },
                async fetchScript() { if (!this.currentProjectId) return; try { const res = await this.request('GET', `/api/projects/${this.currentProjectId}/script`); this.scriptSections = res.length ? res : [{ content: '' }]; this.$nextTick(() => this.initScriptSortable()); } catch (e) {} },
                async saveScript() { if (!this.currentProjectId) return; const cleanData = this.scriptSections.map(({_checked, ...rest}) => rest); await this.request('POST', `/api/projects/${this.currentProjectId}/script`, cleanData); },
                addScriptSection() { this.scriptSections.push({ content: '' }); this.saveScript(); },
                removeScriptSection(idx) { this.$confirm('删除？').then(() => { this.scriptSections.splice(idx, 1); this.saveScript(); }); },
                
                async generateScriptContinuation(index) {
                    this.startGlobalLoading('AI 续写中...', '请稍候');
                    try {
                        const ctx = this.scriptSections.slice(Math.max(0, index - 2), index + 1).map(s => s.content).join('\n');
                        const pid = this.genOptions.textProviderId;
                        const model = this.genOptions.textModelName;
                        if (!pid || !model) { throw new Error("请先在顶部选择文本模型"); }
                        
                        const res = await this.request('POST', '/api/generate/script_continuation', { context_text: ctx, project_info: this.currentProject, provider_id: pid, model_name: model }, { signal: this.currentAbortController.signal });
                        this.scriptSections.splice(index + 1, 0, { content: res.content }); this.saveScript();
                    } catch (e) { if (e.message !== '已取消') console.error(e); } finally { this.stopGlobalLoading(); }
                },
                async convertScriptToShot(section, index) {
                    this.startGlobalLoading('剧本转分镜...', '正在分析');
                    try {
                        const pid = this.genOptions.textProviderId;
                        const model = this.genOptions.textModelName;
                        if (!pid || !model) { throw new Error("请先在顶部选择文本模型"); }

                        const res = await this.request('POST', '/api/generate/analyze_script', { content: section.content, provider_id: pid, model_name: model }, { signal: this.currentAbortController.signal });
                        if(res.shots) { for(let s of res.shots) await this.request('POST', `/api/projects/${this.currentProjectId}/shots`, { ...s, movie_id: this.currentProjectId }); this.$message.success(`生成 ${res.shots.length} 个分镜`); }
                    } catch(e) { if (e.message !== '已取消') console.error(e); } finally { this.stopGlobalLoading(); }
                },

                async handleGenImage(type) {
                    if (!this.shotForm.visual_description) return this.$message.warning('请先填写画面说明');
                    const isStart = type === 'start';
                    this.startGlobalLoading(`正在生成${type}...`, 'AI 绘图通常需要 10-30 秒');
                    try {
                        const style = `${this.currentProject.worldview_background} ${this.currentProject.visual_color_system}`;
                        const res = await this.request('POST', '/api/generate/image', { 
                            visual_description: this.shotForm.visual_description, style_description: style, 
                            consistency_text: this.currentProject.visual_consistency_prompt,
                            provider_id: this.genOptions.imageProviderId, model_name: this.genOptions.imageModelName, 
                            frame_type: type, shot_id: this.shotForm.id, project_id: this.currentProjectId 
                        }, { signal: this.currentAbortController.signal });
                        if(type==='start') this.shotForm.start_frame=res.url; else this.shotForm.end_frame=res.url;
                    } catch(e) { if (e.message !== '已取消') console.error(e); } finally { this.stopGlobalLoading(); }
                },
                async handleGenAllImages() {
                    if (!this.shotForm.visual_description) return this.$message.warning('请先填写画面说明');
                    this.startGlobalLoading('批量生成...', '请稍候');
                    try {
                        const style = `${this.currentProject.worldview_background} ${this.currentProject.visual_color_system}`;
                        const base = { 
                            visual_description: this.shotForm.visual_description, style_description: style, 
                            consistency_text: this.currentProject.visual_consistency_prompt,
                            provider_id: this.genOptions.imageProviderId, model_name: this.genOptions.imageModelName, 
                            shot_id: this.shotForm.id, project_id: this.currentProjectId 
                        };
                        const [r1, r2] = await Promise.all([this.request('POST','/api/generate/image',{...base, frame_type:'start'},{signal:this.currentAbortController.signal}), this.request('POST','/api/generate/image',{...base, frame_type:'end'},{signal:this.currentAbortController.signal})]);
                        this.shotForm.start_frame=r1.url; this.shotForm.end_frame=r2.url;
                    } catch(e) { if (e.message !== '已取消') console.error(e); } finally { this.stopGlobalLoading(); }
                },
                async quickGenerateImage(row, type) {
                    if(!row.visual_description) return this.$message.warning('无画面说明，无法生成');
                    this.startGlobalLoading('正在快速生成预览图...', '请稍候');
                    try { await this._internalGenerateImage(row, type); this.$message.success((type==='start'?'首帧':'尾帧') + '生成成功'); } catch (e) { if (e.message !== '已取消') console.error(e); } finally { this.stopGlobalLoading(); }
                },
                async handleGenVideo() {
                    this.startGlobalLoading('生成视频...', '这可能需要几分钟');
                    try {
                        const res = await this.request('POST', '/api/generate/video', { visual_description: this.shotForm.visual_description, start_frame: this.shotForm.start_frame, end_frame: this.shotForm.end_frame, provider_id: this.genOptions.videoProviderId, model_name: this.genOptions.videoModelName }, { signal: this.currentAbortController.signal });
                        if(res.url) { this.videoUrl = res.url; this.shotForm.video_url = res.url; }
                    } catch(e) { if (e.message !== '已取消') console.error(e); } finally { this.stopGlobalLoading(); }
                },
                async quickGenerateVideo(row) {
                    if (!row.start_frame) return this.$message.warning('请先生成首帧作为参考');
                    this.startGlobalLoading('生成视频...', '请耐心等待');
                    try { await this._internalGenerateVideo(row); this.$message.success('视频生成完毕'); } catch(e) { if (e.message !== '已取消') console.error(e); } finally { this.stopGlobalLoading(); }
                },
                
                // 导出剪映
                async exportJianyingDraft() {
                    this.startGlobalLoading('导出剪映草稿...', '正在组装媒体资源');
                    try {
                        const res = await this.request('POST', `/api/projects/${this.currentProjectId}/export/jianying`);
                        if (res.success) {
                            this.$alert(`导出成功！<br>草稿路径：<b>${res.path}</b>`, '导出完成', {
                                dangerouslyUseHTMLString: true,
                                confirmButtonText: '确定'
                            });
                        }
                    } catch (e) {
                        if (e.message !== '已取消') console.error(e);
                    } finally {
                        this.stopGlobalLoading();
                    }
                },
                
                async handleGenVoice() {
                    if (!this.shotForm.dialogue) return this.$message.warning('请先填写台词');
                    this.generatingVoice = true;
                    try {
                        const res = await this.request('POST', '/api/generate/voiceover', {
                            text: this.shotForm.dialogue,
                            provider_id: this.genOptions.voiceProviderId,
                            model_name: this.genOptions.voiceModelName 
                        }, { signal: this.currentAbortController ? this.currentAbortController.signal : null });
                        
                        if (res.url) {
                            this.shotForm.audio_url = res.url;
                            this.$message.success('配音生成成功');
                        }
                    } catch (e) { console.error(e); } finally { this.generatingVoice = false; }
                },
                playAudio(url) { const audio = new Audio(url); audio.play().catch(e => this.$message.error('播放失败: ' + e.message)); },
                playVideo(row) { this.playerVideoUrl = row.video_url; this.videoPlayerVisible = true; },

                getProviderColor(type) {
                    if(type==='aliyun') return '#FF6A00';
                    if(type==='siliconflow') return '#7B68EE';
                    if(type==='vidu') return '#FF1493';
                    if(type==='zai') return '#5683EE';
                    if(type==='jimeng') return '#FF4500';
                    if(type==='comfyui') return '#3CB371';
                    return '#909399';
                },
                async fetchSettings() { try { const list = await this.request('GET', '/api/settings'); this.providers = list; if(list.length) { this.initDefaultSelections(); } } catch(e){} },
                openSettings() { this.fetchSettings(); this.settingsVisible = true; if(this.providers.length) this.selectProvider(this.providers[0]); else this.initNewProvider(); },
                selectProvider(p) { this.editingProvider = JSON.parse(JSON.stringify(p)); },
                initNewProvider() { 
                    this.editingProvider = { 
                        id: '', 
                        name: 'New Provider', 
                        type: 'aliyun', 
                        base_url: '', 
                        api_key: '', 
                        enabled: true, 
                        models: [ ] 
                    }; 
                },
                addModelToProvider() { if(!this.editingProvider.models) this.$set(this.editingProvider, 'models', []); this.editingProvider.models.push({ name: '', type: 'image', path: '' }); },
                removeModelFromProvider(idx) { this.editingProvider.models.splice(idx, 1); },
                
                async saveCurrentProvider() {
                    if(!this.editingProvider.name) return this.$message.warning("名称必填");
                    try {
                        const res = await this.request('POST', '/api/settings/provider', this.editingProvider);
                        if(res.success) { 
                            this.$message.success("保存成功"); 
                            this.fetchSettings(); 
                            if(!this.editingProvider.id && res.id) { this.editingProvider.id = res.id; } 
                        } else {
                            this.$message.error("保存失败");
                        }
                    } catch(e) {
                         // request wrapper already shows error, but we can add extra logic here
                    }
                },
                
                async deleteCurrentProvider() { if(!this.editingProvider.id) return; await this.request('DELETE', `/api/settings/provider/${this.editingProvider.id}`); this.fetchSettings(); this.editingProvider=null; },
                
                // Initialize default selections when providers load
                initDefaultSelections() {
                    const findP = (t) => { for(const p of this.providers) if(p.models && p.models.some(m => m.type === t)) return p.id; return this.providers[0]?.id || ''; };
                    if(!this.genOptions.imageProviderId) this.genOptions.imageProviderId = findP('image');
                    if(!this.genOptions.videoProviderId) this.genOptions.videoProviderId = findP('video');
                    if(!this.genOptions.voiceProviderId) this.genOptions.voiceProviderId = findP('audio');
                    if(!this.genOptions.textProviderId) this.genOptions.textProviderId = findP('text');
                    
                    this.updateImageModelDefault();
                    this.updateVideoModelDefault();
                    this.updateVoiceModelDefault();
                    this.updateTextModelDefault();
                },
                
                updateImageModelDefault() { const m = this.availableImageModels; if(m.length) this.genOptions.imageModelName = m[0].name; else this.genOptions.imageModelName = ''; },
                updateVideoModelDefault() { const m = this.availableVideoModels; if(m.length) this.genOptions.videoModelName = m[0].name; else this.genOptions.videoModelName = ''; },
                updateVoiceModelDefault() { const m = this.availableVoiceModels; if(m.length) this.genOptions.voiceModelName = m[0].name; else this.genOptions.voiceModelName = ''; },
                updateTextModelDefault() { const m = this.availableTextModels; if(m.length) this.genOptions.textModelName = m[0].name; else this.genOptions.textModelName = ''; },
                
                handleProviderChange() { this.initDefaultSelections(); },

                async fetchProjects() { const list = await this.request('GET', '/api/projects'); this.projectList = list; if(list.length && !this.currentProjectId) { this.currentProjectId = list[0].id; this.handleProjectChange(list[0].id); } },
                async handleProjectChange(pid) { this.currentProject = this.projectList.find(p => p.id === pid); this.activeTab='script'; this.fetchScript(); },
                openCreateProject() { 
    this.projectForm = { 
        film_name: '',
        script_core_conflict: '',
        script_emotional_keywords: '',
        basic_info: '',
        visual_color_system: '',
        visual_consistency_prompt: ''
    }; 
    this.projectDialogVisible = true; 
},
                openEditProject() { this.projectForm = JSON.parse(JSON.stringify(this.currentProject)); this.projectDialogVisible = true; },
                async submitProject() { if(!this.projectForm.film_name) return; const method = this.projectForm.id ? 'PUT' : 'POST'; const url = this.projectForm.id ? `/api/projects/${this.projectForm.id}` : '/api/projects'; const res = await this.request(method, url, this.projectForm); if(!this.projectForm.id) { this.projectList.unshift(res); this.currentProjectId=res.id; this.handleProjectChange(res.id); } else { const idx = this.projectList.findIndex(p=>p.id===res.id); this.$set(this.projectList, idx, res); this.currentProject=res; } this.projectDialogVisible = false; },
                async deleteProject() { await this.request('DELETE', `/api/projects/${this.currentProjectId}`); this.currentProject=null; this.currentProjectId=''; this.fetchProjects(); },
                
                async fetchShots(pid) { 
                    if(!pid) return; 
                    this.loadingShots = true; 
                    try { 
                        this.shotList = await this.request('GET', `/api/projects/${pid}/shots`);
                        this.$nextTick(() => this.initShotSortable()); 
                    } finally { this.loadingShots = false; } 
                },
                openCreateShot() { this.shotForm = { movie_id: this.currentProjectId, images: [], start_frame: '', end_frame: '', video_url: '', dialogue: '', audio_url: '' }; this.videoUrl=''; this.shotDialogVisible = true; },
                editShot(row) { this.shotForm = JSON.parse(JSON.stringify(row)); this.videoUrl=row.video_url||''; this.shotDialogVisible = true; },
                async submitShot() { if(!this.shotForm.shot_number) return; if(this.videoUrl) this.shotForm.video_url = this.videoUrl; const method = this.shotForm.id ? 'PUT' : 'POST'; const url = this.shotForm.id ? `/api/projects/${this.currentProjectId}/shots/${this.shotForm.id}` : `/api/projects/${this.currentProjectId}/shots`; await this.request(method, url, this.shotForm); this.fetchShots(this.currentProjectId); this.shotDialogVisible = false; },
                async deleteShot(row) { await this.request('DELETE', `/api/projects/${this.currentProjectId}/shots/${row.id}`); this.fetchShots(this.currentProjectId); },
                removeImage() {}, previewImage(url) { this.previewUrl = url; this.previewVisible = true; },
                async fetchCharacters() {
                    if (!this.currentProjectId) return;
                    try {
                        this.characterList = await this.request('GET', `/api/projects/${this.currentProjectId}/characters`);
                    } catch (e) {
                        console.error(e);
                    }
                },

                openCreateCharacter() {
                    this.characterForm = {
                        name: '',
                        description: ''
                    };
                    this.characterDialogVisible = true;
                },

                async submitCharacter() {
                    if (!this.characterForm.name) {
                        this.$message.warning('请输入角色名称');
                        return;
                    }
                    try {
                        const res = await this.request('POST', `/api/projects/${this.currentProjectId}/characters`, this.characterForm);
                        this.characterList.push(res);
                        this.characterDialogVisible = false;
                        this.$message.success('角色创建成功');
                    } catch (e) {
                        console.error(e);
                    }
                },

                async generateCharacterView(character) {
                    this.startGlobalLoading('生成角色设计图...', '请稍候');
                    try {
                        const res = await this.request('POST', '/api/generate/character_views', {
                            character_description: character.description,
                            project_id: this.currentProjectId,
                            provider_id: this.genOptions.imageProviderId,
                            model_name: this.genOptions.imageModelName
                        });

                        if (res.success) {
                            const charIndex = this.characterList.findIndex(c => c.id === character.id);
                            if (charIndex !== -1) {
                                this.$set(this.characterList[charIndex], 'image_url', res.url);
                                await this.request('PUT', `/api/projects/${this.currentProjectId}/characters/${character.id}`, {
                                    image_url: res.url
                                });
                            }
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        this.stopGlobalLoading();
                    }
                },

                getViewTitle(type) {
                    const titles = {
                        'portrait': '肖像',
                        'front_view': '正面',
                        'side_view': '侧面',
                        'back_view': '背面'
                    };
                    return titles[type] || type;
                },

                async deleteCharacter(id) {
                    try {
                        await this.$confirm('确定删除该角色？');
                        await this.request('DELETE', `/api/projects/${this.currentProjectId}/characters/${id}`);
                        this.characterList = this.characterList.filter(c => c.id !== id);
                        this.$message.success('删除成功');
                    } catch (e) {
                        if (e !== 'cancel') console.error(e);
                    }
                },

                // 根据人物设定字段生成角色列表
                async generateCharactersFromPrompt() {
                    if (!this.currentProject || !this.currentProject.visual_consistency_prompt) {
                        this.$message.warning('请先在项目设置中填写人物设定');
                        return;
                    }
                    
                    if (!this.genOptions.textProviderId || !this.genOptions.textModelName) {
                        this.$message.warning('请先选择文本模型');
                        return;
                    }
                    
                    this.startGlobalLoading('生成角色列表...', '请稍候');
                    try {
                        const res = await this.request('POST', '/api/generate/character_list', {
                            visual_consistency_prompt: this.currentProject.visual_consistency_prompt,
                            provider_id: this.genOptions.textProviderId,
                            model_name: this.genOptions.textModelName
                        });
                        
                        if (res.success && res.characters) {
                            for (const char of res.characters) {
                                const charData = await this.request('POST', `/api/projects/${this.currentProjectId}/characters`, char);
                                this.characterList.push(charData);
                            }
                            this.$message.success(`成功生成 ${res.characters.length} 个角色`);
                        } else {
                            this.$message.error('生成角色列表失败');
                        }
                    } catch (e) {
                        console.error(e);
                        this.$message.error('生成角色列表失败');
                    } finally {
                        this.stopGlobalLoading();
                    }
                },

                // 图片上传前检查
                beforeImageUpload(file) {
                    const isImage = file.type.indexOf('image/') === 0;
                    const isLt5M = file.size / 1024 / 1024 < 5;
                    
                    if (!isImage) {
                        this.$message.error('只能上传图片文件!');
                        return false;
                    }
                    if (!isLt5M) {
                        this.$message.error('图片大小不能超过 5MB!');
                        return false;
                    }
                    return true;
                },

                // 图片上传成功处理
                async handleImageUploadSuccess(res, character) {
                    if (res.success) {
                        const charIndex = this.characterList.findIndex(c => c.id === character.id);
                        if (charIndex !== -1) {
                            this.$set(this.characterList[charIndex], 'image_url', res.url);
                            await this.request('PUT', `/api/projects/${this.currentProjectId}/characters/${character.id}`, {
                                image_url: res.url
                            });
                            this.$message.success('图片上传成功');
                        }
                    } else {
                        this.$message.error(res.error || '图片上传失败');
                    }
                },

                // 替换角色图片
                uploadCharacterImage(character) {
                    // 创建一个隐藏的文件输入元素
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        if (!this.beforeImageUpload(file)) return;
                        
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('character_id', character.id);
                        
                        try {
                            this.startGlobalLoading('上传图片...', '请稍候');
                            const res = await this.request('POST', '/api/upload/character_image', formData, {
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                }
                            });
                            
                            await this.handleImageUploadSuccess(res, character);
                        } catch (e) {
                            console.error(e);
                            this.$message.error('图片上传失败');
                        } finally {
                            this.stopGlobalLoading();
                        }
                    };
                    input.click();
                }
            }
        });
                </script>
    </body>
    
    </html>